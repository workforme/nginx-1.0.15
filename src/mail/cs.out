cscope 15 $HOME/nginx-1.0.15/src/mail -q 0000000809 0000184299
	@ngx_mail.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

14 *
ngx_ma_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

15 
ngx_št_t
 
ngx_ma_add_pÜts
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
,

16 
ngx_ma_li¡’_t
 *
li¡’
);

17 *
ngx_ma_İtimize_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
);

18 
ngx_št_t
 
ngx_ma_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_ma_pÜt_t
 *
mpÜt
,

19 
ngx_ma_cÚf_addr_t
 *
addr
);

20 #ià(
NGX_HAVE_INET6
)

21 
ngx_št_t
 
ngx_ma_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_ma_pÜt_t
 *
mpÜt
,

22 
ngx_ma_cÚf_addr_t
 *
addr
);

24 
ngx_št_t
 
ngx_ma_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
);

27 
ngx_ušt_t
 
	gngx_ma_max_moduË
;

30 
ngx_commªd_t
 
	gngx_ma_commªds
[] = {

32 { 
ngx_¡ršg
("mail"),

33 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

34 
ngx_ma_block
,

37 
NULL
 },

39 { 
ngx_¡ršg
("imap"),

40 
NGX_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

41 
ngx_ma_block
,

44 
NULL
 },

46 
ngx_nuÎ_commªd


50 
ngx_cÜe_moduË_t
 
	gngx_ma_moduË_ùx
 = {

51 
ngx_¡ršg
("mail"),

52 
NULL
,

53 
NULL


57 
ngx_moduË_t
 
	gngx_ma_moduË
 = {

58 
NGX_MODULE_V1
,

59 &
ngx_ma_moduË_ùx
,

60 
ngx_ma_commªds
,

61 
NGX_CORE_MODULE
,

62 
NULL
,

63 
NULL
,

64 
NULL
,

65 
NULL
,

66 
NULL
,

67 
NULL
,

68 
NULL
,

69 
NGX_MODULE_V1_PADDING


74 
	$ngx_ma_block
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

76 *
rv
;

77 
ngx_ušt_t
 
i
, 
m
, 
mi
, 
s
;

78 
ngx_cÚf_t
 
pcf
;

79 
ngx_¬¿y_t
 
pÜts
;

80 
ngx_ma_li¡’_t
 *
li¡’
;

81 
ngx_ma_moduË_t
 *
moduË
;

82 
ngx_ma_cÚf_ùx_t
 *
ùx
;

83 
ngx_ma_cÜe_¤v_cÚf_t
 **
cscå
;

84 
ngx_ma_cÜe_maš_cÚf_t
 *
cmcf
;

86 ià(
cmd
->
Çme
.
d©a
[0] == 'i') {

87 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

94 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_cÚf_ùx_t
));

95 ià(
ùx
 =ğ
NULL
) {

96  
NGX_CONF_ERROR
;

99 *(
ngx_ma_cÚf_ùx_t
 **è
cÚf
 = 
ùx
;

103 
ngx_ma_max_moduË
 = 0;

104 
m
 = 0; 
ngx_moduËs
[m]; m++) {

105 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

109 
ngx_moduËs
[
m
]->
ùx_šdex
 = 
ngx_ma_max_moduË
++;

115 
ùx
->
maš_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
,

116 (*è* 
ngx_ma_max_moduË
);

117 ià(
ùx
->
maš_cÚf
 =ğ
NULL
) {

118  
NGX_CONF_ERROR
;

127 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (*è* 
ngx_ma_max_moduË
);

128 ià(
ùx
->
¤v_cÚf
 =ğ
NULL
) {

129  
NGX_CONF_ERROR
;

138 
m
 = 0; 
ngx_moduËs
[m]; m++) {

139 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

143 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

144 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

146 ià(
moduË
->
ü—‹_maš_cÚf
) {

147 
ùx
->
maš_cÚf
[
mi
] = 
moduË
->
	`ü—‹_maš_cÚf
(
cf
);

148 ià(
ùx
->
maš_cÚf
[
mi
] =ğ
NULL
) {

149  
NGX_CONF_ERROR
;

153 ià(
moduË
->
ü—‹_¤v_cÚf
) {

154 
ùx
->
¤v_cÚf
[
mi
] = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

155 ià(
ùx
->
¤v_cÚf
[
mi
] =ğ
NULL
) {

156  
NGX_CONF_ERROR
;

164 
pcf
 = *
cf
;

165 
cf
->
ùx
 = ctx;

167 
cf
->
moduË_ty³
 = 
NGX_MAIL_MODULE
;

168 
cf
->
cmd_ty³
 = 
NGX_MAIL_MAIN_CONF
;

169 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

171 ià(
rv
 !ğ
NGX_CONF_OK
) {

172 *
cf
 = 
pcf
;

173  
rv
;

179 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_ma_cÜe_moduË
.
ùx_šdex
];

180 
cscå
 = 
cmcf
->
£rv”s
.
–ts
;

182 
m
 = 0; 
ngx_moduËs
[m]; m++) {

183 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

187 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

188 
mi
 = 
ngx_moduËs
[
m
]->
ùx_šdex
;

192 
cf
->
ùx
 = ctx;

194 ià(
moduË
->
š™_maš_cÚf
) {

195 
rv
 = 
moduË
->
	`š™_maš_cÚf
(
cf
, 
ùx
->
maš_cÚf
[
mi
]);

196 ià(
rv
 !ğ
NGX_CONF_OK
) {

197 *
cf
 = 
pcf
;

198  
rv
;

202 
s
 = 0; s < 
cmcf
->
£rv”s
.
ÃÉs
; s++) {

206 
cf
->
ùx
 = 
cscå
[
s
]->ctx;

208 ià(
moduË
->
m”ge_¤v_cÚf
) {

209 
rv
 = 
moduË
->
	`m”ge_¤v_cÚf
(
cf
,

210 
ùx
->
¤v_cÚf
[
mi
],

211 
cscå
[
s
]->
ùx
->
¤v_cÚf
[
mi
]);

212 ià(
rv
 !ğ
NGX_CONF_OK
) {

213 *
cf
 = 
pcf
;

214  
rv
;

220 *
cf
 = 
pcf
;

223 ià(
	`ngx_¬¿y_š™
(&
pÜts
, 
cf
->
‹mp_poŞ
, 4, (
ngx_ma_cÚf_pÜt_t
))

224 !ğ
NGX_OK
)

226  
NGX_CONF_ERROR
;

229 
li¡’
 = 
cmcf
->li¡’.
–ts
;

231 
i
 = 0; i < 
cmcf
->
li¡’
.
ÃÉs
; i++) {

232 ià(
	`ngx_ma_add_pÜts
(
cf
, &
pÜts
, &
li¡’
[
i
]è!ğ
NGX_OK
) {

233  
NGX_CONF_ERROR
;

237  
	`ngx_ma_İtimize_£rv”s
(
cf
, &
pÜts
);

238 
	}
}

241 
ngx_št_t


242 
	$ngx_ma_add_pÜts
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
,

243 
ngx_ma_li¡’_t
 *
li¡’
)

245 
š_pÜt_t
 
p
;

246 
ngx_ušt_t
 
i
;

247 
sockaddr
 *
§
;

248 
sockaddr_š
 *
sš
;

249 
ngx_ma_cÚf_pÜt_t
 *
pÜt
;

250 
ngx_ma_cÚf_addr_t
 *
addr
;

251 #ià(
NGX_HAVE_INET6
)

252 
sockaddr_š6
 *
sš6
;

255 
§
 = (
sockaddr
 *è&
li¡’
->sockaddr;

257 
§
->
§_çmy
) {

259 #ià(
NGX_HAVE_INET6
)

260 
AF_INET6
:

261 
sš6
 = (
sockaddr_š6
 *è
§
;

262 
p
 = 
sš6
->
sš6_pÜt
;

267 
sš
 = (
sockaddr_š
 *è
§
;

268 
p
 = 
sš
->
sš_pÜt
;

272 
pÜt
 = 
pÜts
->
–ts
;

273 
i
 = 0; i < 
pÜts
->
ÃÉs
; i++) {

274 ià(
p
 =ğ
pÜt
[
i
].pÜˆ&& 
§
->
§_çmy
 =ğpÜt[i].
çmy
) {

278 
pÜt
 = &pÜt[
i
];

279 
found
;

285 
pÜt
 = 
	`ngx_¬¿y_push
(
pÜts
);

286 ià(
pÜt
 =ğ
NULL
) {

287  
NGX_ERROR
;

290 
pÜt
->
çmy
 = 
§
->
§_çmy
;

291 
pÜt
->pÜˆğ
p
;

293 ià(
	`ngx_¬¿y_š™
(&
pÜt
->
addrs
, 
cf
->
‹mp_poŞ
, 2,

294 (
ngx_ma_cÚf_addr_t
))

295 !ğ
NGX_OK
)

297  
NGX_ERROR
;

300 
found
:

302 
addr
 = 
	`ngx_¬¿y_push
(&
pÜt
->
addrs
);

303 ià(
addr
 =ğ
NULL
) {

304  
NGX_ERROR
;

307 
addr
->
sockaddr
 = (sockadd¸*è&
li¡’
->sockaddr;

308 
addr
->
sockËn
 = 
li¡’
->socklen;

309 
addr
->
ùx
 = 
li¡’
->ctx;

310 
addr
->
bšd
 = 
li¡’
->bind;

311 
addr
->
wdÿrd
 = 
li¡’
->wildcard;

312 #ià(
NGX_MAIL_SSL
)

313 
addr
->
s¦
 = 
li¡’
->ssl;

315 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

316 
addr
->
v6Úly
 = 
li¡’
->ipv6only;

319  
NGX_OK
;

320 
	}
}

324 
	$ngx_ma_İtimize_£rv”s
(
ngx_cÚf_t
 *
cf
, 
ngx_¬¿y_t
 *
pÜts
)

326 
ngx_ušt_t
 
i
, 
p
, 
Ï¡
, 
bšd_wdÿrd
;

327 
ngx_li¡’šg_t
 *
ls
;

328 
ngx_ma_pÜt_t
 *
mpÜt
;

329 
ngx_ma_cÚf_pÜt_t
 *
pÜt
;

330 
ngx_ma_cÚf_addr_t
 *
addr
;

332 
pÜt
 = 
pÜts
->
–ts
;

333 
p
 = 0;… < 
pÜts
->
ÃÉs
;…++) {

335 
	`ngx_sÜt
(
pÜt
[
p
].
addrs
.
–ts
, (
size_t
èpÜt[p].addrs.
ÃÉs
,

336 (
ngx_ma_cÚf_addr_t
), 
ngx_ma_cmp_cÚf_addrs
);

338 
addr
 = 
pÜt
[
p
].
addrs
.
–ts
;

339 
Ï¡
 = 
pÜt
[
p
].
addrs
.
ÃÉs
;

346 ià(
addr
[
Ï¡
 - 1].
wdÿrd
) {

347 
addr
[
Ï¡
 - 1].
bšd
 = 1;

348 
bšd_wdÿrd
 = 1;

351 
bšd_wdÿrd
 = 0;

354 
i
 = 0;

356 
i
 < 
Ï¡
) {

358 ià(
bšd_wdÿrd
 && !
addr
[
i
].
bšd
) {

359 
i
++;

363 
ls
 = 
	`ngx_ü—‹_li¡’šg
(
cf
, 
addr
[
i
].
sockaddr
,‡ddr[i].
sockËn
);

364 ià(
ls
 =ğ
NULL
) {

365  
NGX_CONF_ERROR
;

368 
ls
->
addr_Áİ
 = 1;

369 
ls
->
hªdËr
 = 
ngx_ma_š™_cÚÃùiÚ
;

370 
ls
->
poŞ_size
 = 256;

373 
ls
->
logp
 = &
cf
->
cyşe
->
Ãw_log
;

374 
ls
->
log
.
d©a
 = &ls->
addr_‹xt
;

375 
ls
->
log
.
hªdËr
 = 
ngx_acû±_log_”rÜ
;

377 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

378 
ls
->
v6Úly
 = 
addr
[
i
].ipv6only;

381 
mpÜt
 = 
	`ngx_·Îoc
(
cf
->
poŞ
, (
ngx_ma_pÜt_t
));

382 ià(
mpÜt
 =ğ
NULL
) {

383  
NGX_CONF_ERROR
;

386 
ls
->
£rv”s
 = 
mpÜt
;

388 ià(
i
 =ğ
Ï¡
 - 1) {

389 
mpÜt
->
Çddrs
 = 
Ï¡
;

392 
mpÜt
->
Çddrs
 = 1;

393 
i
 = 0;

396 
ls
->
sockaddr
->
§_çmy
) {

397 #ià(
NGX_HAVE_INET6
)

398 
AF_INET6
:

399 ià(
	`ngx_ma_add_addrs6
(
cf
, 
mpÜt
, 
addr
è!ğ
NGX_OK
) {

400  
NGX_CONF_ERROR
;

405 ià(
	`ngx_ma_add_addrs
(
cf
, 
mpÜt
, 
addr
è!ğ
NGX_OK
) {

406  
NGX_CONF_ERROR
;

411 
addr
++;

412 
Ï¡
--;

416  
NGX_CONF_OK
;

417 
	}
}

420 
ngx_št_t


421 
	$ngx_ma_add_addrs
(
ngx_cÚf_t
 *
cf
, 
ngx_ma_pÜt_t
 *
mpÜt
,

422 
ngx_ma_cÚf_addr_t
 *
addr
)

424 
u_ch¬
 *
p
;

425 
size_t
 
Ën
;

426 
ngx_ušt_t
 
i
;

427 
ngx_ma_š_addr_t
 *
addrs
;

428 
sockaddr_š
 *
sš
;

429 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

431 
mpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
,

432 
mpÜt
->
Çddrs
 * (
ngx_ma_š_addr_t
));

433 ià(
mpÜt
->
addrs
 =ğ
NULL
) {

434  
NGX_ERROR
;

437 
addrs
 = 
mpÜt
->addrs;

439 
i
 = 0; i < 
mpÜt
->
Çddrs
; i++) {

441 
sš
 = (
sockaddr_š
 *è
addr
[
i
].
sockaddr
;

442 
addrs
[
i
].
addr
 = 
sš
->
sš_addr
.
s_addr
;

444 
addrs
[
i
].
cÚf
.
ùx
 = 
addr
[i].ctx;

445 #ià(
NGX_MAIL_SSL
)

446 
addrs
[
i
].
cÚf
.
s¦
 = 
addr
[i].ssl;

449 
Ën
 = 
	`ngx_sock_Áİ
(
addr
[
i
].
sockaddr
, 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

451 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
Ën
);

452 ià(
p
 =ğ
NULL
) {

453  
NGX_ERROR
;

456 
	`ngx_memıy
(
p
, 
buf
, 
Ën
);

458 
addrs
[
i
].
cÚf
.
addr_‹xt
.
Ën
 =†en;

459 
addrs
[
i
].
cÚf
.
addr_‹xt
.
d©a
 = 
p
;

462  
NGX_OK
;

463 
	}
}

466 #ià(
NGX_HAVE_INET6
)

468 
ngx_št_t


469 
	$ngx_ma_add_addrs6
(
ngx_cÚf_t
 *
cf
, 
ngx_ma_pÜt_t
 *
mpÜt
,

470 
ngx_ma_cÚf_addr_t
 *
addr
)

472 
u_ch¬
 *
p
;

473 
size_t
 
Ën
;

474 
ngx_ušt_t
 
i
;

475 
ngx_ma_š6_addr_t
 *
addrs6
;

476 
sockaddr_š6
 *
sš6
;

477 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

479 
mpÜt
->
addrs
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
,

480 
mpÜt
->
Çddrs
 * (
ngx_ma_š6_addr_t
));

481 ià(
mpÜt
->
addrs
 =ğ
NULL
) {

482  
NGX_ERROR
;

485 
addrs6
 = 
mpÜt
->
addrs
;

487 
i
 = 0; i < 
mpÜt
->
Çddrs
; i++) {

489 
sš6
 = (
sockaddr_š6
 *è
addr
[
i
].
sockaddr
;

490 
addrs6
[
i
].
addr6
 = 
sš6
->
sš6_addr
;

492 
addrs6
[
i
].
cÚf
.
ùx
 = 
addr
[i].ctx;

493 #ià(
NGX_MAIL_SSL
)

494 
addrs6
[
i
].
cÚf
.
s¦
 = 
addr
[i].ssl;

497 
Ën
 = 
	`ngx_sock_Áİ
(
addr
[
i
].
sockaddr
, 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

499 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
Ën
);

500 ià(
p
 =ğ
NULL
) {

501  
NGX_ERROR
;

504 
	`ngx_memıy
(
p
, 
buf
, 
Ën
);

506 
addrs6
[
i
].
cÚf
.
addr_‹xt
.
Ën
 =†en;

507 
addrs6
[
i
].
cÚf
.
addr_‹xt
.
d©a
 = 
p
;

510  
NGX_OK
;

511 
	}
}

516 
ngx_št_t


517 
	$ngx_ma_cmp_cÚf_addrs
(cÚ¡ *
Úe
, cÚ¡ *
two
)

519 
ngx_ma_cÚf_addr_t
 *
fœ¡
, *
£cÚd
;

521 
fœ¡
 = (
ngx_ma_cÚf_addr_t
 *è
Úe
;

522 
£cÚd
 = (
ngx_ma_cÚf_addr_t
 *è
two
;

524 ià(
fœ¡
->
wdÿrd
) {

529 ià(
fœ¡
->
bšd
 && !
£cÚd
->bind) {

534 ià(!
fœ¡
->
bšd
 && 
£cÚd
->bind) {

542 
	}
}

	@ngx_mail.h

8 #iâdeà
_NGX_MAIL_H_INCLUDED_


9 
	#_NGX_MAIL_H_INCLUDED_


	)

12 
	~<ngx_cÚfig.h
>

13 
	~<ngx_cÜe.h
>

14 
	~<ngx_ev’t.h
>

15 
	~<ngx_ev’t_cÚÃù.h
>

17 #ià(
NGX_MAIL_SSL
)

18 
	~<ngx_ma_s¦_moduË.h
>

24 **
	mmaš_cÚf
;

25 **
	m¤v_cÚf
;

26 } 
	tngx_ma_cÚf_ùx_t
;

30 
u_ch¬
 
	msockaddr
[
NGX_SOCKADDRLEN
];

31 
sockËn_t
 
	msockËn
;

34 
ngx_ma_cÚf_ùx_t
 *
	mùx
;

36 
	mbšd
:1;

37 
	mwdÿrd
:1;

38 #ià(
NGX_MAIL_SSL
)

39 
	ms¦
:1;

41 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

42 
	mv6Úly
:2;

44 } 
	tngx_ma_li¡’_t
;

48 
ngx_ma_cÚf_ùx_t
 *
	mùx
;

49 
ngx_¡r_t
 
	maddr_‹xt
;

50 #ià(
NGX_MAIL_SSL
)

51 
ngx_ušt_t
 
	ms¦
;

53 } 
	tngx_ma_addr_cÚf_t
;

56 
š_addr_t
 
	maddr
;

57 
ngx_ma_addr_cÚf_t
 
	mcÚf
;

58 } 
	tngx_ma_š_addr_t
;

61 #ià(
NGX_HAVE_INET6
)

64 
š6_addr
 
	maddr6
;

65 
ngx_ma_addr_cÚf_t
 
	mcÚf
;

66 } 
	tngx_ma_š6_addr_t
;

73 *
	maddrs
;

74 
ngx_ušt_t
 
	mÇddrs
;

75 } 
	tngx_ma_pÜt_t
;

79 
	mçmy
;

80 
š_pÜt_t
 
	mpÜt
;

81 
ngx_¬¿y_t
 
	maddrs
;

82 } 
	tngx_ma_cÚf_pÜt_t
;

86 
sockaddr
 *
	msockaddr
;

87 
sockËn_t
 
	msockËn
;

89 
ngx_ma_cÚf_ùx_t
 *
	mùx
;

91 
	mbšd
:1;

92 
	mwdÿrd
:1;

93 #ià(
NGX_MAIL_SSL
)

94 
	ms¦
:1;

96 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

97 
	mv6Úly
:2;

99 } 
	tngx_ma_cÚf_addr_t
;

103 
ngx_¬¿y_t
 
	m£rv”s
;

104 
ngx_¬¿y_t
 
	mli¡’
;

105 } 
	tngx_ma_cÜe_maš_cÚf_t
;

108 
	#NGX_MAIL_POP3_PROTOCOL
 0

	)

109 
	#NGX_MAIL_IMAP_PROTOCOL
 1

	)

110 
	#NGX_MAIL_SMTP_PROTOCOL
 2

	)

113 
ngx_ma_´ÙocŞ_s
 
	tngx_ma_´ÙocŞ_t
;

117 
ngx_ma_´ÙocŞ_t
 *
	m´ÙocŞ
;

119 
ngx_m£c_t
 
	mtimeout
;

120 
ngx_m£c_t
 
	m»sŞv”_timeout
;

122 
ngx_æag_t
 
	mso_k“·live
;

124 
ngx_¡r_t
 
	m£rv”_Çme
;

126 
u_ch¬
 *
	mfe_Çme
;

127 
ngx_št_t
 
	mlše
;

129 
ngx_»sŞv”_t
 *
	m»sŞv”
;

132 
ngx_ma_cÚf_ùx_t
 *
	mùx
;

133 } 
	tngx_ma_cÜe_¤v_cÚf_t
;

137 
	mngx_pİ3_¡¬t
 = 0,

138 
	mngx_pİ3_u£r
,

139 
	mngx_pİ3_·sswd
,

140 
	mngx_pİ3_auth_logš_u£ºame
,

141 
	mngx_pİ3_auth_logš_·sswÜd
,

142 
	mngx_pİ3_auth_¶aš
,

143 
	mngx_pİ3_auth_üam_md5


144 } 
	tngx_pİ3_¡©e_e
;

148 
	mngx_im­_¡¬t
 = 0,

149 
	mngx_im­_auth_logš_u£ºame
,

150 
	mngx_im­_auth_logš_·sswÜd
,

151 
	mngx_im­_auth_¶aš
,

152 
	mngx_im­_auth_üam_md5
,

153 
	mngx_im­_logš
,

154 
	mngx_im­_u£r
,

155 
	mngx_im­_·sswd


156 } 
	tngx_im­_¡©e_e
;

160 
	mngx_sm_¡¬t
 = 0,

161 
	mngx_sm_auth_logš_u£ºame
,

162 
	mngx_sm_auth_logš_·sswÜd
,

163 
	mngx_sm_auth_¶aš
,

164 
	mngx_sm_auth_üam_md5
,

165 
	mngx_sm_h–o
,

166 
	mngx_sm_h–o_xş›Á
,

167 
	mngx_sm_h–o_äom
,

168 
	mngx_sm_xş›Á
,

169 
	mngx_sm_xş›Á_äom
,

170 
	mngx_sm_xş›Á_h–o
,

171 
	mngx_sm_äom
,

172 
	mngx_sm_to


173 } 
	tngx_sm_¡©e_e
;

177 
ngx_³”_cÚÃùiÚ_t
 
	mup¡»am
;

178 
ngx_buf_t
 *
	mbufãr
;

179 } 
	tngx_ma_´oxy_ùx_t
;

183 
ušt32_t
 
	msigÇtu»
;

185 
ngx_cÚÃùiÚ_t
 *
	mcÚÃùiÚ
;

187 
ngx_¡r_t
 
	mout
;

188 
ngx_buf_t
 *
	mbufãr
;

190 **
	mùx
;

191 **
	mmaš_cÚf
;

192 **
	m¤v_cÚf
;

194 
ngx_»sŞv”_ùx_t
 *
	m»sŞv”_ùx
;

196 
ngx_ma_´oxy_ùx_t
 *
	m´oxy
;

198 
ngx_ušt_t
 
	mma_¡©e
;

200 
	m´ÙocŞ
:3;

201 
	mblocked
:1;

202 
	mqu™
:1;

203 
	mquÙed
:1;

204 
	mback¦ash
:1;

205 
	mno_sync_l™”®
:1;

206 
	m¡¬‰ls
:1;

207 
	mesm
:1;

208 
	mauth_m‘hod
:3;

209 
	mauth_wa™
:1;

211 
ngx_¡r_t
 
	mlogš
;

212 
ngx_¡r_t
 
	m·sswd
;

214 
ngx_¡r_t
 
	m§É
;

215 
ngx_¡r_t
 
	mg
;

216 
ngx_¡r_t
 
	mgged_lše
;

217 
ngx_¡r_t
 
	m‹xt
;

219 
ngx_¡r_t
 *
	maddr_‹xt
;

220 
ngx_¡r_t
 
	mho¡
;

221 
ngx_¡r_t
 
	msm_h–o
;

222 
ngx_¡r_t
 
	msm_äom
;

223 
ngx_¡r_t
 
	msm_to
;

225 
ngx_ušt_t
 
	mcommªd
;

226 
ngx_¬¿y_t
 
	m¬gs
;

228 
ngx_ušt_t
 
	mlogš_©‹m±
;

232 
ngx_ušt_t
 
	m¡©e
;

233 
u_ch¬
 *
	mcmd_¡¬t
;

234 
u_ch¬
 *
	m¬g_¡¬t
;

235 
u_ch¬
 *
	m¬g_’d
;

236 
ngx_ušt_t
 
	ml™”®_Ën
;

237 } 
	tngx_ma_£ssiÚ_t
;

241 
ngx_¡r_t
 *
	mş›Á
;

242 
ngx_ma_£ssiÚ_t
 *
	m£ssiÚ
;

243 } 
	tngx_ma_log_ùx_t
;

246 
	#NGX_POP3_USER
 1

	)

247 
	#NGX_POP3_PASS
 2

	)

248 
	#NGX_POP3_CAPA
 3

	)

249 
	#NGX_POP3_QUIT
 4

	)

250 
	#NGX_POP3_NOOP
 5

	)

251 
	#NGX_POP3_STLS
 6

	)

252 
	#NGX_POP3_APOP
 7

	)

253 
	#NGX_POP3_AUTH
 8

	)

254 
	#NGX_POP3_STAT
 9

	)

255 
	#NGX_POP3_LIST
 10

	)

256 
	#NGX_POP3_RETR
 11

	)

257 
	#NGX_POP3_DELE
 12

	)

258 
	#NGX_POP3_RSET
 13

	)

259 
	#NGX_POP3_TOP
 14

	)

260 
	#NGX_POP3_UIDL
 15

	)

263 
	#NGX_IMAP_LOGIN
 1

	)

264 
	#NGX_IMAP_LOGOUT
 2

	)

265 
	#NGX_IMAP_CAPABILITY
 3

	)

266 
	#NGX_IMAP_NOOP
 4

	)

267 
	#NGX_IMAP_STARTTLS
 5

	)

269 
	#NGX_IMAP_NEXT
 6

	)

271 
	#NGX_IMAP_AUTHENTICATE
 7

	)

274 
	#NGX_SMTP_HELO
 1

	)

275 
	#NGX_SMTP_EHLO
 2

	)

276 
	#NGX_SMTP_AUTH
 3

	)

277 
	#NGX_SMTP_QUIT
 4

	)

278 
	#NGX_SMTP_NOOP
 5

	)

279 
	#NGX_SMTP_MAIL
 6

	)

280 
	#NGX_SMTP_RSET
 7

	)

281 
	#NGX_SMTP_RCPT
 8

	)

282 
	#NGX_SMTP_DATA
 9

	)

283 
	#NGX_SMTP_VRFY
 10

	)

284 
	#NGX_SMTP_EXPN
 11

	)

285 
	#NGX_SMTP_HELP
 12

	)

286 
	#NGX_SMTP_STARTTLS
 13

	)

289 
	#NGX_MAIL_AUTH_PLAIN
 0

	)

290 
	#NGX_MAIL_AUTH_LOGIN
 1

	)

291 
	#NGX_MAIL_AUTH_LOGIN_USERNAME
 2

	)

292 
	#NGX_MAIL_AUTH_APOP
 3

	)

293 
	#NGX_MAIL_AUTH_CRAM_MD5
 4

	)

294 
	#NGX_MAIL_AUTH_NONE
 5

	)

297 
	#NGX_MAIL_AUTH_PLAIN_ENABLED
 0x0002

	)

298 
	#NGX_MAIL_AUTH_LOGIN_ENABLED
 0x0004

	)

299 
	#NGX_MAIL_AUTH_APOP_ENABLED
 0x0008

	)

300 
	#NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 0x0010

	)

301 
	#NGX_MAIL_AUTH_NONE_ENABLED
 0x0020

	)

304 
	#NGX_MAIL_PARSE_INVALID_COMMAND
 20

	)

307 (*
	tngx_ma_š™_£ssiÚ_±
)(
	tngx_ma_£ssiÚ_t
 *
	ts
,

308 
	tngx_cÚÃùiÚ_t
 *
	tc
);

309 (*
	tngx_ma_š™_´ÙocŞ_±
)(
	tngx_ev’t_t
 *
	t»v
);

310 (*
	tngx_ma_auth_¡©e_±
)(
	tngx_ev’t_t
 *
	t»v
);

311 
	$ngx_št_t
 (*
	tngx_ma_·r£_commªd_±
)(
	tngx_ma_£ssiÚ_t
 *
	ts
);

314 
	sngx_ma_´ÙocŞ_s
 {

315 
ngx_¡r_t
 
Çme
;

316 
š_pÜt_t
 
pÜt
[4];

317 
ngx_ušt_t
 
ty³
;

319 
ngx_ma_š™_£ssiÚ_±
 
š™_£ssiÚ
;

320 
ngx_ma_š™_´ÙocŞ_±
 
š™_´ÙocŞ
;

321 
ngx_ma_·r£_commªd_±
 
·r£_commªd
;

322 
ngx_ma_auth_¡©e_±
 
auth_¡©e
;

324 
ngx_¡r_t
 
š‹º®_£rv”_”rÜ
;

329 
ngx_ma_´ÙocŞ_t
 *
´ÙocŞ
;

331 *(*
ü—‹_maš_cÚf
)(
ngx_cÚf_t
 *
cf
);

332 *(*
š™_maš_cÚf
)(
ngx_cÚf_t
 *
cf
, *
cÚf
);

334 *(*
ü—‹_¤v_cÚf
)(
ngx_cÚf_t
 *
cf
);

335 *(*
m”ge_¤v_cÚf
)(
ngx_cÚf_t
 *
cf
, *
´ev
,

336 *
cÚf
);

337 } 
	tngx_ma_moduË_t
;

340 
	#NGX_MAIL_MODULE
 0x4C49414D

	)

342 
	#NGX_MAIL_MAIN_CONF
 0x02000000

	)

343 
	#NGX_MAIL_SRV_CONF
 0x04000000

	)

346 
	#NGX_MAIL_MAIN_CONF_OFFSET
 
	`off£tof
(
ngx_ma_cÚf_ùx_t
, 
maš_cÚf
)

	)

347 
	#NGX_MAIL_SRV_CONF_OFFSET
 
	`off£tof
(
ngx_ma_cÚf_ùx_t
, 
¤v_cÚf
)

	)

350 
	#ngx_ma_g‘_moduË_ùx
(
s
, 
moduË
è(s)->
ùx
[moduË.
ùx_šdex
]

	)

351 
	#ngx_ma_£t_ùx
(
s
, 
c
, 
moduË
ès->
ùx
[moduË.
ùx_šdex
] = c;

	)

352 
	#ngx_ma_d–‘e_ùx
(
s
, 
moduË
ès->
ùx
[moduË.
ùx_šdex
] = 
NULL
;

	)

355 
	#ngx_ma_g‘_moduË_maš_cÚf
(
s
, 
moduË
) \

356 (
s
)->
maš_cÚf
[
moduË
.
ùx_šdex
]

	)

357 
	#ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
moduË
è(s)->
¤v_cÚf
[moduË.
ùx_šdex
]

	)

359 
	#ngx_ma_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
moduË
) \

360 ((
ngx_ma_cÚf_ùx_t
 *è
cf
->
ùx
)->
maš_cÚf
[
moduË
.
ùx_šdex
]

	)

361 
	#ngx_ma_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
moduË
) \

362 ((
ngx_ma_cÚf_ùx_t
 *è
cf
->
ùx
)->
¤v_cÚf
[
moduË
.
ùx_šdex
]

	)

365 #ià(
NGX_MAIL_SSL
)

366 
	`ngx_ma_¡¬‰ls_hªdËr
(
ngx_ev’t_t
 *
»v
);

367 
ngx_št_t
 
	`ngx_ma_¡¬‰ls_Úly
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

371 
	`ngx_ma_š™_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

373 
ngx_št_t
 
	`ngx_ma_§É
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

374 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
);

375 
ngx_št_t
 
	`ngx_ma_auth_¶aš
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

376 
ngx_ušt_t
 
n
);

377 
ngx_št_t
 
	`ngx_ma_auth_logš_u£ºame
(
ngx_ma_£ssiÚ_t
 *
s
,

378 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
n
);

379 
ngx_št_t
 
	`ngx_ma_auth_logš_·sswÜd
(
ngx_ma_£ssiÚ_t
 *
s
,

380 
ngx_cÚÃùiÚ_t
 *
c
);

381 
ngx_št_t
 
	`ngx_ma_auth_üam_md5_§É
(
ngx_ma_£ssiÚ_t
 *
s
,

382 
ngx_cÚÃùiÚ_t
 *
c
, *
´efix
, 
size_t
 
Ën
);

383 
ngx_št_t
 
	`ngx_ma_auth_üam_md5
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

384 
ngx_št_t
 
	`ngx_ma_auth_·r£
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

386 
	`ngx_ma_£nd
(
ngx_ev’t_t
 *
wev
);

387 
ngx_št_t
 
	`ngx_ma_»ad_commªd
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

388 
	`ngx_ma_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

389 
	`ngx_ma_şo£_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

390 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
);

391 
u_ch¬
 *
	`ngx_ma_log_”rÜ
(
ngx_log_t
 *
log
, u_ch¬ *
buf
, 
size_t
 
Ën
);

394 *
	`ngx_ma_ÿ·b™›s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

398 
	`ngx_ma_´oxy_š™
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_addr_t
 *
³”
);

399 
	`ngx_ma_auth_h‰p_š™
(
ngx_ma_£ssiÚ_t
 *
s
);

403 
ngx_ušt_t
 
ngx_ma_max_moduË
;

404 
ngx_moduË_t
 
ngx_ma_cÜe_moduË
;

	@ngx_mail_auth_http_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

12 
	~<ngx_ma.h
>

16 
ngx_addr_t
 *
	m³”
;

18 
ngx_m£c_t
 
	mtimeout
;

20 
ngx_¡r_t
 
	mho¡_h—d”
;

21 
ngx_¡r_t
 
	muri
;

22 
ngx_¡r_t
 
	mh—d”
;

24 
ngx_¬¿y_t
 *
	mh—d”s
;

26 
u_ch¬
 *
	mfe
;

27 
ngx_ušt_t
 
	mlše
;

28 } 
	tngx_ma_auth_h‰p_cÚf_t
;

31 
ngx_ma_auth_h‰p_ùx_s
 
	tngx_ma_auth_h‰p_ùx_t
;

33 (*
	tngx_ma_auth_h‰p_hªdËr_±
)(
	tngx_ma_£ssiÚ_t
 *
	ts
,

34 
	tngx_ma_auth_h‰p_ùx_t
 *
	tùx
);

36 
	sngx_ma_auth_h‰p_ùx_s
 {

37 
ngx_buf_t
 *
»que¡
;

38 
ngx_buf_t
 *
»¥Ú£
;

39 
ngx_³”_cÚÃùiÚ_t
 
³”
;

41 
ngx_ma_auth_h‰p_hªdËr_±
 
hªdËr
;

43 
ngx_ušt_t
 
¡©e
;

45 
u_ch¬
 *
h—d”_Çme_¡¬t
;

46 
u_ch¬
 *
h—d”_Çme_’d
;

47 
u_ch¬
 *
h—d”_¡¬t
;

48 
u_ch¬
 *
h—d”_’d
;

50 
ngx_¡r_t
 
addr
;

51 
ngx_¡r_t
 
pÜt
;

52 
ngx_¡r_t
 
”r
;

53 
ngx_¡r_t
 
”rmsg
;

54 
ngx_¡r_t
 
”rcode
;

56 
time_t
 
¦“p
;

58 
ngx_poŞ_t
 *
poŞ
;

62 
	`ngx_ma_auth_h‰p_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
);

63 
	`ngx_ma_auth_h‰p_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
);

64 
	`ngx_ma_auth_h‰p_ignÜe_¡©us_lše
(
ngx_ma_£ssiÚ_t
 *
s
,

65 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
);

66 
	`ngx_ma_auth_h‰p_´oûss_h—d”s
(
ngx_ma_£ssiÚ_t
 *
s
,

67 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
);

68 
	`ngx_ma_auth_¦“p_hªdËr
(
ngx_ev’t_t
 *
»v
);

69 
ngx_št_t
 
	`ngx_ma_auth_h‰p_·r£_h—d”_lše
(
ngx_ma_£ssiÚ_t
 *
s
,

70 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
);

71 
	`ngx_ma_auth_h‰p_block_»ad
(
ngx_ev’t_t
 *
»v
);

72 
	`ngx_ma_auth_h‰p_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

73 
ngx_buf_t
 *
	`ngx_ma_auth_h‰p_ü—‹_»que¡
(
ngx_ma_£ssiÚ_t
 *
s
,

74 
ngx_poŞ_t
 *
poŞ
, 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
);

75 
ngx_št_t
 
	`ngx_ma_auth_h‰p_esÿ³
(
ngx_poŞ_t
 *
poŞ
, 
ngx_¡r_t
 *
‹xt
,

76 
ngx_¡r_t
 *
esÿ³d
);

78 *
	`ngx_ma_auth_h‰p_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

79 *
	`ngx_ma_auth_h‰p_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

80 *
chd
);

81 *
	`ngx_ma_auth_h‰p
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
);

82 *
	`ngx_ma_auth_h‰p_h—d”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

83 *
cÚf
);

86 
ngx_commªd_t
 
ngx_ma_auth_h‰p_commªds
[] = {

88 { 
	`ngx_¡ršg
("auth_http"),

89 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

90 
ngx_ma_auth_h‰p
,

91 
NGX_MAIL_SRV_CONF_OFFSET
,

93 
NULL
 },

95 { 
	`ngx_¡ršg
("auth_http_timeout"),

96 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

97 
ngx_cÚf_£t_m£c_¦Ù
,

98 
NGX_MAIL_SRV_CONF_OFFSET
,

99 
	`off£tof
(
ngx_ma_auth_h‰p_cÚf_t
, 
timeout
),

100 
NULL
 },

102 { 
	`ngx_¡ršg
("auth_http_header"),

103 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE2
,

104 
ngx_ma_auth_h‰p_h—d”
,

105 
NGX_MAIL_SRV_CONF_OFFSET
,

107 
NULL
 },

109 
ngx_nuÎ_commªd


110 
	}
};

113 
ngx_ma_moduË_t
 
	gngx_ma_auth_h‰p_moduË_ùx
 = {

114 
NULL
,

116 
NULL
,

117 
NULL
,

119 
ngx_ma_auth_h‰p_ü—‹_cÚf
,

120 
ngx_ma_auth_h‰p_m”ge_cÚf


124 
ngx_moduË_t
 
	gngx_ma_auth_h‰p_moduË
 = {

125 
NGX_MODULE_V1
,

126 &
ngx_ma_auth_h‰p_moduË_ùx
,

127 
ngx_ma_auth_h‰p_commªds
,

128 
NGX_MAIL_MODULE
,

129 
NULL
,

130 
NULL
,

131 
NULL
,

132 
NULL
,

133 
NULL
,

134 
NULL
,

135 
NULL
,

136 
NGX_MODULE_V1_PADDING


140 
ngx_¡r_t
 
	gngx_ma_auth_h‰p_m‘hod
[] = {

141 
ngx_¡ršg
("plain"),

142 
ngx_¡ršg
("plain"),

143 
ngx_¡ršg
("plain"),

144 
ngx_¡ršg
("apop"),

145 
ngx_¡ršg
("cram-md5"),

146 
ngx_¡ršg
("none")

149 
ngx_¡r_t
 
	gngx_ma_sm_”rcode
 = 
ngx_¡ršg
("535 5.7.0");

153 
	$ngx_ma_auth_h‰p_š™
(
ngx_ma_£ssiÚ_t
 *
s
)

155 
ngx_št_t
 
rc
;

156 
ngx_poŞ_t
 *
poŞ
;

157 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
;

158 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
;

160 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "in http‡uth state";

162 
poŞ
 = 
	`ngx_ü—‹_poŞ
(2048, 
s
->
cÚÃùiÚ
->
log
);

163 ià(
poŞ
 =ğ
NULL
) {

164 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

168 
ùx
 = 
	`ngx_pÿÎoc
(
poŞ
, (
ngx_ma_auth_h‰p_ùx_t
));

169 ià(
ùx
 =ğ
NULL
) {

170 
	`ngx_de¡roy_poŞ
(
poŞ
);

171 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

175 
ùx
->
poŞ
 =…ool;

177 
ahcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_auth_h‰p_moduË
);

179 
ùx
->
»que¡
 = 
	`ngx_ma_auth_h‰p_ü—‹_»que¡
(
s
, 
poŞ
, 
ahcf
);

180 ià(
ùx
->
»que¡
 =ğ
NULL
) {

181 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

182 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

186 
	`ngx_ma_£t_ùx
(
s
, 
ùx
, 
ngx_ma_auth_h‰p_moduË
);

188 
ùx
->
³”
.
sockaddr
 = 
ahcf
->peer->sockaddr;

189 
ùx
->
³”
.
sockËn
 = 
ahcf
->peer->socklen;

190 
ùx
->
³”
.
Çme
 = &
ahcf
->peer->name;

191 
ùx
->
³”
.
g‘
 = 
ngx_ev’t_g‘_³”
;

192 
ùx
->
³”
.
log
 = 
s
->
cÚÃùiÚ
->log;

193 
ùx
->
³”
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

195 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
ùx
->
³”
);

197 ià(
rc
 =ğ
NGX_ERROR
 ||„ø=ğ
NGX_BUSY
 ||„ø=ğ
NGX_DECLINED
) {

198 ià(
ùx
->
³”
.
cÚÃùiÚ
) {

199 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

202 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

203 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

207 
ùx
->
³”
.
cÚÃùiÚ
->
d©a
 = 
s
;

208 
ùx
->
³”
.
cÚÃùiÚ
->
poŞ
 = 
s
->connection->pool;

210 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_auth_h‰p_block_»ad
;

211 
ùx
->
³”
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_auth_h‰p_»ad_hªdËr
;

212 
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_ma_auth_h‰p_wr™e_hªdËr
;

214 
ùx
->
hªdËr
 = 
ngx_ma_auth_h‰p_ignÜe_¡©us_lše
;

216 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
»ad
, 
ahcf
->
timeout
);

217 
	`ngx_add_tim”
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
, 
ahcf
->
timeout
);

219 ià(
rc
 =ğ
NGX_OK
) {

220 
	`ngx_ma_auth_h‰p_wr™e_hªdËr
(
ùx
->
³”
.
cÚÃùiÚ
->
wr™e
);

223 
	}
}

227 
	$ngx_ma_auth_h‰p_wr™e_hªdËr
(
ngx_ev’t_t
 *
wev
)

229 
ssize_t
 
n
, 
size
;

230 
ngx_cÚÃùiÚ_t
 *
c
;

231 
ngx_ma_£ssiÚ_t
 *
s
;

232 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
;

233 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
;

235 
c
 = 
wev
->
d©a
;

236 
s
 = 
c
->
d©a
;

238 
ùx
 = 
	`ngx_ma_g‘_moduË_ùx
(
s
, 
ngx_ma_auth_h‰p_moduË
);

240 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
wev
->
log
, 0,

243 ià(
wev
->
timedout
) {

244 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
wev
->
log
, 
NGX_ETIMEDOUT
,

245 "auth h‰°£rv” %Vimed out", 
ùx
->
³”
.
Çme
);

246 
	`ngx_şo£_cÚÃùiÚ
(
c
);

247 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

248 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

252 
size
 = 
ùx
->
»que¡
->
Ï¡
 - ctx->»que¡->
pos
;

254 
n
 = 
	`ngx_£nd
(
c
, 
ùx
->
»que¡
->
pos
, 
size
);

256 ià(
n
 =ğ
NGX_ERROR
) {

257 
	`ngx_şo£_cÚÃùiÚ
(
c
);

258 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

259 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

263 ià(
n
 > 0) {

264 
ùx
->
»que¡
->
pos
 +ğ
n
;

266 ià(
n
 =ğ
size
) {

267 
wev
->
hªdËr
 = 
ngx_ma_auth_h‰p_dummy_hªdËr
;

269 ià(
wev
->
tim”_£t
) {

270 
	`ngx_d–_tim”
(
wev
);

273 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ğ
NGX_OK
) {

274 
	`ngx_şo£_cÚÃùiÚ
(
c
);

275 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

276 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

283 ià(!
wev
->
tim”_£t
) {

284 
ahcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_auth_h‰p_moduË
);

285 
	`ngx_add_tim”
(
wev
, 
ahcf
->
timeout
);

287 
	}
}

291 
	$ngx_ma_auth_h‰p_»ad_hªdËr
(
ngx_ev’t_t
 *
»v
)

293 
ssize_t
 
n
, 
size
;

294 
ngx_cÚÃùiÚ_t
 *
c
;

295 
ngx_ma_£ssiÚ_t
 *
s
;

296 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
;

298 
c
 = 
»v
->
d©a
;

299 
s
 = 
c
->
d©a
;

301 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

304 
ùx
 = 
	`ngx_ma_g‘_moduË_ùx
(
s
, 
ngx_ma_auth_h‰p_moduË
);

306 ià(
»v
->
timedout
) {

307 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
»v
->
log
, 
NGX_ETIMEDOUT
,

308 "auth h‰°£rv” %Vimed out", 
ùx
->
³”
.
Çme
);

309 
	`ngx_şo£_cÚÃùiÚ
(
c
);

310 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

311 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

315 ià(
ùx
->
»¥Ú£
 =ğ
NULL
) {

316 
ùx
->
»¥Ú£
 = 
	`ngx_ü—‹_‹mp_buf
(ùx->
poŞ
, 1024);

317 ià(
ùx
->
»¥Ú£
 =ğ
NULL
) {

318 
	`ngx_şo£_cÚÃùiÚ
(
c
);

319 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

320 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

325 
size
 = 
ùx
->
»¥Ú£
->
’d
 - ctx->»¥Ú£->
Ï¡
;

327 
n
 = 
	`ngx_»cv
(
c
, 
ùx
->
»¥Ú£
->
pos
, 
size
);

329 ià(
n
 > 0) {

330 
ùx
->
»¥Ú£
->
Ï¡
 +ğ
n
;

332 
ùx
->
	`hªdËr
(
s
, ctx);

336 ià(
n
 =ğ
NGX_AGAIN
) {

340 
	`ngx_şo£_cÚÃùiÚ
(
c
);

341 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

342 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

343 
	}
}

347 
	$ngx_ma_auth_h‰p_ignÜe_¡©us_lše
(
ngx_ma_£ssiÚ_t
 *
s
,

348 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
)

350 
u_ch¬
 *
p
, 
ch
;

352 
sw_¡¬t
 = 0,

353 
sw_H
,

354 
sw_HT
,

355 
sw_HTT
,

356 
sw_HTTP
,

357 
sw_sk
,

358 
sw_®mo¡_dÚe


359 } 
¡©e
;

361 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

364 
¡©e
 = 
ùx
->state;

366 
p
 = 
ùx
->
»¥Ú£
->
pos
;… < ctx->»¥Ú£->
Ï¡
;…++) {

367 
ch
 = *
p
;

369 
¡©e
) {

372 
sw_¡¬t
:

373 ià(
ch
 == 'H') {

374 
¡©e
 = 
sw_H
;

377 
Ãxt
;

379 
sw_H
:

380 ià(
ch
 == 'T') {

381 
¡©e
 = 
sw_HT
;

384 
Ãxt
;

386 
sw_HT
:

387 ià(
ch
 == 'T') {

388 
¡©e
 = 
sw_HTT
;

391 
Ãxt
;

393 
sw_HTT
:

394 ià(
ch
 == 'P') {

395 
¡©e
 = 
sw_HTTP
;

398 
Ãxt
;

400 
sw_HTTP
:

401 ià(
ch
 == '/') {

402 
¡©e
 = 
sw_sk
;

405 
Ãxt
;

408 
sw_sk
:

409 
ch
) {

410 
CR
:

411 
¡©e
 = 
sw_®mo¡_dÚe
;

414 
LF
:

415 
dÚe
;

420 
sw_®mo¡_dÚe
:

421 ià(
ch
 =ğ
LF
) {

422 
dÚe
;

425 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

427 
ùx
->
³”
.
Çme
);

428 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

429 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

430 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

435 
ùx
->
»¥Ú£
->
pos
 = 
p
;

436 
ùx
->
¡©e
 = state;

440 
Ãxt
:

442 
p
 = 
ùx
->
»¥Ú£
->
¡¬t
 - 1;

444 
dÚe
:

446 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

447 
ùx
->
¡©e
 = 0;

448 
ùx
->
hªdËr
 = 
ngx_ma_auth_h‰p_´oûss_h—d”s
;

449 
ùx
->
	`hªdËr
(
s
, ctx);

450 
	}
}

454 
	$ngx_ma_auth_h‰p_´oûss_h—d”s
(
ngx_ma_£ssiÚ_t
 *
s
,

455 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
)

457 
u_ch¬
 *
p
;

458 
time_t
 
tim”
;

459 
size_t
 
Ën
, 
size
;

460 
ngx_št_t
 
rc
, 
pÜt
, 
n
;

461 
ngx_addr_t
 *
³”
;

462 
sockaddr_š
 *
sš
;

464 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

468 
rc
 = 
	`ngx_ma_auth_h‰p_·r£_h—d”_lše
(
s
, 
ùx
);

470 ià(
rc
 =ğ
NGX_OK
) {

472 #ià(
NGX_DEBUG
)

474 
ngx_¡r_t
 
key
, 
v®ue
;

476 
key
.
Ën
 = 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
;

477 
key
.
d©a
 = 
ùx
->
h—d”_Çme_¡¬t
;

478 
v®ue
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

479 
v®ue
.
d©a
 = 
ùx
->
h—d”_¡¬t
;

481 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

483 &
key
, &
v®ue
);

487 
Ën
 = 
ùx
->
h—d”_Çme_’d
 - ctx->
h—d”_Çme_¡¬t
;

489 ià(
Ën
 == ("Auth-Status") - 1

490 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

491 (
u_ch¬
 *) "Auth-Status",

495 
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

497 ià(
Ën
 == 2

498 && 
ùx
->
h—d”_¡¬t
[0] == 'O'

499 && 
ùx
->
h—d”_¡¬t
[1] == 'K')

504 ià(
Ën
 == 4

505 && 
ùx
->
h—d”_¡¬t
[0] == 'W'

506 && 
ùx
->
h—d”_¡¬t
[1] == 'A'

507 && 
ùx
->
h—d”_¡¬t
[2] == 'I'

508 && 
ùx
->
h—d”_¡¬t
[3] == 'T')

510 
s
->
auth_wa™
 = 1;

514 
ùx
->
”rmsg
.
Ën
 =†en;

515 
ùx
->
”rmsg
.
d©a
 = ctx->
h—d”_¡¬t
;

517 
s
->
´ÙocŞ
) {

519 
NGX_MAIL_POP3_PROTOCOL
:

520 
size
 = ("-ERR "è- 1 + 
Ën
 + (
CRLF
) - 1;

523 
NGX_MAIL_IMAP_PROTOCOL
:

524 
size
 = 
s
->
g
.
Ën
 + ("NO ") - 1 +†en

525 + (
CRLF
) - 1;

529 
ùx
->
”r
 = ctx->
”rmsg
;

533 
p
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poŞ
, 
size
);

534 ià(
p
 =ğ
NULL
) {

535 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

536 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

537 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

541 
ùx
->
”r
.
d©a
 = 
p
;

543 
s
->
´ÙocŞ
) {

545 
NGX_MAIL_POP3_PROTOCOL
:

546 *
p
++ = '-'; *p++ = 'E'; *p++ = 'R'; *p++ = 'R'; *p++ = ' ';

549 
NGX_MAIL_IMAP_PROTOCOL
:

550 
p
 = 
	`ngx_ıymem
Õ, 
s
->
g
.
d©a
, s->g.
Ën
);

551 *
p
++ = 'N'; *p++ = 'O'; *p++ = ' ';

558 
p
 = 
	`ngx_ıymem
Õ, 
ùx
->
h—d”_¡¬t
, 
Ën
);

559 *
p
++ = 
CR
; *p++ = 
LF
;

561 
ùx
->
”r
.
Ën
 = 
p
 - ctx->”r.
d©a
;

566 ià(
Ën
 == ("Auth-Server") - 1

567 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

568 (
u_ch¬
 *) "Auth-Server",

572 
ùx
->
addr
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

573 
ùx
->
addr
.
d©a
 = ctx->
h—d”_¡¬t
;

578 ià(
Ën
 == ("Auth-Port") - 1

579 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

580 (
u_ch¬
 *) "Auth-Port",

584 
ùx
->
pÜt
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

585 
ùx
->
pÜt
.
d©a
 = ctx->
h—d”_¡¬t
;

590 ià(
Ën
 == ("Auth-User") - 1

591 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

592 (
u_ch¬
 *) "Auth-User",

596 
s
->
logš
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

598 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(s->
cÚÃùiÚ
->
poŞ
, s->logš.
Ën
);

599 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

600 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

601 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

602 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

606 
	`ngx_memıy
(
s
->
logš
.
d©a
, 
ùx
->
h—d”_¡¬t
, s->logš.
Ën
);

611 ià(
Ën
 == ("Auth-Pass") - 1

612 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

613 (
u_ch¬
 *) "Auth-Pass",

617 
s
->
·sswd
.
Ën
 = 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

619 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(s->
cÚÃùiÚ
->
poŞ
,

620 
s
->
·sswd
.
Ën
);

621 ià(
s
->
·sswd
.
d©a
 =ğ
NULL
) {

622 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

623 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

624 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

628 
	`ngx_memıy
(
s
->
·sswd
.
d©a
, 
ùx
->
h—d”_¡¬t
, s->·sswd.
Ën
);

633 ià(
Ën
 == ("Auth-Wait") - 1

634 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

635 (
u_ch¬
 *) "Auth-Wait",

639 
n
 = 
	`ngx_©oi
(
ùx
->
h—d”_¡¬t
,

640 
ùx
->
h—d”_’d
 - ctx->
h—d”_¡¬t
);

642 ià(
n
 !ğ
NGX_ERROR
) {

643 
ùx
->
¦“p
 = 
n
;

649 ià(
Ën
 == ("Auth-Error-Code") - 1

650 && 
	`ngx_¡ºÿ£cmp
(
ùx
->
h—d”_Çme_¡¬t
,

651 (
u_ch¬
 *) "Auth-Error-Code",

655 
ùx
->
”rcode
.
Ën
 = ctx->
h—d”_’d
 - ctx->
h—d”_¡¬t
;

657 
ùx
->
”rcode
.
d©a
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poŞ
,

658 
ùx
->
”rcode
.
Ën
);

659 ià(
ùx
->
”rcode
.
d©a
 =ğ
NULL
) {

660 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

661 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

662 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

666 
	`ngx_memıy
(
ùx
->
”rcode
.
d©a
, ctx->
h—d”_¡¬t
,

667 
ùx
->
”rcode
.
Ën
);

677 ià(
rc
 =ğ
NGX_DONE
) {

678 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

681 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

683 ià(
ùx
->
”r
.
Ën
) {

685 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
s
->
cÚÃùiÚ
->
log
, 0,

686 "ş›Á†ogš faed: \"%V\"", &
ùx
->
”rmsg
);

688 ià(
s
->
´ÙocŞ
 =ğ
NGX_MAIL_SMTP_PROTOCOL
) {

690 ià(
ùx
->
”rcode
.
Ën
 == 0) {

691 
ùx
->
”rcode
 = 
ngx_ma_sm_”rcode
;

694 
ùx
->
”r
.
Ën
 = ctx->
”rcode
.ËÀ+ ctx->
”rmsg
.len

695 + (" " 
CRLF
) - 1;

697 
p
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poŞ
, 
ùx
->
”r
.
Ën
);

698 ià(
p
 =ğ
NULL
) {

699 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

700 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

701 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

705 
ùx
->
”r
.
d©a
 = 
p
;

707 
p
 = 
	`ngx_ıymem
Õ, 
ùx
->
”rcode
.
d©a
, ctx->”rcode.
Ën
);

708 *
p
++ = ' ';

709 
p
 = 
	`ngx_ıymem
Õ, 
ùx
->
”rmsg
.
d©a
, ctx->”rmsg.
Ën
);

710 *
p
++ = 
CR
; *°ğ
LF
;

713 
s
->
out
 = 
ùx
->
”r
;

714 
tim”
 = 
ùx
->
¦“p
;

716 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

718 ià(
tim”
 == 0) {

719 
s
->
qu™
 = 1;

720 
	`ngx_ma_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

724 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, (
ngx_m£c_t
è(
tim”
 * 1000));

726 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_auth_¦“p_hªdËr
;

731 ià(
s
->
auth_wa™
) {

732 
tim”
 = 
ùx
->
¦“p
;

734 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

736 ià(
tim”
 == 0) {

737 
	`ngx_ma_auth_h‰p_š™
(
s
);

741 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, (
ngx_m£c_t
è(
tim”
 * 1000));

743 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_auth_¦“p_hªdËr
;

748 ià(
ùx
->
addr
.
Ën
 =ğ0 || ctx->
pÜt
.len == 0) {

749 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

751 
ùx
->
³”
.
Çme
);

752 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

753 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

757 ià(
s
->
·sswd
.
d©a
 =ğ
NULL


758 && 
s
->
´ÙocŞ
 !ğ
NGX_MAIL_SMTP_PROTOCOL
)

760 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

762 
ùx
->
³”
.
Çme
);

763 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

764 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

768 
³”
 = 
	`ngx_pÿÎoc
(
s
->
cÚÃùiÚ
->
poŞ
, (
ngx_addr_t
));

769 ià(
³”
 =ğ
NULL
) {

770 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

771 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

777 
sš
 = 
	`ngx_pÿÎoc
(
s
->
cÚÃùiÚ
->
poŞ
, (
sockaddr_š
));

778 ià(
sš
 =ğ
NULL
) {

779 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

780 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

784 
sš
->
sš_çmy
 = 
AF_INET
;

786 
pÜt
 = 
	`ngx_©oi
(
ùx
->pÜt.
d©a
, ctx->pÜt.
Ën
);

787 ià(
pÜt
 =ğ
NGX_ERROR
 ||…ort < 1 ||…ort > 65535) {

788 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

791 
ùx
->
³”
.
Çme
, &ùx->
pÜt
);

792 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

793 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

797 
sš
->
sš_pÜt
 = 
	`htÚs
((
š_pÜt_t
è
pÜt
);

799 
sš
->
sš_addr
.
s_addr
 = 
	`ngx_š‘_addr
(
ùx
->
addr
.
d©a
, ctx->addr.
Ën
);

800 ià(
sš
->
sš_addr
.
s_addr
 =ğ
INADDR_NONE
) {

801 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

804 
ùx
->
³”
.
Çme
, &ùx->
addr
);

805 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

806 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

810 
³”
->
sockaddr
 = (sockadd¸*è
sš
;

811 
³”
->
sockËn
 = (
sockaddr_š
);

813 
Ën
 = 
ùx
->
addr
.ËÀ+ 1 + ctx->
pÜt
.len;

815 
³”
->
Çme
.
Ën
 =†en;

817 
³”
->
Çme
.
d©a
 = 
	`ngx_²®loc
(
s
->
cÚÃùiÚ
->
poŞ
, 
Ën
);

818 ià(
³”
->
Çme
.
d©a
 =ğ
NULL
) {

819 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

820 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

824 
Ën
 = 
ùx
->
addr
.len;

826 
	`ngx_memıy
(
³”
->
Çme
.
d©a
, 
ùx
->
addr
.d©a, 
Ën
);

828 
³”
->
Çme
.
d©a
[
Ën
++] = ':';

830 
	`ngx_memıy
(
³”
->
Çme
.
d©a
 + 
Ën
, 
ùx
->
pÜt
.data, ctx->port.len);

832 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

833 
	`ngx_ma_´oxy_š™
(
s
, 
³”
);

838 ià(
rc
 =ğ
NGX_AGAIN
 ) {

844 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

846 
ùx
->
³”
.
Çme
);

847 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

848 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

849 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

853 
	}
}

857 
	$ngx_ma_auth_¦“p_hªdËr
(
ngx_ev’t_t
 *
»v
)

859 
ngx_cÚÃùiÚ_t
 *
c
;

860 
ngx_ma_£ssiÚ_t
 *
s
;

861 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

863 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail‡uth sleep handler");

865 
c
 = 
»v
->
d©a
;

866 
s
 = 
c
->
d©a
;

868 ià(
»v
->
timedout
) {

870 
»v
->
timedout
 = 0;

872 ià(
s
->
auth_wa™
) {

873 
s
->
auth_wa™
 = 0;

874 
	`ngx_ma_auth_h‰p_š™
(
s
);

878 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

880 
»v
->
hªdËr
 = 
cscf
->
´ÙocŞ
->
auth_¡©e
;

882 
s
->
ma_¡©e
 = 0;

883 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_PLAIN
;

885 
c
->
log
->
aùiÚ
 = "in‡uth state";

887 
	`ngx_ma_£nd
(
c
->
wr™e
);

889 ià(
c
->
de¡royed
) {

893 
	`ngx_add_tim”
(
»v
, 
cscf
->
timeout
);

895 ià(
»v
->
»ady
) {

896 
»v
->
	`hªdËr
(rev);

900 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ğ
NGX_OK
) {

901 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

907 ià(
»v
->
aùive
) {

908 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ğ
NGX_OK
) {

909 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

912 
	}
}

915 
ngx_št_t


916 
	$ngx_ma_auth_h‰p_·r£_h—d”_lše
(
ngx_ma_£ssiÚ_t
 *
s
,

917 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
)

919 
u_ch¬
 
c
, 
ch
, *
p
;

921 
sw_¡¬t
 = 0,

922 
sw_Çme
,

923 
sw_¥aû_befÜe_v®ue
,

924 
sw_v®ue
,

925 
sw_¥aû_aá”_v®ue
,

926 
sw_®mo¡_dÚe
,

927 
sw_h—d”_®mo¡_dÚe


928 } 
¡©e
;

930 
¡©e
 = 
ùx
->state;

932 
p
 = 
ùx
->
»¥Ú£
->
pos
;… < ctx->»¥Ú£->
Ï¡
;…++) {

933 
ch
 = *
p
;

935 
¡©e
) {

938 
sw_¡¬t
:

940 
ch
) {

941 
CR
:

942 
ùx
->
h—d”_’d
 = 
p
;

943 
¡©e
 = 
sw_h—d”_®mo¡_dÚe
;

945 
LF
:

946 
ùx
->
h—d”_’d
 = 
p
;

947 
h—d”_dÚe
;

949 
¡©e
 = 
sw_Çme
;

950 
ùx
->
h—d”_Çme_¡¬t
 = 
p
;

952 
c
 = (
u_ch¬
è(
ch
 | 0x20);

953 ià(
c
 >= 'a' && c <= 'z') {

957 ià(
ch
 >= '0' && ch <= '9') {

961  
NGX_ERROR
;

966 
sw_Çme
:

967 
c
 = (
u_ch¬
è(
ch
 | 0x20);

968 ià(
c
 >= 'a' && c <= 'z') {

972 ià(
ch
 == ':') {

973 
ùx
->
h—d”_Çme_’d
 = 
p
;

974 
¡©e
 = 
sw_¥aû_befÜe_v®ue
;

978 ià(
ch
 == '-') {

982 ià(
ch
 >= '0' && ch <= '9') {

986 ià(
ch
 =ğ
CR
) {

987 
ùx
->
h—d”_Çme_’d
 = 
p
;

988 
ùx
->
h—d”_¡¬t
 = 
p
;

989 
ùx
->
h—d”_’d
 = 
p
;

990 
¡©e
 = 
sw_®mo¡_dÚe
;

994 ià(
ch
 =ğ
LF
) {

995 
ùx
->
h—d”_Çme_’d
 = 
p
;

996 
ùx
->
h—d”_¡¬t
 = 
p
;

997 
ùx
->
h—d”_’d
 = 
p
;

998 
dÚe
;

1001  
NGX_ERROR
;

1004 
sw_¥aû_befÜe_v®ue
:

1005 
ch
) {

1008 
CR
:

1009 
ùx
->
h—d”_¡¬t
 = 
p
;

1010 
ùx
->
h—d”_’d
 = 
p
;

1011 
¡©e
 = 
sw_®mo¡_dÚe
;

1013 
LF
:

1014 
ùx
->
h—d”_¡¬t
 = 
p
;

1015 
ùx
->
h—d”_’d
 = 
p
;

1016 
dÚe
;

1018 
ùx
->
h—d”_¡¬t
 = 
p
;

1019 
¡©e
 = 
sw_v®ue
;

1025 
sw_v®ue
:

1026 
ch
) {

1028 
ùx
->
h—d”_’d
 = 
p
;

1029 
¡©e
 = 
sw_¥aû_aá”_v®ue
;

1031 
CR
:

1032 
ùx
->
h—d”_’d
 = 
p
;

1033 
¡©e
 = 
sw_®mo¡_dÚe
;

1035 
LF
:

1036 
ùx
->
h—d”_’d
 = 
p
;

1037 
dÚe
;

1042 
sw_¥aû_aá”_v®ue
:

1043 
ch
) {

1046 
CR
:

1047 
¡©e
 = 
sw_®mo¡_dÚe
;

1049 
LF
:

1050 
dÚe
;

1052 
¡©e
 = 
sw_v®ue
;

1058 
sw_®mo¡_dÚe
:

1059 
ch
) {

1060 
LF
:

1061 
dÚe
;

1063  
NGX_ERROR
;

1067 
sw_h—d”_®mo¡_dÚe
:

1068 
ch
) {

1069 
LF
:

1070 
h—d”_dÚe
;

1072  
NGX_ERROR
;

1077 
ùx
->
»¥Ú£
->
pos
 = 
p
;

1078 
ùx
->
¡©e
 = state;

1080  
NGX_AGAIN
;

1082 
dÚe
:

1084 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1085 
ùx
->
¡©e
 = 
sw_¡¬t
;

1087  
NGX_OK
;

1089 
h—d”_dÚe
:

1091 
ùx
->
»¥Ú£
->
pos
 = 
p
 + 1;

1092 
ùx
->
¡©e
 = 
sw_¡¬t
;

1094  
NGX_DONE
;

1095 
	}
}

1099 
	$ngx_ma_auth_h‰p_block_»ad
(
ngx_ev’t_t
 *
»v
)

1101 
ngx_cÚÃùiÚ_t
 *
c
;

1102 
ngx_ma_£ssiÚ_t
 *
s
;

1103 
ngx_ma_auth_h‰p_ùx_t
 *
ùx
;

1105 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

1108 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ğ
NGX_OK
) {

1109 
c
 = 
»v
->
d©a
;

1110 
s
 = 
c
->
d©a
;

1112 
ùx
 = 
	`ngx_ma_g‘_moduË_ùx
(
s
, 
ngx_ma_auth_h‰p_moduË
);

1114 
	`ngx_şo£_cÚÃùiÚ
(
ùx
->
³”
.
cÚÃùiÚ
);

1115 
	`ngx_de¡roy_poŞ
(
ùx
->
poŞ
);

1116 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1118 
	}
}

1122 
	$ngx_ma_auth_h‰p_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
)

1124 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
ev
->
log
, 0,

1126 
	}
}

1129 
ngx_buf_t
 *

1130 
	$ngx_ma_auth_h‰p_ü—‹_»que¡
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_poŞ_t
 *
poŞ
,

1131 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
)

1133 
size_t
 
Ën
;

1134 
ngx_buf_t
 *
b
;

1135 
ngx_¡r_t
 
logš
, 
·sswd
;

1136 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

1138 ià(
	`ngx_ma_auth_h‰p_esÿ³
(
poŞ
, &
s
->
logš
, &logšè!ğ
NGX_OK
) {

1139  
NULL
;

1142 ià(
	`ngx_ma_auth_h‰p_esÿ³
(
poŞ
, &
s
->
·sswd
, &·sswdè!ğ
NGX_OK
) {

1143  
NULL
;

1146 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

1148 
Ën
 = ("GET "è- 1 + 
ahcf
->
uri
.ËÀ+ (" HTTP/1.0" 
CRLF
) - 1

1149 + ("Ho¡: "è- 1 + 
ahcf
->
ho¡_h—d”
.
Ën
 + (
CRLF
) - 1

1151 + 
ngx_ma_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
Ën


1152 + (
CRLF
) - 1

1153 + ("Auth-U£r: "è- 1 + 
logš
.
Ën
 + (
CRLF
) - 1

1154 + ("Auth-Pass: "è- 1 + 
·sswd
.
Ën
 + (
CRLF
) - 1

1155 + ("Auth-S®t: "è- 1 + 
s
->
§É
.
Ën


1156 + ("Auth-PrÙocŞ: "è- 1 + 
cscf
->
´ÙocŞ
->
Çme
.
Ën


1157 + (
CRLF
) - 1

1158 + ("Auth-Logš-A‰em±: "è- 1 + 
NGX_INT_T_LEN


1159 + (
CRLF
) - 1

1160 + ("Cl›Á-IP: "è- 1 + 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën


1161 + (
CRLF
) - 1

1162 + ("Cl›Á-Ho¡: "è- 1 + 
s
->
ho¡
.
Ën
 + (
CRLF
) - 1

1163 + ("Auth-SMTP-H–o: "è- 1 + 
s
->
sm_h–o
.
Ën


1164 + ("Auth-SMTP-From: "è- 1 + 
s
->
sm_äom
.
Ën


1165 + ("Auth-SMTP-To: "è- 1 + 
s
->
sm_to
.
Ën


1166 + 
ahcf
->
h—d”
.
Ën


1167 + (
CRLF
) - 1;

1169 
b
 = 
	`ngx_ü—‹_‹mp_buf
(
poŞ
, 
Ën
);

1170 ià(
b
 =ğ
NULL
) {

1171  
NULL
;

1174 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "GET ", ("GET ") - 1);

1175 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
ahcf
->
uri
.
d©a
,‡hcf->uri.
Ën
);

1176 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->Ï¡, " HTTP/1.0" 
CRLF
,

1177 (" HTTP/1.0" 
CRLF
) - 1);

1179 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Host: ", ("Host: ") - 1);

1180 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
ahcf
->
ho¡_h—d”
.
d©a
,

1181 
ahcf
->
ho¡_h—d”
.
Ën
);

1182 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1184 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-Method: ",

1186 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last,

1187 
ngx_ma_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
d©a
,

1188 
ngx_ma_auth_h‰p_m‘hod
[
s
->
auth_m‘hod
].
Ën
);

1189 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1191 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-User: ", ("Auth-User: ") - 1);

1192 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
logš
.
d©a
,†ogš.
Ën
);

1193 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1195 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-Pass: ", ("Auth-Pass: ") - 1);

1196 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
·sswd
.
d©a
,…asswd.
Ën
);

1197 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1199 ià(
s
->
auth_m‘hod
 !ğ
NGX_MAIL_AUTH_PLAIN
 && s->
§É
.
Ën
) {

1200 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-Salt: ", ("Auth-Salt: ") - 1);

1201 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
§É
.
d©a
, s->§É.
Ën
);

1203 
s
->
·sswd
.
d©a
 = 
NULL
;

1206 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-Protocol: ",

1208 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->Ï¡, 
cscf
->
´ÙocŞ
->
Çme
.
d©a
,

1209 
cscf
->
´ÙocŞ
->
Çme
.
Ën
);

1210 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1212 
b
->
Ï¡
 = 
	`ngx_¥rštf
(b->Ï¡, "Auth-Logš-A‰em±: %ui" 
CRLF
,

1213 
s
->
logš_©‹m±
);

1215 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Client-IP: ", ("Client-IP: ") - 1);

1216 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
cÚÃùiÚ
->
addr_‹xt
.
d©a
,

1217 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën
);

1218 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1220 ià(
s
->
ho¡
.
Ën
) {

1221 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Client-Host: ",

1223 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
ho¡
.
d©a
, s->ho¡.
Ën
);

1224 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1227 ià(
s
->
auth_m‘hod
 =ğ
NGX_MAIL_AUTH_NONE
) {

1231 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-SMTP-Helo: ",

1233 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
sm_h–o
.
d©a
, s->sm_h–o.
Ën
);

1234 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1236 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-SMTP-From: ",

1238 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
sm_äom
.
d©a
, s->sm_äom.
Ën
);

1239 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1241 
b
->
Ï¡
 = 
	`ngx_ıymem
(b->last, "Auth-SMTP-To: ",

1243 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
s
->
sm_to
.
d©a
, s->sm_to.
Ën
);

1244 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1248 ià(
ahcf
->
h—d”
.
Ën
) {

1249 
b
->
Ï¡
 = 
	`ngx_cİy
(b->Ï¡, 
ahcf
->
h—d”
.
d©a
,‡hcf->h—d”.
Ën
);

1253 *
b
->
Ï¡
++ = 
CR
; *b->Ï¡++ = 
LF
;

1255 #ià(
NGX_DEBUG_MAIL_PASSWD
)

1257 
ngx_¡r_t
 
l
;

1259 
l
.
Ën
 = 
b
->
Ï¡
 - b->
pos
;

1260 
l
.
d©a
 = 
b
->
pos
;

1261 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1262 "ma‡uth h‰°h—d”:\n\"%V\"", &
l
);

1266  
b
;

1267 
	}
}

1270 
ngx_št_t


1271 
	$ngx_ma_auth_h‰p_esÿ³
(
ngx_poŞ_t
 *
poŞ
, 
ngx_¡r_t
 *
‹xt
,‚gx_¡r_ˆ*
esÿ³d
)

1273 
u_ch¬
 *
p
;

1274 
ušŒ_t
 
n
;

1276 
n
 = 
	`ngx_esÿ³_uri
(
NULL
, 
‹xt
->
d©a
,ext->
Ën
, 
NGX_ESCAPE_MAIL_AUTH
);

1278 ià(
n
 == 0) {

1279 *
esÿ³d
 = *
‹xt
;

1280  
NGX_OK
;

1283 
esÿ³d
->
Ën
 = 
‹xt
->ËÀ+ 
n
 * 2;

1285 
p
 = 
	`ngx_²®loc
(
poŞ
, 
esÿ³d
->
Ën
);

1286 ià(
p
 =ğ
NULL
) {

1287  
NGX_ERROR
;

1290 (è
	`ngx_esÿ³_uri
(
p
, 
‹xt
->
d©a
,ext->
Ën
, 
NGX_ESCAPE_MAIL_AUTH
);

1292 
esÿ³d
->
d©a
 = 
p
;

1294  
NGX_OK
;

1295 
	}
}

1299 
	$ngx_ma_auth_h‰p_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1301 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
;

1303 
ahcf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_auth_h‰p_cÚf_t
));

1304 ià(
ahcf
 =ğ
NULL
) {

1305  
NULL
;

1308 
ahcf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

1310 
ahcf
->
fe
 = 
cf
->
cÚf_fe
->fe.
Çme
.
d©a
;

1311 
ahcf
->
lše
 = 
cf
->
cÚf_fe
->line;

1313  
ahcf
;

1314 
	}
}

1318 
	$ngx_ma_auth_h‰p_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

1320 
ngx_ma_auth_h‰p_cÚf_t
 *
´ev
 = 
·»Á
;

1321 
ngx_ma_auth_h‰p_cÚf_t
 *
cÚf
 = 
chd
;

1323 
u_ch¬
 *
p
;

1324 
size_t
 
Ën
;

1325 
ngx_ušt_t
 
i
;

1326 
ngx_bË_–t_t
 *
h—d”
;

1328 ià(
cÚf
->
³”
 =ğ
NULL
) {

1329 
cÚf
->
³”
 = 
´ev
->peer;

1330 
cÚf
->
ho¡_h—d”
 = 
´ev
->host_header;

1331 
cÚf
->
uri
 = 
´ev
->uri;

1333 ià(
cÚf
->
³”
 =ğ
NULL
) {

1334 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

1336 
cÚf
->
fe
, cÚf->
lše
);

1338  
NGX_CONF_ERROR
;

1342 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 60000);

1344 ià(
cÚf
->
h—d”s
 =ğ
NULL
) {

1345 
cÚf
->
h—d”s
 = 
´ev
->headers;

1346 
cÚf
->
h—d”
 = 
´ev
->header;

1349 ià(
cÚf
->
h—d”s
 && cÚf->
h—d”
.
Ën
 == 0) {

1350 
Ën
 = 0;

1351 
h—d”
 = 
cÚf
->
h—d”s
->
–ts
;

1352 
i
 = 0; i < 
cÚf
->
h—d”s
->
ÃÉs
; i++) {

1353 
Ën
 +ğ
h—d”
[
i
].
key
.ËÀ+ 2 + h—d”[i].
v®ue
.len + 2;

1356 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
Ën
);

1357 ià(
p
 =ğ
NULL
) {

1358  
NGX_CONF_ERROR
;

1361 
cÚf
->
h—d”
.
Ën
 =†en;

1362 
cÚf
->
h—d”
.
d©a
 = 
p
;

1364 
i
 = 0; i < 
cÚf
->
h—d”s
->
ÃÉs
; i++) {

1365 
p
 = 
	`ngx_ıymem
Õ, 
h—d”
[
i
].
key
.
d©a
, h—d”[i].key.
Ën
);

1366 *
p
++ = ':'; *p++ = ' ';

1367 
p
 = 
	`ngx_ıymem
Õ, 
h—d”
[
i
].
v®ue
.
d©a
, h—d”[i].v®ue.
Ën
);

1368 *
p
++ = 
CR
; *p++ = 
LF
;

1372  
NGX_CONF_OK
;

1373 
	}
}

1377 
	$ngx_ma_auth_h‰p
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1379 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
 = 
cÚf
;

1381 
ngx_¡r_t
 *
v®ue
;

1382 
ngx_u¾_t
 
u
;

1384 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1386 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

1388 
u
.
u¾
 = 
v®ue
[1];

1389 
u
.
deçuÉ_pÜt
 = 80;

1390 
u
.
uri_·¹
 = 1;

1391 
u
.
Úe_addr
 = 1;

1393 ià(
	`ngx_¡ºcmp
(
u
.
u¾
.
d©a
, "http://", 7) == 0) {

1394 
u
.
u¾
.
Ën
 -= 7;

1395 
u
.
u¾
.
d©a
 += 7;

1398 ià(
	`ngx_·r£_u¾
(
cf
->
poŞ
, &
u
è!ğ
NGX_OK
) {

1399 ià(
u
.
”r
) {

1400 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

1401 "% š‡uth_h‰°\"%V\"", 
u
.
”r
, &u.
u¾
);

1404  
NGX_CONF_ERROR
;

1407 
ahcf
->
³”
 = 
u
.
addrs
;

1409 ià(
u
.
çmy
 !ğ
AF_UNIX
) {

1410 
ahcf
->
ho¡_h—d”
 = 
u
.
ho¡
;

1413 
	`ngx_¡r_£t
(&
ahcf
->
ho¡_h—d”
, "localhost");

1416 
ahcf
->
uri
 = 
u
.uri;

1418 ià(
ahcf
->
uri
.
Ën
 == 0) {

1419 
	`ngx_¡r_£t
(&
ahcf
->
uri
, "/");

1422  
NGX_CONF_OK
;

1423 
	}
}

1427 
	$ngx_ma_auth_h‰p_h—d”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

1429 
ngx_ma_auth_h‰p_cÚf_t
 *
ahcf
 = 
cÚf
;

1431 
ngx_¡r_t
 *
v®ue
;

1432 
ngx_bË_–t_t
 *
h—d”
;

1434 ià(
ahcf
->
h—d”s
 =ğ
NULL
) {

1435 
ahcf
->
h—d”s
 = 
	`ngx_¬¿y_ü—‹
(
cf
->
poŞ
, 1, (
ngx_bË_–t_t
));

1436 ià(
ahcf
->
h—d”s
 =ğ
NULL
) {

1437  
NGX_CONF_ERROR
;

1441 
h—d”
 = 
	`ngx_¬¿y_push
(
ahcf
->
h—d”s
);

1442 ià(
h—d”
 =ğ
NULL
) {

1443  
NGX_CONF_ERROR
;

1446 
v®ue
 = 
cf
->
¬gs
->
–ts
;

1448 
h—d”
->
key
 = 
v®ue
[1];

1449 
h—d”
->
v®ue
 = value[2];

1451  
NGX_CONF_OK
;

1452 
	}
}

	@ngx_mail_core_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

14 *
ngx_ma_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
);

15 *
ngx_ma_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_ma_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chd
);

18 *
ngx_ma_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

19 *
cÚf
);

20 *
ngx_ma_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

21 *
cÚf
);

22 *
ngx_ma_cÜe_´ÙocŞ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

23 *
cÚf
);

24 *
ngx_ma_cÜe_»sŞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

25 *
cÚf
);

28 
ngx_commªd_t
 
	gngx_ma_cÜe_commªds
[] = {

30 { 
ngx_¡ršg
("server"),

31 
NGX_MAIL_MAIN_CONF
|
NGX_CONF_BLOCK
|
NGX_CONF_NOARGS
,

32 
ngx_ma_cÜe_£rv”
,

35 
NULL
 },

37 { 
ngx_¡ršg
("listen"),

38 
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE12
,

39 
ngx_ma_cÜe_li¡’
,

40 
NGX_MAIL_SRV_CONF_OFFSET
,

42 
NULL
 },

44 { 
ngx_¡ršg
("protocol"),

45 
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

46 
ngx_ma_cÜe_´ÙocŞ
,

47 
NGX_MAIL_SRV_CONF_OFFSET
,

49 
NULL
 },

51 { 
ngx_¡ršg
("so_keepalive"),

52 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

53 
ngx_cÚf_£t_æag_¦Ù
,

54 
NGX_MAIL_SRV_CONF_OFFSET
,

55 
off£tof
(
ngx_ma_cÜe_¤v_cÚf_t
, 
so_k“·live
),

56 
NULL
 },

58 { 
ngx_¡ršg
("timeout"),

59 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

60 
ngx_cÚf_£t_m£c_¦Ù
,

61 
NGX_MAIL_SRV_CONF_OFFSET
,

62 
off£tof
(
ngx_ma_cÜe_¤v_cÚf_t
, 
timeout
),

63 
NULL
 },

65 { 
ngx_¡ršg
("server_name"),

66 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

67 
ngx_cÚf_£t_¡r_¦Ù
,

68 
NGX_MAIL_SRV_CONF_OFFSET
,

69 
off£tof
(
ngx_ma_cÜe_¤v_cÚf_t
, 
£rv”_Çme
),

70 
NULL
 },

72 { 
ngx_¡ršg
("resolver"),

73 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

74 
ngx_ma_cÜe_»sŞv”
,

75 
NGX_MAIL_SRV_CONF_OFFSET
,

77 
NULL
 },

79 { 
ngx_¡ršg
("resolver_timeout"),

80 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

81 
ngx_cÚf_£t_m£c_¦Ù
,

82 
NGX_MAIL_SRV_CONF_OFFSET
,

83 
off£tof
(
ngx_ma_cÜe_¤v_cÚf_t
, 
»sŞv”_timeout
),

84 
NULL
 },

86 
ngx_nuÎ_commªd


90 
ngx_ma_moduË_t
 
	gngx_ma_cÜe_moduË_ùx
 = {

91 
NULL
,

93 
ngx_ma_cÜe_ü—‹_maš_cÚf
,

94 
NULL
,

96 
ngx_ma_cÜe_ü—‹_¤v_cÚf
,

97 
ngx_ma_cÜe_m”ge_¤v_cÚf


101 
ngx_moduË_t
 
	gngx_ma_cÜe_moduË
 = {

102 
NGX_MODULE_V1
,

103 &
ngx_ma_cÜe_moduË_ùx
,

104 
ngx_ma_cÜe_commªds
,

105 
NGX_MAIL_MODULE
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NULL
,

110 
NULL
,

111 
NULL
,

112 
NULL
,

113 
NGX_MODULE_V1_PADDING


118 
	$ngx_ma_cÜe_ü—‹_maš_cÚf
(
ngx_cÚf_t
 *
cf
)

120 
ngx_ma_cÜe_maš_cÚf_t
 *
cmcf
;

122 
cmcf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_cÜe_maš_cÚf_t
));

123 ià(
cmcf
 =ğ
NULL
) {

124  
NULL
;

127 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
£rv”s
, 
cf
->
poŞ
, 4,

128 (
ngx_ma_cÜe_¤v_cÚf_t
 *))

129 !ğ
NGX_OK
)

131  
NULL
;

134 ià(
	`ngx_¬¿y_š™
(&
cmcf
->
li¡’
, 
cf
->
poŞ
, 4, (
ngx_ma_li¡’_t
))

135 !ğ
NGX_OK
)

137  
NULL
;

140  
cmcf
;

141 
	}
}

145 
	$ngx_ma_cÜe_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

147 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

149 
cscf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_cÜe_¤v_cÚf_t
));

150 ià(
cscf
 =ğ
NULL
) {

151  
NULL
;

160 
cscf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

161 
cscf
->
»sŞv”_timeout
 = 
NGX_CONF_UNSET_MSEC
;

162 
cscf
->
so_k“·live
 = 
NGX_CONF_UNSET
;

164 
cscf
->
»sŞv”
 = 
NGX_CONF_UNSET_PTR
;

166 
cscf
->
fe_Çme
 = 
cf
->
cÚf_fe
->
fe
.
Çme
.
d©a
;

167 
cscf
->
lše
 = 
cf
->
cÚf_fe
->line;

169  
cscf
;

170 
	}
}

174 
	$ngx_ma_cÜe_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

176 
ngx_ma_cÜe_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

177 
ngx_ma_cÜe_¤v_cÚf_t
 *
cÚf
 = 
chd
;

179 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 60000);

180 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
»sŞv”_timeout
, 
´ev
->resolver_timeout,

183 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
so_k“·live
, 
´ev
->so_keepalive, 0);

186 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
£rv”_Çme
, 
´ev
->server_name, "");

188 ià(
cÚf
->
£rv”_Çme
.
Ën
 == 0) {

189 
cÚf
->
£rv”_Çme
 = 
cf
->
cyşe
->
ho¡Çme
;

192 ià(
cÚf
->
´ÙocŞ
 =ğ
NULL
) {

193 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

195 
cÚf
->
fe_Çme
, cÚf->
lše
);

196  
NGX_CONF_ERROR
;

199 
	`ngx_cÚf_m”ge_±r_v®ue
(
cÚf
->
»sŞv”
, 
´ev
->»sŞv”, 
NULL
);

201  
NGX_CONF_OK
;

202 
	}
}

206 
	$ngx_ma_cÜe_£rv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

208 *
rv
;

209 *
mcÚf
;

210 
ngx_ušt_t
 
m
;

211 
ngx_cÚf_t
 
pcf
;

212 
ngx_ma_moduË_t
 *
moduË
;

213 
ngx_ma_cÚf_ùx_t
 *
ùx
, *
ma_ùx
;

214 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
, **
cscå
;

215 
ngx_ma_cÜe_maš_cÚf_t
 *
cmcf
;

217 
ùx
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_cÚf_ùx_t
));

218 ià(
ùx
 =ğ
NULL
) {

219  
NGX_CONF_ERROR
;

222 
ma_ùx
 = 
cf
->
ùx
;

223 
ùx
->
maš_cÚf
 = 
ma_ùx
->main_conf;

227 
ùx
->
¤v_cÚf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (*è* 
ngx_ma_max_moduË
);

228 ià(
ùx
->
¤v_cÚf
 =ğ
NULL
) {

229  
NGX_CONF_ERROR
;

232 
m
 = 0; 
ngx_moduËs
[m]; m++) {

233 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

237 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

239 ià(
moduË
->
ü—‹_¤v_cÚf
) {

240 
mcÚf
 = 
moduË
->
	`ü—‹_¤v_cÚf
(
cf
);

241 ià(
mcÚf
 =ğ
NULL
) {

242  
NGX_CONF_ERROR
;

245 
ùx
->
¤v_cÚf
[
ngx_moduËs
[
m
]->
ùx_šdex
] = 
mcÚf
;

251 
cscf
 = 
ùx
->
¤v_cÚf
[
ngx_ma_cÜe_moduË
.
ùx_šdex
];

252 
cscf
->
ùx
 = ctx;

254 
cmcf
 = 
ùx
->
maš_cÚf
[
ngx_ma_cÜe_moduË
.
ùx_šdex
];

256 
cscå
 = 
	`ngx_¬¿y_push
(&
cmcf
->
£rv”s
);

257 ià(
cscå
 =ğ
NULL
) {

258  
NGX_CONF_ERROR
;

261 *
cscå
 = 
cscf
;

266 
pcf
 = *
cf
;

267 
cf
->
ùx
 = ctx;

268 
cf
->
cmd_ty³
 = 
NGX_MAIL_SRV_CONF
;

270 
rv
 = 
	`ngx_cÚf_·r£
(
cf
, 
NULL
);

272 *
cf
 = 
pcf
;

274  
rv
;

275 
	}
}

279 
	$ngx_ma_cÜe_li¡’
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

281 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

283 
size_t
 
Ën
, 
off
;

284 
š_pÜt_t
 
pÜt
;

285 
ngx_¡r_t
 *
v®ue
;

286 
ngx_u¾_t
 
u
;

287 
ngx_ušt_t
 
i
, 
m
;

288 
sockaddr
 *
§
;

289 
ngx_ma_li¡’_t
 *
ls
;

290 
ngx_ma_moduË_t
 *
moduË
;

291 
sockaddr_š
 *
sš
;

292 
ngx_ma_cÜe_maš_cÚf_t
 *
cmcf
;

293 #ià(
NGX_HAVE_INET6
)

294 
sockaddr_š6
 *
sš6
;

297 
v®ue
 = 
cf
->
¬gs
->
–ts
;

299 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

301 
u
.
u¾
 = 
v®ue
[1];

302 
u
.
li¡’
 = 1;

304 ià(
	`ngx_·r£_u¾
(
cf
->
poŞ
, &
u
è!ğ
NGX_OK
) {

305 ià(
u
.
”r
) {

306 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

308 
u
.
”r
, &u.
u¾
);

311  
NGX_CONF_ERROR
;

314 
cmcf
 = 
	`ngx_ma_cÚf_g‘_moduË_maš_cÚf
(
cf
, 
ngx_ma_cÜe_moduË
);

316 
ls
 = 
cmcf
->
li¡’
.
–ts
;

318 
i
 = 0; i < 
cmcf
->
li¡’
.
ÃÉs
; i++) {

320 
§
 = (
sockaddr
 *è
ls
[
i
].sockaddr;

322 ià(
§
->
§_çmy
 !ğ
u
.
çmy
) {

326 
§
->
§_çmy
) {

328 #ià(
NGX_HAVE_INET6
)

329 
AF_INET6
:

330 
off
 = 
	`off£tof
(
sockaddr_š6
, 
sš6_addr
);

331 
Ën
 = 16;

332 
sš6
 = (
sockaddr_š6
 *è
§
;

333 
pÜt
 = 
sš6
->
sš6_pÜt
;

338 
off
 = 
	`off£tof
(
sockaddr_š
, 
sš_addr
);

339 
Ën
 = 4;

340 
sš
 = (
sockaddr_š
 *è
§
;

341 
pÜt
 = 
sš
->
sš_pÜt
;

345 ià(
	`ngx_memcmp
(
ls
[
i
].
sockaddr
 + 
off
, 
u
.sockadd¸+ off, 
Ën
) != 0) {

349 ià(
pÜt
 !ğ
u
.port) {

353 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

354 "du¶iÿ‹ \"%V\"‡dd»s ªd…Üˆ·œ", &
u
.
u¾
);

355  
NGX_CONF_ERROR
;

358 
ls
 = 
	`ngx_¬¿y_push
(&
cmcf
->
li¡’
);

359 ià(
ls
 =ğ
NULL
) {

360  
NGX_CONF_ERROR
;

363 
	`ngx_memz”o
(
ls
, (
ngx_ma_li¡’_t
));

365 
	`ngx_memıy
(
ls
->
sockaddr
, 
u
.sockaddr, u.
sockËn
);

367 
ls
->
sockËn
 = 
u
.socklen;

368 
ls
->
wdÿrd
 = 
u
.wildcard;

369 
ls
->
ùx
 = 
cf
->ctx;

371 
m
 = 0; 
ngx_moduËs
[m]; m++) {

372 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

376 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

378 ià(
moduË
->
´ÙocŞ
 =ğ
NULL
) {

382 
i
 = 0; 
moduË
->
´ÙocŞ
->
pÜt
[i]; i++) {

383 ià(
moduË
->
´ÙocŞ
->
pÜt
[
i
] =ğ
u
.port) {

384 
cscf
->
´ÙocŞ
 = 
moduË
->protocol;

390 
i
 = 2; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

392 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "bind") == 0) {

393 
ls
->
bšd
 = 1;

397 ià(
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "ipv6only=o", 10) == 0) {

398 #ià(
NGX_HAVE_INET6
 && 
defšed
 
IPV6_V6ONLY
)

399 
sockaddr
 *
§
;

400 
u_ch¬
 
buf
[
NGX_SOCKADDR_STRLEN
];

402 
§
 = (
sockaddr
 *è
ls
->sockaddr;

404 ià(
§
->
§_çmy
 =ğ
AF_INET6
) {

406 ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[10], "n") == 0) {

407 
ls
->
v6Úly
 = 1;

409 } ià(
	`ngx_¡rcmp
(&
v®ue
[
i
].
d©a
[10], "ff") == 0) {

410 
ls
->
v6Úly
 = 2;

413 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

415 &
v®ue
[
i
].
d©a
[9]);

416  
NGX_CONF_ERROR
;

419 
ls
->
bšd
 = 1;

422 
Ën
 = 
	`ngx_sock_Áİ
(
§
, 
buf
, 
NGX_SOCKADDR_STRLEN
, 1);

424 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

426 "Ú‡dd¸\"%*s\", ignÜed", 
Ën
, 
buf
);

431 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

434  
NGX_CONF_ERROR
;

438 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "ssl") == 0) {

439 #ià(
NGX_MAIL_SSL
)

440 
ls
->
s¦
 = 1;

443 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

446  
NGX_CONF_ERROR
;

450 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

451 "thšv®id \"%V\"…¬am‘”", &
v®ue
[
i
]);

452  
NGX_CONF_ERROR
;

455  
NGX_CONF_OK
;

456 
	}
}

460 
	$ngx_ma_cÜe_´ÙocŞ
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

462 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

464 
ngx_¡r_t
 *
v®ue
;

465 
ngx_ušt_t
 
m
;

466 
ngx_ma_moduË_t
 *
moduË
;

468 
v®ue
 = 
cf
->
¬gs
->
–ts
;

470 
m
 = 0; 
ngx_moduËs
[m]; m++) {

471 ià(
ngx_moduËs
[
m
]->
ty³
 !ğ
NGX_MAIL_MODULE
) {

475 
moduË
 = 
ngx_moduËs
[
m
]->
ùx
;

477 ià(
moduË
->
´ÙocŞ


478 && 
	`ngx_¡rcmp
(
moduË
->
´ÙocŞ
->
Çme
.
d©a
, 
v®ue
[1].data) == 0)

480 
cscf
->
´ÙocŞ
 = 
moduË
->protocol;

482  
NGX_CONF_OK
;

486 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

487 "unknowÀ´ÙocŞ \"%V\"", &
v®ue
[1]);

488  
NGX_CONF_ERROR
;

489 
	}
}

493 
	$ngx_ma_cÜe_»sŞv”
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

495 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
 = 
cÚf
;

497 
ngx_u¾_t
 
u
;

498 
ngx_¡r_t
 *
v®ue
;

500 
v®ue
 = 
cf
->
¬gs
->
–ts
;

502 ià(
cscf
->
»sŞv”
 !ğ
NGX_CONF_UNSET_PTR
) {

506 ià(
	`ngx_¡rcmp
(
v®ue
[1].
d©a
, "off") == 0) {

507 
cscf
->
»sŞv”
 = 
NULL
;

508  
NGX_CONF_OK
;

511 
	`ngx_memz”o
(&
u
, (
ngx_u¾_t
));

513 
u
.
ho¡
 = 
v®ue
[1];

514 
u
.
pÜt
 = 53;

516 ià(
	`ngx_š‘_»sŞve_ho¡
(
cf
->
poŞ
, &
u
è!ğ
NGX_OK
) {

517 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0, "%V: %s", &
u
.
ho¡
, u.
”r
);

518  
NGX_CONF_ERROR
;

521 
cscf
->
»sŞv”
 = 
	`ngx_»sŞv”_ü—‹
(
cf
, &
u
.
addrs
[0]);

522 ià(
cscf
->
»sŞv”
 =ğ
NULL
) {

523  
NGX_CONF_OK
;

526  
NGX_CONF_OK
;

527 
	}
}

531 
	$ngx_ma_ÿ·b™›s
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

533 *
p
 = 
cÚf
;

535 
ngx_¡r_t
 *
c
, *
v®ue
;

536 
ngx_ušt_t
 
i
;

537 
ngx_¬¿y_t
 *
a
;

539 
a
 = (
ngx_¬¿y_t
 *è(
p
 + 
cmd
->
off£t
);

541 
v®ue
 = 
cf
->
¬gs
->
–ts
;

543 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

544 
c
 = 
	`ngx_¬¿y_push
(
a
);

545 ià(
c
 =ğ
NULL
) {

546  
NGX_CONF_ERROR
;

549 *
c
 = 
v®ue
[
i
];

552  
NGX_CONF_OK
;

553 
	}
}

	@ngx_mail_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

14 
ngx_ma_š™_£ssiÚ
(
ngx_cÚÃùiÚ_t
 *
c
);

16 #ià(
NGX_MAIL_SSL
)

17 
ngx_ma_s¦_š™_cÚÃùiÚ
(
ngx_s¦_t
 *
s¦
, 
ngx_cÚÃùiÚ_t
 *
c
);

18 
ngx_ma_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
);

23 
	$ngx_ma_š™_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

25 
ngx_ušt_t
 
i
;

26 
ngx_ma_pÜt_t
 *
pÜt
;

27 
sockaddr
 *
§
;

28 
sockaddr_š
 *
sš
;

29 
ngx_ma_log_ùx_t
 *
ùx
;

30 
ngx_ma_š_addr_t
 *
addr
;

31 
ngx_ma_£ssiÚ_t
 *
s
;

32 
ngx_ma_addr_cÚf_t
 *
addr_cÚf
;

33 #ià(
NGX_HAVE_INET6
)

34 
sockaddr_š6
 *
sš6
;

35 
ngx_ma_š6_addr_t
 *
addr6
;

43 
pÜt
 = 
c
->
li¡’šg
->
£rv”s
;

45 ià(
pÜt
->
Çddrs
 > 1) {

55 ià(
	`ngx_cÚÃùiÚ_loÿl_sockaddr
(
c
, 
NULL
, 0è!ğ
NGX_OK
) {

56 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

60 
§
 = 
c
->
loÿl_sockaddr
;

62 
§
->
§_çmy
) {

64 #ià(
NGX_HAVE_INET6
)

65 
AF_INET6
:

66 
sš6
 = (
sockaddr_š6
 *è
§
;

68 
addr6
 = 
pÜt
->
addrs
;

72 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

73 ià(
	`ngx_memcmp
(&
addr6
[
i
].addr6, &
sš6
->
sš6_addr
, 16) == 0) {

78 
addr_cÚf
 = &
addr6
[
i
].
cÚf
;

84 
sš
 = (
sockaddr_š
 *è
§
;

86 
addr
 = 
pÜt
->
addrs
;

90 
i
 = 0; i < 
pÜt
->
Çddrs
 - 1; i++) {

91 ià(
addr
[
i
].add¸=ğ
sš
->
sš_addr
.
s_addr
) {

96 
addr_cÚf
 = &
addr
[
i
].
cÚf
;

102 
c
->
loÿl_sockaddr
->
§_çmy
) {

104 #ià(
NGX_HAVE_INET6
)

105 
AF_INET6
:

106 
addr6
 = 
pÜt
->
addrs
;

107 
addr_cÚf
 = &
addr6
[0].
cÚf
;

112 
addr
 = 
pÜt
->
addrs
;

113 
addr_cÚf
 = &
addr
[0].
cÚf
;

118 
s
 = 
	`ngx_pÿÎoc
(
c
->
poŞ
, (
ngx_ma_£ssiÚ_t
));

119 ià(
s
 =ğ
NULL
) {

120 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

124 
s
->
maš_cÚf
 = 
addr_cÚf
->
ùx
->main_conf;

125 
s
->
¤v_cÚf
 = 
addr_cÚf
->
ùx
->srv_conf;

127 
s
->
addr_‹xt
 = &
addr_cÚf
->addr_text;

129 
c
->
d©a
 = 
s
;

130 
s
->
cÚÃùiÚ
 = 
c
;

132 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "*%ui client %V connectedo %V",

133 
c
->
numb”
, &c->
addr_‹xt
, 
s
->addr_text);

135 
ùx
 = 
	`ngx_·Îoc
(
c
->
poŞ
, (
ngx_ma_log_ùx_t
));

136 ià(
ùx
 =ğ
NULL
) {

137 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

141 
ùx
->
ş›Á
 = &
c
->
addr_‹xt
;

142 
ùx
->
£ssiÚ
 = 
s
;

144 
c
->
log
->
cÚÃùiÚ
 = c->
numb”
;

145 
c
->
log
->
hªdËr
 = 
ngx_ma_log_”rÜ
;

146 
c
->
log
->
d©a
 = 
ùx
;

147 
c
->
log
->
aùiÚ
 = "sending client greeting†ine";

149 
c
->
log_”rÜ
 = 
NGX_ERROR_INFO
;

151 #ià(
NGX_MAIL_SSL
)

153 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

155 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

157 ià(
s¦cf
->
’abË
) {

158 
c
->
log
->
aùiÚ
 = "SSL handshaking";

160 
	`ngx_ma_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

164 ià(
addr_cÚf
->
s¦
) {

166 
c
->
log
->
aùiÚ
 = "SSL handshaking";

168 ià(
s¦cf
->
s¦
.
ùx
 =ğ
NULL
) {

169 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

172 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

176 
	`ngx_ma_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

183 
	`ngx_ma_š™_£ssiÚ
(
c
);

184 
	}
}

187 #ià(
NGX_MAIL_SSL
)

190 
	$ngx_ma_¡¬‰ls_hªdËr
(
ngx_ev’t_t
 *
»v
)

192 
ngx_cÚÃùiÚ_t
 *
c
;

193 
ngx_ma_£ssiÚ_t
 *
s
;

194 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

196 
c
 = 
»v
->
d©a
;

197 
s
 = 
c
->
d©a
;

198 
s
->
¡¬‰ls
 = 1;

200 
c
->
log
->
aùiÚ
 = "in starttls state";

202 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

204 
	`ngx_ma_s¦_š™_cÚÃùiÚ
(&
s¦cf
->
s¦
, 
c
);

205 
	}
}

209 
	$ngx_ma_s¦_š™_cÚÃùiÚ
(
ngx_s¦_t
 *
s¦
, 
ngx_cÚÃùiÚ_t
 *
c
)

211 
ngx_ma_£ssiÚ_t
 *
s
;

212 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

214 ià(
	`ngx_s¦_ü—‹_cÚÃùiÚ
(
s¦
, 
c
, 0è=ğ
NGX_ERROR
) {

215 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

219 ià(
	`ngx_s¦_hªdshake
(
c
è=ğ
NGX_AGAIN
) {

221 
s
 = 
c
->
d©a
;

223 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

225 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

227 
c
->
s¦
->
hªdËr
 = 
ngx_ma_s¦_hªdshake_hªdËr
;

232 
	`ngx_ma_s¦_hªdshake_hªdËr
(
c
);

233 
	}
}

237 
	$ngx_ma_s¦_hªdshake_hªdËr
(
ngx_cÚÃùiÚ_t
 *
c
)

239 
ngx_ma_£ssiÚ_t
 *
s
;

240 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

242 ià(
c
->
s¦
->
hªdshaked
) {

244 
s
 = 
c
->
d©a
;

246 ià(
s
->
¡¬‰ls
) {

247 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

249 
c
->
»ad
->
hªdËr
 = 
cscf
->
´ÙocŞ
->
š™_´ÙocŞ
;

250 
c
->
wr™e
->
hªdËr
 = 
ngx_ma_£nd
;

252 
cscf
->
´ÙocŞ
->
	`š™_´ÙocŞ
(
c
->
»ad
);

257 
c
->
»ad
->
»ady
 = 0;

259 
	`ngx_ma_š™_£ssiÚ
(
c
);

263 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

264 
	}
}

270 
	$ngx_ma_š™_£ssiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

272 
ngx_ma_£ssiÚ_t
 *
s
;

273 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

275 
s
 = 
c
->
d©a
;

277 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

279 
s
->
´ÙocŞ
 = 
cscf
->´ÙocŞ->
ty³
;

281 
s
->
ùx
 = 
	`ngx_pÿÎoc
(
c
->
poŞ
, (*è* 
ngx_ma_max_moduË
);

282 ià(
s
->
ùx
 =ğ
NULL
) {

283 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

287 
c
->
wr™e
->
hªdËr
 = 
ngx_ma_£nd
;

289 
cscf
->
´ÙocŞ
->
	`š™_£ssiÚ
(
s
, 
c
);

290 
	}
}

293 
ngx_št_t


294 
	$ngx_ma_§É
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

295 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
)

297 
s
->
§É
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,

298 (" <18446744073709551616.@>" 
CRLF
) - 1

299 + 
NGX_TIME_T_LEN


300 + 
cscf
->
£rv”_Çme
.
Ën
);

301 ià(
s
->
§É
.
d©a
 =ğ
NULL
) {

302  
NGX_ERROR
;

305 
s
->
§É
.
Ën
 = 
	`ngx_¥rštf
(s->§É.
d©a
, "<%ul.%T@%V>" 
CRLF
,

306 
	`ngx_¿ndom
(), 
	`ngx_time
(), &
cscf
->
£rv”_Çme
)

307 - 
s
->
§É
.
d©a
;

309  
NGX_OK
;

310 
	}
}

313 #ià(
NGX_MAIL_SSL
)

315 
ngx_št_t


316 
	$ngx_ma_¡¬‰ls_Úly
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

318 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

320 ià(
c
->
s¦
) {

324 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

326 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ONLY
) {

331 
	}
}

336 
ngx_št_t


337 
	$ngx_ma_auth_¶aš
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_ušt_t
 
n
)

339 
u_ch¬
 *
p
, *
Ï¡
;

340 
ngx_¡r_t
 *
¬g
, 
¶aš
;

342 
¬g
 = 
s
->
¬gs
.
–ts
;

344 #ià(
NGX_DEBUG_MAIL_PASSWD
)

345 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

346 "ma‡uth…Ïš: \"%V\"", &
¬g
[
n
]);

349 
¶aš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[
n
].
Ën
));

350 ià(
¶aš
.
d©a
 =ğ
NULL
) {

351  
NGX_ERROR
;

354 ià(
	`ngx_decode_ba£64
(&
¶aš
, &
¬g
[
n
]è!ğ
NGX_OK
) {

355 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

357  
NGX_MAIL_PARSE_INVALID_COMMAND
;

360 
p
 = 
¶aš
.
d©a
;

361 
Ï¡
 = 
p
 + 
¶aš
.
Ën
;

363 
p
 < 
Ï¡
 && *p++) { }

365 ià(
p
 =ğ
Ï¡
) {

366 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

368  
NGX_MAIL_PARSE_INVALID_COMMAND
;

371 
s
->
logš
.
d©a
 = 
p
;

373 
p
 < 
Ï¡
 && *p) {…++; }

375 ià(
p
 =ğ
Ï¡
) {

376 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

378  
NGX_MAIL_PARSE_INVALID_COMMAND
;

381 
s
->
logš
.
Ën
 = 
p
++ - s->logš.
d©a
;

383 
s
->
·sswd
.
Ën
 = 
Ï¡
 - 
p
;

384 
s
->
·sswd
.
d©a
 = 
p
;

386 #ià(
NGX_DEBUG_MAIL_PASSWD
)

387 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

388 "ma‡uth…Ïš: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

391  
NGX_DONE
;

392 
	}
}

395 
ngx_št_t


396 
	$ngx_ma_auth_logš_u£ºame
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

397 
ngx_ušt_t
 
n
)

399 
ngx_¡r_t
 *
¬g
;

401 
¬g
 = 
s
->
¬gs
.
–ts
;

403 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

404 "ma‡uth†ogš u£ºame: \"%V\"", &
¬g
[
n
]);

406 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[
n
].
Ën
));

407 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

408  
NGX_ERROR
;

411 ià(
	`ngx_decode_ba£64
(&
s
->
logš
, &
¬g
[
n
]è!ğ
NGX_OK
) {

412 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

414  
NGX_MAIL_PARSE_INVALID_COMMAND
;

417 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

418 "ma‡uth†ogš u£ºame: \"%V\"", &
s
->
logš
);

420  
NGX_OK
;

421 
	}
}

424 
ngx_št_t


425 
	$ngx_ma_auth_logš_·sswÜd
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

427 
ngx_¡r_t
 *
¬g
;

429 
¬g
 = 
s
->
¬gs
.
–ts
;

431 #ià(
NGX_DEBUG_MAIL_PASSWD
)

432 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

433 "ma‡uth†ogš…asswÜd: \"%V\"", &
¬g
[0]);

436 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,

437 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[0].
Ën
));

438 ià(
s
->
·sswd
.
d©a
 =ğ
NULL
) {

439  
NGX_ERROR
;

442 ià(
	`ngx_decode_ba£64
(&
s
->
·sswd
, &
¬g
[0]è!ğ
NGX_OK
) {

443 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

445  
NGX_MAIL_PARSE_INVALID_COMMAND
;

448 #ià(
NGX_DEBUG_MAIL_PASSWD
)

449 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

450 "ma‡uth†ogš…asswÜd: \"%V\"", &
s
->
·sswd
);

453  
NGX_DONE
;

454 
	}
}

457 
ngx_št_t


458 
	$ngx_ma_auth_üam_md5_§É
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

459 *
´efix
, 
size_t
 
Ën
)

461 
u_ch¬
 *
p
;

462 
ngx_¡r_t
 
§É
;

463 
ngx_ušt_t
 
n
;

465 
p
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
Ën
 + 
	`ngx_ba£64_’coded_Ëngth
(
s
->
§É
.len) + 2);

466 ià(
p
 =ğ
NULL
) {

467  
NGX_ERROR
;

470 
§É
.
d©a
 = 
	`ngx_ıymem
(
p
, 
´efix
, 
Ën
);

471 
s
->
§É
.
Ën
 -= 2;

473 
	`ngx_’code_ba£64
(&
§É
, &
s
->salt);

475 
s
->
§É
.
Ën
 += 2;

476 
n
 = 
Ën
 + 
§É
.len;

477 
p
[
n
++] = 
CR
;…[n++] = 
LF
;

479 
s
->
out
.
Ën
 = 
n
;

480 
s
->
out
.
d©a
 = 
p
;

482  
NGX_OK
;

483 
	}
}

486 
ngx_št_t


487 
	$ngx_ma_auth_üam_md5
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

489 
u_ch¬
 *
p
, *
Ï¡
;

490 
ngx_¡r_t
 *
¬g
;

492 
¬g
 = 
s
->
¬gs
.
–ts
;

494 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

495 "ma‡uth c¿m-md5: \"%V\"", &
¬g
[0]);

497 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
	`ngx_ba£64_decoded_Ëngth
(
¬g
[0].
Ën
));

498 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

499  
NGX_ERROR
;

502 ià(
	`ngx_decode_ba£64
(&
s
->
logš
, &
¬g
[0]è!ğ
NGX_OK
) {

503 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

505  
NGX_MAIL_PARSE_INVALID_COMMAND
;

508 
p
 = 
s
->
logš
.
d©a
;

509 
Ï¡
 = 
p
 + 
s
->
logš
.
Ën
;

511 
p
 < 
Ï¡
) {

512 ià(*
p
++ == ' ') {

513 
s
->
logš
.
Ën
 = 
p
 - s->logš.
d©a
 - 1;

514 
s
->
·sswd
.
Ën
 = 
Ï¡
 - 
p
;

515 
s
->
·sswd
.
d©a
 = 
p
;

520 ià(
s
->
·sswd
.
Ën
 != 32) {

521 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

523  
NGX_MAIL_PARSE_INVALID_COMMAND
;

526 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

527 "ma‡uth c¿m-md5: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

529 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_CRAM_MD5
;

531  
NGX_DONE
;

532 
	}
}

536 
	$ngx_ma_£nd
(
ngx_ev’t_t
 *
wev
)

538 
ngx_št_t
 
n
;

539 
ngx_cÚÃùiÚ_t
 *
c
;

540 
ngx_ma_£ssiÚ_t
 *
s
;

541 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

543 
c
 = 
wev
->
d©a
;

544 
s
 = 
c
->
d©a
;

546 ià(
wev
->
timedout
) {

547 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

548 
c
->
timedout
 = 1;

549 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

553 ià(
s
->
out
.
Ën
 == 0) {

554 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ğ
NGX_OK
) {

555 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

561 
n
 = 
c
->
	`£nd
(c, 
s
->
out
.
d©a
, s->out.
Ën
);

563 ià(
n
 > 0) {

564 
s
->
out
.
Ën
 -ğ
n
;

566 ià(
wev
->
tim”_£t
) {

567 
	`ngx_d–_tim”
(
wev
);

570 ià(
s
->
qu™
) {

571 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

575 ià(
s
->
blocked
) {

576 
c
->
»ad
->
	`hªdËr
(c->read);

582 ià(
n
 =ğ
NGX_ERROR
) {

583 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

589 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

591 
	`ngx_add_tim”
(
c
->
wr™e
, 
cscf
->
timeout
);

593 ià(
	`ngx_hªdË_wr™e_ev’t
(
c
->
wr™e
, 0è!ğ
NGX_OK
) {

594 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

597 
	}
}

600 
ngx_št_t


601 
	$ngx_ma_»ad_commªd
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

603 
ssize_t
 
n
;

604 
ngx_št_t
 
rc
;

605 
ngx_¡r_t
 
l
;

606 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

608 
n
 = 
c
->
	`»cv
(c, 
s
->
bufãr
->
Ï¡
, s->bufãr->
’d
 - s->buffer->last);

610 ià(
n
 =ğ
NGX_ERROR
 ||‚ == 0) {

611 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

612  
NGX_ERROR
;

615 ià(
n
 > 0) {

616 
s
->
bufãr
->
Ï¡
 +ğ
n
;

619 ià(
n
 =ğ
NGX_AGAIN
) {

620 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

621 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

622  
NGX_ERROR
;

625  
NGX_AGAIN
;

628 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

630 
rc
 = 
cscf
->
´ÙocŞ
->
	`·r£_commªd
(
s
);

632 ià(
rc
 =ğ
NGX_AGAIN
) {

634 ià(
s
->
bufãr
->
Ï¡
 < s->bufãr->
’d
) {

635  
rc
;

638 
l
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

639 
l
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

641 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0,

642 "ş›Á s’ˆtoØlÚg commªd \"%V\"", &
l
);

644 
s
->
qu™
 = 1;

646  
NGX_MAIL_PARSE_INVALID_COMMAND
;

649 ià(
rc
 =ğ
NGX_IMAP_NEXT
 ||„ø=ğ
NGX_MAIL_PARSE_INVALID_COMMAND
) {

650  
rc
;

653 ià(
rc
 =ğ
NGX_ERROR
) {

654 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

655  
NGX_ERROR
;

658  
NGX_OK
;

659 
	}
}

663 
	$ngx_ma_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

665 
s
->
¬gs
.
ÃÉs
 = 0;

666 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

667 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

668 
s
->
¡©e
 = 0;

670 ià(
c
->
»ad
->
tim”_£t
) {

671 
	`ngx_d–_tim”
(
c
->
»ad
);

674 
s
->
logš_©‹m±
++;

676 
	`ngx_ma_auth_h‰p_š™
(
s
);

677 
	}
}

681 
	$ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
)

683 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

685 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

687 
s
->
out
 = 
cscf
->
´ÙocŞ
->
š‹º®_£rv”_”rÜ
;

688 
s
->
qu™
 = 1;

690 
	`ngx_ma_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

691 
	}
}

695 
	$ngx_ma_şo£_cÚÃùiÚ
(
ngx_cÚÃùiÚ_t
 *
c
)

697 
ngx_poŞ_t
 *
poŞ
;

699 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

700 "şo£ ma cÚÃùiÚ: %d", 
c
->
fd
);

702 #ià(
NGX_MAIL_SSL
)

704 ià(
c
->
s¦
) {

705 ià(
	`ngx_s¦_shutdown
(
c
è=ğ
NGX_AGAIN
) {

706 
c
->
s¦
->
hªdËr
 = 
ngx_ma_şo£_cÚÃùiÚ
;

713 #ià(
NGX_STAT_STUB
)

714 (è
	`ngx_©omic_ãtch_add
(
ngx_¡©_aùive
, -1);

717 
c
->
de¡royed
 = 1;

719 
poŞ
 = 
c
->pool;

721 
	`ngx_şo£_cÚÃùiÚ
(
c
);

723 
	`ngx_de¡roy_poŞ
(
poŞ
);

724 
	}
}

727 
u_ch¬
 *

728 
	$ngx_ma_log_”rÜ
(
ngx_log_t
 *
log
, 
u_ch¬
 *
buf
, 
size_t
 
Ën
)

730 
u_ch¬
 *
p
;

731 
ngx_ma_£ssiÚ_t
 *
s
;

732 
ngx_ma_log_ùx_t
 *
ùx
;

734 ià(
log
->
aùiÚ
) {

735 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, " wh%s", 
log
->
aùiÚ
);

736 
Ën
 -ğ
p
 - 
buf
;

737 
buf
 = 
p
;

740 
ùx
 = 
log
->
d©a
;

742 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", cl›Á: %V", 
ùx
->
ş›Á
);

743 
Ën
 -ğ
p
 - 
buf
;

744 
buf
 = 
p
;

746 
s
 = 
ùx
->
£ssiÚ
;

748 ià(
s
 =ğ
NULL
) {

749  
p
;

752 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, "%s, server: %V",

753 
s
->
¡¬‰ls
 ? " using starttls" : "",

754 
s
->
addr_‹xt
);

755 
Ën
 -ğ
p
 - 
buf
;

756 
buf
 = 
p
;

758 ià(
s
->
logš
.
Ën
 == 0) {

759  
p
;

762 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ",†ogš: \"%V\"", &
s
->
logš
);

763 
Ën
 -ğ
p
 - 
buf
;

764 
buf
 = 
p
;

766 ià(
s
->
´oxy
 =ğ
NULL
) {

767  
p
;

770 
p
 = 
	`ngx_¢´štf
(
buf
, 
Ën
, ", up¡»am: %V", 
s
->
´oxy
->
up¡»am
.
Çme
);

772  
p
;

773 
	}
}

	@ngx_mail_imap_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_im­_moduË.h
>

15 
ngx_št_t
 
ngx_ma_im­_logš
(
ngx_ma_£ssiÚ_t
 *
s
,

16 
ngx_cÚÃùiÚ_t
 *
c
);

17 
ngx_št_t
 
ngx_ma_im­_auth’tiÿ‹
(
ngx_ma_£ssiÚ_t
 *
s
,

18 
ngx_cÚÃùiÚ_t
 *
c
);

19 
ngx_št_t
 
ngx_ma_im­_ÿ·b™y
(
ngx_ma_£ssiÚ_t
 *
s
,

20 
ngx_cÚÃùiÚ_t
 *
c
);

21 
ngx_št_t
 
ngx_ma_im­_¡¬‰ls
(
ngx_ma_£ssiÚ_t
 *
s
,

22 
ngx_cÚÃùiÚ_t
 *
c
);

25 
u_ch¬
 
	gim­_g»‘šg
[] = "* OK IMAP4„—dy" 
CRLF
;

26 
u_ch¬
 
	gim­_¡¬
[] = "* ";

27 
u_ch¬
 
	gim­_ok
[] = "OK com¶‘ed" 
CRLF
;

28 
u_ch¬
 
	gim­_Ãxt
[] = "+ OK" 
CRLF
;

29 
u_ch¬
 
	gim­_¶aš_Ãxt
[] = "+ " 
CRLF
;

30 
u_ch¬
 
	gim­_u£ºame
[] = "+ VXNlcm5hbWU6" 
CRLF
;

31 
u_ch¬
 
	gim­_·sswÜd
[] = "+ UGFzc3dvcmQ6" 
CRLF
;

32 
u_ch¬
 
	gim­_bye
[] = "* BYE" 
CRLF
;

33 
u_ch¬
 
	gim­_šv®id_commªd
[] = "BAD inv®id commªd" 
CRLF
;

37 
	$ngx_ma_im­_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

39 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

41 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

43 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_g»‘šg
);

45 
c
->
»ad
->
hªdËr
 = 
ngx_ma_im­_š™_´ÙocŞ
;

47 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

49 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

50 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

53 
	`ngx_ma_£nd
(
c
->
wr™e
);

54 
	}
}

58 
	$ngx_ma_im­_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
)

60 
ngx_cÚÃùiÚ_t
 *
c
;

61 
ngx_ma_£ssiÚ_t
 *
s
;

62 
ngx_ma_im­_¤v_cÚf_t
 *
iscf
;

64 
c
 = 
»v
->
d©a
;

66 
c
->
log
->
aùiÚ
 = "in‡uth state";

68 ià(
»v
->
timedout
) {

69 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

70 
c
->
timedout
 = 1;

71 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

75 
s
 = 
c
->
d©a
;

77 ià(
s
->
bufãr
 =ğ
NULL
) {

78 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poŞ
, 2, (
ngx_¡r_t
))

79 =ğ
NGX_ERROR
)

81 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

85 
iscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_im­_moduË
);

87 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poŞ
, 
iscf
->
ş›Á_bufãr_size
);

88 ià(
s
->
bufãr
 =ğ
NULL
) {

89 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

94 
s
->
ma_¡©e
 = 
ngx_im­_¡¬t
;

95 
c
->
»ad
->
hªdËr
 = 
ngx_ma_im­_auth_¡©e
;

97 
	`ngx_ma_im­_auth_¡©e
(
»v
);

98 
	}
}

102 
	$ngx_ma_im­_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

104 
u_ch¬
 *
p
, *
d¡
, *
¤c
, *
’d
;

105 
ngx_¡r_t
 *
¬g
;

106 
ngx_št_t
 
rc
;

107 
ngx_ušt_t
 
g
, 
i
;

108 
ngx_cÚÃùiÚ_t
 *
c
;

109 
ngx_ma_£ssiÚ_t
 *
s
;

111 
c
 = 
»v
->
d©a
;

112 
s
 = 
c
->
d©a
;

114 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap‡uth state");

116 ià(
»v
->
timedout
) {

117 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

118 
c
->
timedout
 = 1;

119 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

123 ià(
s
->
out
.
Ën
) {

124 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap send handler busy");

125 
s
->
blocked
 = 1;

129 
s
->
blocked
 = 0;

131 
rc
 = 
	`ngx_ma_»ad_commªd
(
s
, 
c
);

133 ià(
rc
 =ğ
NGX_AGAIN
 ||„ø=ğ
NGX_ERROR
) {

137 
g
 = 1;

138 
s
->
‹xt
.
Ën
 = 0;

139 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_ok
);

141 ià(
rc
 =ğ
NGX_OK
) {

143 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "imap‡uth command: %i",

144 
s
->
commªd
);

146 ià(
s
->
back¦ash
) {

148 
¬g
 = 
s
->
¬gs
.
–ts
;

150 
i
 = 0; i < 
s
->
¬gs
.
ÃÉs
; i++) {

151 
d¡
 = 
¬g
[
i
].
d©a
;

152 
’d
 = 
d¡
 + 
¬g
[
i
].
Ën
;

154 
¤c
 = 
d¡
; srø< 
’d
; dst++) {

155 *
d¡
 = *
¤c
;

156 ià(*
¤c
++ == '\\') {

157 *
d¡
 = *
¤c
++;

161 
¬g
[
i
].
Ën
 = 
d¡
 -‡rg[i].
d©a
;

164 
s
->
back¦ash
 = 0;

167 
s
->
ma_¡©e
) {

169 
ngx_im­_¡¬t
:

171 
s
->
commªd
) {

173 
NGX_IMAP_LOGIN
:

174 
rc
 = 
	`ngx_ma_im­_logš
(
s
, 
c
);

177 
NGX_IMAP_AUTHENTICATE
:

178 
rc
 = 
	`ngx_ma_im­_auth’tiÿ‹
(
s
, 
c
);

179 
g
 = (
rc
 !ğ
NGX_OK
);

182 
NGX_IMAP_CAPABILITY
:

183 
rc
 = 
	`ngx_ma_im­_ÿ·b™y
(
s
, 
c
);

186 
NGX_IMAP_LOGOUT
:

187 
s
->
qu™
 = 1;

188 
	`ngx_¡r_£t
(&
s
->
‹xt
, 
im­_bye
);

191 
NGX_IMAP_NOOP
:

194 
NGX_IMAP_STARTTLS
:

195 
rc
 = 
	`ngx_ma_im­_¡¬‰ls
(
s
, 
c
);

199 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

205 
ngx_im­_auth_logš_u£ºame
:

206 
rc
 = 
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 0);

208 
g
 = 0;

209 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_·sswÜd
);

210 
s
->
ma_¡©e
 = 
ngx_im­_auth_logš_·sswÜd
;

214 
ngx_im­_auth_logš_·sswÜd
:

215 
rc
 = 
	`ngx_ma_auth_logš_·sswÜd
(
s
, 
c
);

218 
ngx_im­_auth_¶aš
:

219 
rc
 = 
	`ngx_ma_auth_¶aš
(
s
, 
c
, 0);

222 
ngx_im­_auth_üam_md5
:

223 
rc
 = 
	`ngx_ma_auth_üam_md5
(
s
, 
c
);

227 } ià(
rc
 =ğ
NGX_IMAP_NEXT
) {

228 
g
 = 0;

229 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_Ãxt
);

232 
rc
) {

234 
NGX_DONE
:

235 
	`ngx_ma_auth
(
s
, 
c
);

238 
NGX_ERROR
:

239 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

242 
NGX_MAIL_PARSE_INVALID_COMMAND
:

243 
s
->
¡©e
 = 0;

244 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_šv®id_commªd
);

245 
s
->
ma_¡©e
 = 
ngx_im­_¡¬t
;

249 ià(
g
) {

250 ià(
s
->
g
.
Ën
 == 0) {

251 
	`ngx_¡r_£t
(&
s
->
g
, 
im­_¡¬
);

254 ià(
s
->
gged_lše
.
Ën
 < s->
g
.ËÀ+ s->
‹xt
.ËÀ+ s->
out
.len) {

255 
s
->
gged_lše
.
Ën
 = s->
g
.ËÀ+ s->
‹xt
.ËÀ+ s->
out
.len;

256 
s
->
gged_lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->gged_lše.
Ën
);

257 ià(
s
->
gged_lše
.
d©a
 =ğ
NULL
) {

258 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

263 
p
 = 
s
->
gged_lše
.
d©a
;

265 ià(
s
->
‹xt
.
Ën
) {

266 
p
 = 
	`ngx_ıymem
Õ, 
s
->
‹xt
.
d©a
, s->‹xt.
Ën
);

269 
p
 = 
	`ngx_ıymem
Õ, 
s
->
g
.
d©a
, s->g.
Ën
);

270 
	`ngx_memıy
(
p
, 
s
->
out
.
d©a
, s->out.
Ën
);

272 
s
->
out
.
Ën
 = s->
‹xt
.ËÀ+ s->
g
.len + s->out.len;

273 
s
->
out
.
d©a
 = s->
gged_lše
.data;

276 ià(
rc
 !ğ
NGX_IMAP_NEXT
) {

277 
s
->
¬gs
.
ÃÉs
 = 0;

279 ià(
s
->
¡©e
) {

281 
s
->
¬g_¡¬t
 = s->
bufãr
->
¡¬t
 + s->
g
.
Ën
;

282 
s
->
bufãr
->
pos
 = s->
¬g_¡¬t
;

283 
s
->
bufãr
->
Ï¡
 = s->
¬g_¡¬t
;

286 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

287 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

288 
s
->
g
.
Ën
 = 0;

292 
	`ngx_ma_£nd
(
c
->
wr™e
);

293 
	}
}

296 
ngx_št_t


297 
	$ngx_ma_im­_logš
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

299 
ngx_¡r_t
 *
¬g
;

301 #ià(
NGX_MAIL_SSL
)

302 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

303  
NGX_MAIL_PARSE_INVALID_COMMAND
;

307 
¬g
 = 
s
->
¬gs
.
–ts
;

309 ià(
s
->
¬gs
.
ÃÉs
 !ğ2 || 
¬g
[0].
Ën
 == 0) {

310  
NGX_MAIL_PARSE_INVALID_COMMAND
;

313 
s
->
logš
.
Ën
 = 
¬g
[0].len;

314 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->logš.
Ën
);

315 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

316  
NGX_ERROR
;

319 
	`ngx_memıy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

321 
s
->
·sswd
.
Ën
 = 
¬g
[1].len;

322 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->·sswd.
Ën
);

323 ià(
s
->
·sswd
.
d©a
 =ğ
NULL
) {

324  
NGX_ERROR
;

327 
	`ngx_memıy
(
s
->
·sswd
.
d©a
, 
¬g
[1].d©a, s->·sswd.
Ën
);

329 #ià(
NGX_DEBUG_MAIL_PASSWD
)

330 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

332 &
s
->
logš
, &s->
·sswd
);

334 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

335 "im­†ogš:\"%V\"", &
s
->
logš
);

338  
NGX_DONE
;

339 
	}
}

342 
ngx_št_t


343 
	$ngx_ma_im­_auth’tiÿ‹
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

345 
ngx_št_t
 
rc
;

346 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

347 
ngx_ma_im­_¤v_cÚf_t
 *
iscf
;

349 #ià(
NGX_MAIL_SSL
)

350 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

351  
NGX_MAIL_PARSE_INVALID_COMMAND
;

355 
rc
 = 
	`ngx_ma_auth_·r£
(
s
, 
c
);

357 
rc
) {

359 
NGX_MAIL_AUTH_LOGIN
:

361 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_u£ºame
);

362 
s
->
ma_¡©e
 = 
ngx_im­_auth_logš_u£ºame
;

364  
NGX_OK
;

366 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

368 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_·sswÜd
);

369 
s
->
ma_¡©e
 = 
ngx_im­_auth_logš_·sswÜd
;

371  
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 1);

373 
NGX_MAIL_AUTH_PLAIN
:

375 
	`ngx_¡r_£t
(&
s
->
out
, 
im­_¶aš_Ãxt
);

376 
s
->
ma_¡©e
 = 
ngx_im­_auth_¶aš
;

378  
NGX_OK
;

380 
NGX_MAIL_AUTH_CRAM_MD5
:

382 
iscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_im­_moduË
);

384 ià(!(
iscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

385  
NGX_MAIL_PARSE_INVALID_COMMAND
;

388 ià(
s
->
§É
.
d©a
 =ğ
NULL
) {

389 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

391 ià(
	`ngx_ma_§É
(
s
, 
c
, 
cscf
è!ğ
NGX_OK
) {

392  
NGX_ERROR
;

396 ià(
	`ngx_ma_auth_üam_md5_§É
(
s
, 
c
, "+ ", 2è=ğ
NGX_OK
) {

397 
s
->
ma_¡©e
 = 
ngx_im­_auth_üam_md5
;

398  
NGX_OK
;

401  
NGX_ERROR
;

404  
rc
;

405 
	}
}

408 
ngx_št_t


409 
	$ngx_ma_im­_ÿ·b™y
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

411 
ngx_ma_im­_¤v_cÚf_t
 *
iscf
;

413 
iscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_im­_moduË
);

415 #ià(
NGX_MAIL_SSL
)

417 ià(
c
->
s¦
 =ğ
NULL
) {

418 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

420 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

422 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ON
) {

423 
s
->
‹xt
 = 
iscf
->
¡¬‰ls_ÿ·b™y
;

424  
NGX_OK
;

427 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ONLY
) {

428 
s
->
‹xt
 = 
iscf
->
¡¬‰ls_Úly_ÿ·b™y
;

429  
NGX_OK
;

434 
s
->
‹xt
 = 
iscf
->
ÿ·b™y
;

436  
NGX_OK
;

437 
	}
}

440 
ngx_št_t


441 
	$ngx_ma_im­_¡¬‰ls
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

443 #ià(
NGX_MAIL_SSL
)

444 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

446 ià(
c
->
s¦
 =ğ
NULL
) {

447 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

448 ià(
s¦cf
->
¡¬‰ls
) {

449 
c
->
»ad
->
hªdËr
 = 
ngx_ma_¡¬‰ls_hªdËr
;

450  
NGX_OK
;

456  
NGX_MAIL_PARSE_INVALID_COMMAND
;

457 
	}
}

	@ngx_mail_imap_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_im­_moduË.h
>

15 *
ngx_ma_im­_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_ma_im­_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chd
);

20 
ngx_¡r_t
 
	gngx_ma_im­_deçuÉ_ÿ·b™›s
[] = {

21 
ngx_¡ršg
("IMAP4"),

22 
ngx_¡ršg
("IMAP4rev1"),

23 
ngx_¡ršg
("UIDPLUS"),

24 
ngx_nuÎ_¡ršg


28 
ngx_cÚf_b™mask_t
 
	gngx_ma_im­_auth_m‘hods
[] = {

29 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

30 { 
ngx_¡ršg
("logš"), 
NGX_MAIL_AUTH_LOGIN_ENABLED
 },

31 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

32 { 
ngx_nuÎ_¡ršg
, 0 }

36 
ngx_¡r_t
 
	gngx_ma_im­_auth_m‘hods_Çmes
[] = {

37 
ngx_¡ršg
("AUTH=PLAIN"),

38 
ngx_¡ršg
("AUTH=LOGIN"),

39 
ngx_nuÎ_¡ršg
,

40 
ngx_¡ršg
("AUTH=CRAM-MD5"),

41 
ngx_nuÎ_¡ršg


45 
ngx_ma_´ÙocŞ_t
 
	gngx_ma_im­_´ÙocŞ
 = {

46 
ngx_¡ršg
("imap"),

48 
NGX_MAIL_IMAP_PROTOCOL
,

50 
ngx_ma_im­_š™_£ssiÚ
,

51 
ngx_ma_im­_š™_´ÙocŞ
,

52 
ngx_ma_im­_·r£_commªd
,

53 
ngx_ma_im­_auth_¡©e
,

55 
ngx_¡ršg
("* BAD iÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

59 
ngx_commªd_t
 
	gngx_ma_im­_commªds
[] = {

61 { 
ngx_¡ršg
("imap_client_buffer"),

62 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_size_¦Ù
,

64 
NGX_MAIL_SRV_CONF_OFFSET
,

65 
off£tof
(
ngx_ma_im­_¤v_cÚf_t
, 
ş›Á_bufãr_size
),

66 
NULL
 },

68 { 
ngx_¡ršg
("imap_capabilities"),

69 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

70 
ngx_ma_ÿ·b™›s
,

71 
NGX_MAIL_SRV_CONF_OFFSET
,

72 
off£tof
(
ngx_ma_im­_¤v_cÚf_t
, 
ÿ·b™›s
),

73 
NULL
 },

75 { 
ngx_¡ršg
("imap_auth"),

76 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

77 
ngx_cÚf_£t_b™mask_¦Ù
,

78 
NGX_MAIL_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_ma_im­_¤v_cÚf_t
, 
auth_m‘hods
),

80 &
ngx_ma_im­_auth_m‘hods
 },

82 
ngx_nuÎ_commªd


86 
ngx_ma_moduË_t
 
	gngx_ma_im­_moduË_ùx
 = {

87 &
ngx_ma_im­_´ÙocŞ
,

89 
NULL
,

90 
NULL
,

92 
ngx_ma_im­_ü—‹_¤v_cÚf
,

93 
ngx_ma_im­_m”ge_¤v_cÚf


97 
ngx_moduË_t
 
	gngx_ma_im­_moduË
 = {

98 
NGX_MODULE_V1
,

99 &
ngx_ma_im­_moduË_ùx
,

100 
ngx_ma_im­_commªds
,

101 
NGX_MAIL_MODULE
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NGX_MODULE_V1_PADDING


114 
	$ngx_ma_im­_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

116 
ngx_ma_im­_¤v_cÚf_t
 *
iscf
;

118 
iscf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_im­_¤v_cÚf_t
));

119 ià(
iscf
 =ğ
NULL
) {

120  
NULL
;

123 
iscf
->
ş›Á_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

125 ià(
	`ngx_¬¿y_š™
(&
iscf
->
ÿ·b™›s
, 
cf
->
poŞ
, 4, (
ngx_¡r_t
))

126 !ğ
NGX_OK
)

128  
NULL
;

131  
iscf
;

132 
	}
}

136 
	$ngx_ma_im­_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

138 
ngx_ma_im­_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

139 
ngx_ma_im­_¤v_cÚf_t
 *
cÚf
 = 
chd
;

141 
u_ch¬
 *
p
, *
auth
;

142 
size_t
 
size
;

143 
ngx_¡r_t
 *
c
, *
d
;

144 
ngx_ušt_t
 
i
, 
m
;

146 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
ş›Á_bufãr_size
,

147 
´ev
->
ş›Á_bufãr_size
,

148 (
size_t
è
ngx_·gesize
);

150 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

151 
´ev
->
auth_m‘hods
,

152 (
NGX_CONF_BITMASK_SET


153 |
NGX_MAIL_AUTH_PLAIN_ENABLED
));

156 ià(
cÚf
->
ÿ·b™›s
.
ÃÉs
 == 0) {

157 
cÚf
->
ÿ·b™›s
 = 
´ev
->capabilities;

160 ià(
cÚf
->
ÿ·b™›s
.
ÃÉs
 == 0) {

162 
d
 = 
ngx_ma_im­_deçuÉ_ÿ·b™›s
; d->
Ën
; d++) {

163 
c
 = 
	`ngx_¬¿y_push
(&
cÚf
->
ÿ·b™›s
);

164 ià(
c
 =ğ
NULL
) {

165  
NGX_CONF_ERROR
;

168 *
c
 = *
d
;

172 
size
 = ("* CAPABILITY" 
CRLF
) - 1;

174 
c
 = 
cÚf
->
ÿ·b™›s
.
–ts
;

175 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

176 
size
 +ğ1 + 
c
[
i
].
Ën
;

179 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

180 
m
 <ğ
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

181 
m
 <<ğ1, 
i
++)

183 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

184 
size
 +ğ1 + 
ngx_ma_im­_auth_m‘hods_Çmes
[
i
].
Ën
;

188 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

189 ià(
p
 =ğ
NULL
) {

190  
NGX_CONF_ERROR
;

193 
cÚf
->
ÿ·b™y
.
Ën
 = 
size
;

194 
cÚf
->
ÿ·b™y
.
d©a
 = 
p
;

196 
p
 = 
	`ngx_ıymem
(p, "* CAPABILITY", ("* CAPABILITY") - 1);

198 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

199 *
p
++ = ' ';

200 
p
 = 
	`ngx_ıymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

203 
auth
 = 
p
;

205 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

206 
m
 <ğ
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

207 
m
 <<ğ1, 
i
++)

209 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

210 *
p
++ = ' ';

211 
p
 = 
	`ngx_ıymem
Õ, 
ngx_ma_im­_auth_m‘hods_Çmes
[
i
].
d©a
,

212 
ngx_ma_im­_auth_m‘hods_Çmes
[
i
].
Ën
);

216 *
p
++ = 
CR
; *°ğ
LF
;

219 
size
 += (" STARTTLS") - 1;

221 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

222 ià(
p
 =ğ
NULL
) {

223  
NGX_CONF_ERROR
;

226 
cÚf
->
¡¬‰ls_ÿ·b™y
.
Ën
 = 
size
;

227 
cÚf
->
¡¬‰ls_ÿ·b™y
.
d©a
 = 
p
;

229 
p
 = 
	`ngx_ıymem
Õ, 
cÚf
->
ÿ·b™y
.
d©a
,

230 
cÚf
->
ÿ·b™y
.
Ën
 - ((
CRLF
) - 1));

231 
p
 = 
	`ngx_ıymem
(p, " STARTTLS", (" STARTTLS") - 1);

232 *
p
++ = 
CR
; *°ğ
LF
;

235 
size
 = (
auth
 - 
cÚf
->
ÿ·b™y
.
d©a
è+ (
CRLF
) - 1

238 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

239 ià(
p
 =ğ
NULL
) {

240  
NGX_CONF_ERROR
;

243 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
Ën
 = 
size
;

244 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
d©a
 = 
p
;

246 
p
 = 
	`ngx_ıymem
Õ, 
cÚf
->
ÿ·b™y
.
d©a
,

247 
auth
 - 
cÚf
->
ÿ·b™y
.
d©a
);

248 
p
 = 
	`ngx_ıymem
(p, " STARTTLS LOGINDISABLED",

250 *
p
++ = 
CR
; *°ğ
LF
;

252  
NGX_CONF_OK
;

253 
	}
}

	@ngx_mail_imap_module.h

8 #iâdeà
_NGX_MAIL_IMAP_MODULE_H_INCLUDED_


9 
	#_NGX_MAIL_IMAP_MODULE_H_INCLUDED_


	)

12 
	~<ngx_cÚfig.h
>

13 
	~<ngx_cÜe.h
>

14 
	~<ngx_ma.h
>

18 
size_t
 
	mş›Á_bufãr_size
;

20 
ngx_¡r_t
 
	mÿ·b™y
;

21 
ngx_¡r_t
 
	m¡¬‰ls_ÿ·b™y
;

22 
ngx_¡r_t
 
	m¡¬‰ls_Úly_ÿ·b™y
;

24 
ngx_ušt_t
 
	mauth_m‘hods
;

26 
ngx_¬¿y_t
 
	mÿ·b™›s
;

27 } 
	tngx_ma_im­_¤v_cÚf_t
;

30 
ngx_ma_im­_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

31 
ngx_ma_im­_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
);

32 
ngx_ma_im­_auth_¡©e
(
ngx_ev’t_t
 *
»v
);

33 
ngx_št_t
 
ngx_ma_im­_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
);

36 
ngx_moduË_t
 
ngx_ma_im­_moduË
;

	@ngx_mail_parse.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

14 
ngx_št_t


15 
	$ngx_ma_pİ3_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
)

17 
u_ch¬
 
ch
, *
p
, *
c
, 
c0
, 
c1
, 
c2
, 
c3
;

18 
ngx_¡r_t
 *
¬g
;

20 
sw_¡¬t
 = 0,

21 
sw_¥aûs_befÜe_¬gum’t
,

22 
sw_¬gum’t
,

23 
sw_®mo¡_dÚe


24 } 
¡©e
;

26 
¡©e
 = 
s
->state;

28 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

29 
ch
 = *
p
;

31 
¡©e
) {

34 
sw_¡¬t
:

35 ià(
ch
 =ğ' ' || ch =ğ
CR
 || ch =ğ
LF
) {

36 
c
 = 
s
->
bufãr
->
¡¬t
;

38 ià(
p
 - 
c
 == 4) {

40 
c0
 = 
	`ngx_touµ”
(
c
[0]);

41 
c1
 = 
	`ngx_touµ”
(
c
[1]);

42 
c2
 = 
	`ngx_touµ”
(
c
[2]);

43 
c3
 = 
	`ngx_touµ”
(
c
[3]);

45 ià(
c0
 =ğ'U' && 
c1
 =ğ'S' && 
c2
 =ğ'E' && 
c3
 == 'R')

47 
s
->
commªd
 = 
NGX_POP3_USER
;

49 } ià(
c0
 =ğ'P' && 
c1
 =ğ'A' && 
c2
 =ğ'S' && 
c3
 == 'S')

51 
s
->
commªd
 = 
NGX_POP3_PASS
;

53 } ià(
c0
 =ğ'A' && 
c1
 =ğ'P' && 
c2
 =ğ'O' && 
c3
 == 'P')

55 
s
->
commªd
 = 
NGX_POP3_APOP
;

57 } ià(
c0
 =ğ'Q' && 
c1
 =ğ'U' && 
c2
 =ğ'I' && 
c3
 == 'T')

59 
s
->
commªd
 = 
NGX_POP3_QUIT
;

61 } ià(
c0
 =ğ'C' && 
c1
 =ğ'A' && 
c2
 =ğ'P' && 
c3
 == 'A')

63 
s
->
commªd
 = 
NGX_POP3_CAPA
;

65 } ià(
c0
 =ğ'A' && 
c1
 =ğ'U' && 
c2
 =ğ'T' && 
c3
 == 'H')

67 
s
->
commªd
 = 
NGX_POP3_AUTH
;

69 } ià(
c0
 =ğ'N' && 
c1
 =ğ'O' && 
c2
 =ğ'O' && 
c3
 == 'P')

71 
s
->
commªd
 = 
NGX_POP3_NOOP
;

72 #ià(
NGX_MAIL_SSL
)

73 } ià(
c0
 =ğ'S' && 
c1
 =ğ'T' && 
c2
 =ğ'L' && 
c3
 == 'S')

75 
s
->
commªd
 = 
NGX_POP3_STLS
;

78 
šv®id
;

82 
šv®id
;

85 
ch
) {

87 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

89 
CR
:

90 
¡©e
 = 
sw_®mo¡_dÚe
;

92 
LF
:

93 
dÚe
;

98 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

99 
šv®id
;

104 
sw_¥aûs_befÜe_¬gum’t
:

105 
ch
) {

108 
CR
:

109 
¡©e
 = 
sw_®mo¡_dÚe
;

110 
s
->
¬g_’d
 = 
p
;

112 
LF
:

113 
s
->
¬g_’d
 = 
p
;

114 
dÚe
;

116 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

117 
¡©e
 = 
sw_¬gum’t
;

118 
s
->
¬g_¡¬t
 = 
p
;

121 
šv®id
;

125 
sw_¬gum’t
:

126 
ch
) {

135 ià(
s
->
commªd
 =ğ
NGX_POP3_USER


136 || 
s
->
commªd
 =ğ
NGX_POP3_PASS
)

143 
CR
:

144 
LF
:

145 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

146 ià(
¬g
 =ğ
NULL
) {

147  
NGX_ERROR
;

149 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

150 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

151 
s
->
¬g_¡¬t
 = 
NULL
;

153 
ch
) {

155 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

157 
CR
:

158 
¡©e
 = 
sw_®mo¡_dÚe
;

160 
LF
:

161 
dÚe
;

170 
sw_®mo¡_dÚe
:

171 
ch
) {

172 
LF
:

173 
dÚe
;

175 
šv®id
;

180 
s
->
bufãr
->
pos
 = 
p
;

181 
s
->
¡©e
 = state;

183  
NGX_AGAIN
;

185 
dÚe
:

187 
s
->
bufãr
->
pos
 = 
p
 + 1;

189 ià(
s
->
¬g_¡¬t
) {

190 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

191 ià(
¬g
 =ğ
NULL
) {

192  
NGX_ERROR
;

194 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

195 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

196 
s
->
¬g_¡¬t
 = 
NULL
;

199 
s
->
¡©e
 = (s->
commªd
 !ğ
NGX_POP3_AUTH
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

201  
NGX_OK
;

203 
šv®id
:

205 
s
->
¡©e
 = 
sw_¡¬t
;

206 
s
->
¬g_¡¬t
 = 
NULL
;

208  
NGX_MAIL_PARSE_INVALID_COMMAND
;

209 
	}
}

212 
ngx_št_t


213 
	$ngx_ma_im­_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
)

215 
u_ch¬
 
ch
, *
p
, *
c
;

216 
ngx_¡r_t
 *
¬g
;

218 
sw_¡¬t
 = 0,

219 
sw_¥aûs_befÜe_commªd
,

220 
sw_commªd
,

221 
sw_¥aûs_befÜe_¬gum’t
,

222 
sw_¬gum’t
,

223 
sw_back¦ash
,

224 
sw_l™”®
,

225 
sw_no_sync_l™”®_¬gum’t
,

226 
sw_¡¬t_l™”®_¬gum’t
,

227 
sw_l™”®_¬gum’t
,

228 
sw_’d_l™”®_¬gum’t
,

229 
sw_®mo¡_dÚe


230 } 
¡©e
;

232 
¡©e
 = 
s
->state;

234 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

235 
ch
 = *
p
;

237 
¡©e
) {

240 
sw_¡¬t
:

241 
ch
) {

243 
s
->
g
.
Ën
 = 
p
 - s->
bufãr
->
¡¬t
 + 1;

244 
s
->
g
.
d©a
 = s->
bufãr
->
¡¬t
;

245 
¡©e
 = 
sw_¥aûs_befÜe_commªd
;

247 
CR
:

248 
s
->
¡©e
 = 
sw_¡¬t
;

249  
NGX_MAIL_PARSE_INVALID_COMMAND
;

250 
LF
:

251 
s
->
¡©e
 = 
sw_¡¬t
;

252  
NGX_MAIL_PARSE_INVALID_COMMAND
;

256 
sw_¥aûs_befÜe_commªd
:

257 
ch
) {

260 
CR
:

261 
s
->
¡©e
 = 
sw_¡¬t
;

262  
NGX_MAIL_PARSE_INVALID_COMMAND
;

263 
LF
:

264 
s
->
¡©e
 = 
sw_¡¬t
;

265  
NGX_MAIL_PARSE_INVALID_COMMAND
;

267 
s
->
cmd_¡¬t
 = 
p
;

268 
¡©e
 = 
sw_commªd
;

273 
sw_commªd
:

274 ià(
ch
 =ğ' ' || ch =ğ
CR
 || ch =ğ
LF
) {

276 
c
 = 
s
->
cmd_¡¬t
;

278 
p
 - 
c
) {

281 ià((
c
[0] == 'N' || c[0] == 'n')

282 && (
c
[1] == 'O'|| c[1] == 'o')

283 && (
c
[2] == 'O'|| c[2] == 'o')

284 && (
c
[3] == 'P'|| c[3] == 'p'))

286 
s
->
commªd
 = 
NGX_IMAP_NOOP
;

289 
šv®id
;

294 ià((
c
[0] == 'L'|| c[0] == 'l')

295 && (
c
[1] == 'O'|| c[1] == 'o')

296 && (
c
[2] == 'G'|| c[2] == 'g')

297 && (
c
[3] == 'I'|| c[3] == 'i')

298 && (
c
[4] == 'N'|| c[4] == 'n'))

300 
s
->
commªd
 = 
NGX_IMAP_LOGIN
;

303 
šv®id
;

308 ià((
c
[0] == 'L'|| c[0] == 'l')

309 && (
c
[1] == 'O'|| c[1] == 'o')

310 && (
c
[2] == 'G'|| c[2] == 'g')

311 && (
c
[3] == 'O'|| c[3] == 'o')

312 && (
c
[4] == 'U'|| c[4] == 'u')

313 && (
c
[5] == 'T'|| c[5] == 't'))

315 
s
->
commªd
 = 
NGX_IMAP_LOGOUT
;

318 
šv®id
;

322 #ià(
NGX_MAIL_SSL
)

324 ià((
c
[0] == 'S'|| c[0] == 's')

325 && (
c
[1] == 'T'|| c[1] == 't')

326 && (
c
[2] == 'A'|| c[2] == 'a')

327 && (
c
[3] == 'R'|| c[3] == 'r')

328 && (
c
[4] == 'T'|| c[4] == 't')

329 && (
c
[5] == 'T'|| c[5] == 't')

330 && (
c
[6] == 'L'|| c[6] == 'l')

331 && (
c
[7] == 'S'|| c[7] == 's'))

333 
s
->
commªd
 = 
NGX_IMAP_STARTTLS
;

336 
šv®id
;

342 ià((
c
[0] == 'C'|| c[0] == 'c')

343 && (
c
[1] == 'A'|| c[1] == 'a')

344 && (
c
[2] == 'P'|| c[2] == 'p')

345 && (
c
[3] == 'A'|| c[3] == 'a')

346 && (
c
[4] == 'B'|| c[4] == 'b')

347 && (
c
[5] == 'I'|| c[5] == 'i')

348 && (
c
[6] == 'L'|| c[6] == 'l')

349 && (
c
[7] == 'I'|| c[7] == 'i')

350 && (
c
[8] == 'T'|| c[8] == 't')

351 && (
c
[9] == 'Y'|| c[9] == 'y'))

353 
s
->
commªd
 = 
NGX_IMAP_CAPABILITY
;

356 
šv®id
;

361 ià((
c
[0] == 'A'|| c[0] == 'a')

362 && (
c
[1] == 'U'|| c[1] == 'u')

363 && (
c
[2] == 'T'|| c[2] == 't')

364 && (
c
[3] == 'H'|| c[3] == 'h')

365 && (
c
[4] == 'E'|| c[4] == 'e')

366 && (
c
[5] == 'N'|| c[5] == 'n')

367 && (
c
[6] == 'T'|| c[6] == 't')

368 && (
c
[7] == 'I'|| c[7] == 'i')

369 && (
c
[8] == 'C'|| c[8] == 'c')

370 && (
c
[9] == 'A'|| c[9] == 'a')

371 && (
c
[10] == 'T'|| c[10] == 't')

372 && (
c
[11] == 'E'|| c[11] == 'e'))

374 
s
->
commªd
 = 
NGX_IMAP_AUTHENTICATE
;

377 
šv®id
;

382 
šv®id
;

385 
ch
) {

387 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

389 
CR
:

390 
¡©e
 = 
sw_®mo¡_dÚe
;

392 
LF
:

393 
dÚe
;

398 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

399 
šv®id
;

404 
sw_¥aûs_befÜe_¬gum’t
:

405 
ch
) {

408 
CR
:

409 
¡©e
 = 
sw_®mo¡_dÚe
;

410 
s
->
¬g_’d
 = 
p
;

412 
LF
:

413 
s
->
¬g_’d
 = 
p
;

414 
dÚe
;

416 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

417 
s
->
quÙed
 = 1;

418 
s
->
¬g_¡¬t
 = 
p
 + 1;

419 
¡©e
 = 
sw_¬gum’t
;

422 
šv®id
;

424 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

425 
¡©e
 = 
sw_l™”®
;

428 
šv®id
;

430 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

431 
s
->
¬g_¡¬t
 = 
p
;

432 
¡©e
 = 
sw_¬gum’t
;

435 
šv®id
;

439 
sw_¬gum’t
:

440 ià(
ch
 =ğ' ' && 
s
->
quÙed
) {

444 
ch
) {

446 ià(!
s
->
quÙed
) {

449 
s
->
quÙed
 = 0;

452 
CR
:

453 
LF
:

454 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

455 ià(
¬g
 =ğ
NULL
) {

456  
NGX_ERROR
;

458 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

459 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

460 
s
->
¬g_¡¬t
 = 
NULL
;

462 
ch
) {

465 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

467 
CR
:

468 
¡©e
 = 
sw_®mo¡_dÚe
;

470 
LF
:

471 
dÚe
;

475 ià(
s
->
quÙed
) {

476 
s
->
back¦ash
 = 1;

477 
¡©e
 = 
sw_back¦ash
;

483 
sw_back¦ash
:

484 
ch
) {

485 
CR
:

486 
LF
:

487 
šv®id
;

489 
¡©e
 = 
sw_¬gum’t
;

493 
sw_l™”®
:

494 ià(
ch
 >= '0' && ch <= '9') {

495 
s
->
l™”®_Ën
 = s->l™”®_ËÀ* 10 + (
ch
 - '0');

498 ià(
ch
 == '}') {

499 
¡©e
 = 
sw_¡¬t_l™”®_¬gum’t
;

502 ià(
ch
 == '+') {

503 
¡©e
 = 
sw_no_sync_l™”®_¬gum’t
;

506 
šv®id
;

508 
sw_no_sync_l™”®_¬gum’t
:

509 ià(
ch
 == '}') {

510 
s
->
no_sync_l™”®
 = 1;

511 
¡©e
 = 
sw_¡¬t_l™”®_¬gum’t
;

514 
šv®id
;

516 
sw_¡¬t_l™”®_¬gum’t
:

517 
ch
) {

518 
CR
:

520 
LF
:

521 
s
->
bufãr
->
pos
 = 
p
 + 1;

522 
s
->
¬g_¡¬t
 = 
p
 + 1;

523 ià(
s
->
no_sync_l™”®
 == 0) {

524 
s
->
¡©e
 = 
sw_l™”®_¬gum’t
;

525  
NGX_IMAP_NEXT
;

527 
¡©e
 = 
sw_l™”®_¬gum’t
;

528 
s
->
no_sync_l™”®
 = 0;

531 
šv®id
;

535 
sw_l™”®_¬gum’t
:

536 ià(
s
->
l™”®_Ën
 && --s->literal_len) {

540 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

541 ià(
¬g
 =ğ
NULL
) {

542  
NGX_ERROR
;

544 
¬g
->
Ën
 = 
p
 + 1 - 
s
->
¬g_¡¬t
;

545 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

546 
s
->
¬g_¡¬t
 = 
NULL
;

547 
¡©e
 = 
sw_’d_l™”®_¬gum’t
;

551 
sw_’d_l™”®_¬gum’t
:

552 
ch
) {

554 ià(
s
->
¬gs
.
ÃÉs
 <= 2) {

555 
¡©e
 = 
sw_l™”®
;

558 
šv®id
;

559 
CR
:

560 
¡©e
 = 
sw_®mo¡_dÚe
;

562 
LF
:

563 
dÚe
;

565 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

570 
sw_®mo¡_dÚe
:

571 
ch
) {

572 
LF
:

573 
dÚe
;

575 
šv®id
;

580 
s
->
bufãr
->
pos
 = 
p
;

581 
s
->
¡©e
 = state;

583  
NGX_AGAIN
;

585 
dÚe
:

587 
s
->
bufãr
->
pos
 = 
p
 + 1;

589 ià(
s
->
¬g_¡¬t
) {

590 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

591 ià(
¬g
 =ğ
NULL
) {

592  
NGX_ERROR
;

594 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

595 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

597 
s
->
¬g_¡¬t
 = 
NULL
;

598 
s
->
cmd_¡¬t
 = 
NULL
;

599 
s
->
quÙed
 = 0;

600 
s
->
no_sync_l™”®
 = 0;

601 
s
->
l™”®_Ën
 = 0;

604 
s
->
¡©e
 = (s->
commªd
 !ğ
NGX_IMAP_AUTHENTICATE
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

606  
NGX_OK
;

608 
šv®id
:

610 
s
->
¡©e
 = 
sw_¡¬t
;

611 
s
->
quÙed
 = 0;

612 
s
->
no_sync_l™”®
 = 0;

613 
s
->
l™”®_Ën
 = 0;

615  
NGX_MAIL_PARSE_INVALID_COMMAND
;

616 
	}
}

619 
ngx_št_t


620 
	$ngx_ma_sm_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
)

622 
u_ch¬
 
ch
, *
p
, *
c
, 
c0
, 
c1
, 
c2
, 
c3
;

623 
ngx_¡r_t
 *
¬g
;

625 
sw_¡¬t
 = 0,

626 
sw_¥aûs_befÜe_¬gum’t
,

627 
sw_¬gum’t
,

628 
sw_®mo¡_dÚe


629 } 
¡©e
;

631 
¡©e
 = 
s
->state;

633 
p
 = 
s
->
bufãr
->
pos
;… < s->bufãr->
Ï¡
;…++) {

634 
ch
 = *
p
;

636 
¡©e
) {

639 
sw_¡¬t
:

640 ià(
ch
 =ğ' ' || ch =ğ
CR
 || ch =ğ
LF
) {

641 
c
 = 
s
->
bufãr
->
¡¬t
;

643 ià(
p
 - 
c
 == 4) {

645 
c0
 = 
	`ngx_touµ”
(
c
[0]);

646 
c1
 = 
	`ngx_touµ”
(
c
[1]);

647 
c2
 = 
	`ngx_touµ”
(
c
[2]);

648 
c3
 = 
	`ngx_touµ”
(
c
[3]);

650 ià(
c0
 =ğ'H' && 
c1
 =ğ'E' && 
c2
 =ğ'L' && 
c3
 == 'O')

652 
s
->
commªd
 = 
NGX_SMTP_HELO
;

654 } ià(
c0
 =ğ'E' && 
c1
 =ğ'H' && 
c2
 =ğ'L' && 
c3
 == 'O')

656 
s
->
commªd
 = 
NGX_SMTP_EHLO
;

658 } ià(
c0
 =ğ'Q' && 
c1
 =ğ'U' && 
c2
 =ğ'I' && 
c3
 == 'T')

660 
s
->
commªd
 = 
NGX_SMTP_QUIT
;

662 } ià(
c0
 =ğ'A' && 
c1
 =ğ'U' && 
c2
 =ğ'T' && 
c3
 == 'H')

664 
s
->
commªd
 = 
NGX_SMTP_AUTH
;

666 } ià(
c0
 =ğ'N' && 
c1
 =ğ'O' && 
c2
 =ğ'O' && 
c3
 == 'P')

668 
s
->
commªd
 = 
NGX_SMTP_NOOP
;

670 } ià(
c0
 =ğ'M' && 
c1
 =ğ'A' && 
c2
 =ğ'I' && 
c3
 == 'L')

672 
s
->
commªd
 = 
NGX_SMTP_MAIL
;

674 } ià(
c0
 =ğ'R' && 
c1
 =ğ'S' && 
c2
 =ğ'E' && 
c3
 == 'T')

676 
s
->
commªd
 = 
NGX_SMTP_RSET
;

678 } ià(
c0
 =ğ'R' && 
c1
 =ğ'C' && 
c2
 =ğ'P' && 
c3
 == 'T')

680 
s
->
commªd
 = 
NGX_SMTP_RCPT
;

682 } ià(
c0
 =ğ'V' && 
c1
 =ğ'R' && 
c2
 =ğ'F' && 
c3
 == 'Y')

684 
s
->
commªd
 = 
NGX_SMTP_VRFY
;

686 } ià(
c0
 =ğ'E' && 
c1
 =ğ'X' && 
c2
 =ğ'P' && 
c3
 == 'N')

688 
s
->
commªd
 = 
NGX_SMTP_EXPN
;

690 } ià(
c0
 =ğ'H' && 
c1
 =ğ'E' && 
c2
 =ğ'L' && 
c3
 == 'P')

692 
s
->
commªd
 = 
NGX_SMTP_HELP
;

695 
šv®id
;

697 #ià(
NGX_MAIL_SSL
)

698 } ià(
p
 - 
c
 == 8) {

700 ià((
c
[0] == 'S'|| c[0] == 's')

701 && (
c
[1] == 'T'|| c[1] == 't')

702 && (
c
[2] == 'A'|| c[2] == 'a')

703 && (
c
[3] == 'R'|| c[3] == 'r')

704 && (
c
[4] == 'T'|| c[4] == 't')

705 && (
c
[5] == 'T'|| c[5] == 't')

706 && (
c
[6] == 'L'|| c[6] == 'l')

707 && (
c
[7] == 'S'|| c[7] == 's'))

709 
s
->
commªd
 = 
NGX_SMTP_STARTTLS
;

712 
šv®id
;

716 
šv®id
;

719 
ch
) {

721 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

723 
CR
:

724 
¡©e
 = 
sw_®mo¡_dÚe
;

726 
LF
:

727 
dÚe
;

732 ià((
ch
 < 'A' || ch > 'Z') && (ch < 'a' || ch > 'z')) {

733 
šv®id
;

738 
sw_¥aûs_befÜe_¬gum’t
:

739 
ch
) {

742 
CR
:

743 
¡©e
 = 
sw_®mo¡_dÚe
;

744 
s
->
¬g_’d
 = 
p
;

746 
LF
:

747 
s
->
¬g_’d
 = 
p
;

748 
dÚe
;

750 ià(
s
->
¬gs
.
ÃÉs
 <= 10) {

751 
¡©e
 = 
sw_¬gum’t
;

752 
s
->
¬g_¡¬t
 = 
p
;

755 
šv®id
;

759 
sw_¬gum’t
:

760 
ch
) {

762 
CR
:

763 
LF
:

764 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

765 ià(
¬g
 =ğ
NULL
) {

766  
NGX_ERROR
;

768 
¬g
->
Ën
 = 
p
 - 
s
->
¬g_¡¬t
;

769 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

770 
s
->
¬g_¡¬t
 = 
NULL
;

772 
ch
) {

774 
¡©e
 = 
sw_¥aûs_befÜe_¬gum’t
;

776 
CR
:

777 
¡©e
 = 
sw_®mo¡_dÚe
;

779 
LF
:

780 
dÚe
;

789 
sw_®mo¡_dÚe
:

790 
ch
) {

791 
LF
:

792 
dÚe
;

794 
šv®id
;

799 
s
->
bufãr
->
pos
 = 
p
;

800 
s
->
¡©e
 = state;

802  
NGX_AGAIN
;

804 
dÚe
:

806 
s
->
bufãr
->
pos
 = 
p
 + 1;

808 ià(
s
->
¬g_¡¬t
) {

809 
¬g
 = 
	`ngx_¬¿y_push
(&
s
->
¬gs
);

810 ià(
¬g
 =ğ
NULL
) {

811  
NGX_ERROR
;

813 
¬g
->
Ën
 = 
s
->
¬g_’d
 - s->
¬g_¡¬t
;

814 
¬g
->
d©a
 = 
s
->
¬g_¡¬t
;

815 
s
->
¬g_¡¬t
 = 
NULL
;

818 
s
->
¡©e
 = (s->
commªd
 !ğ
NGX_SMTP_AUTH
è? 
sw_¡¬t
 : 
sw_¬gum’t
;

820  
NGX_OK
;

822 
šv®id
:

824 
s
->
¡©e
 = 
sw_¡¬t
;

825 
s
->
¬g_¡¬t
 = 
NULL
;

827  
NGX_MAIL_PARSE_INVALID_COMMAND
;

828 
	}
}

831 
ngx_št_t


832 
	$ngx_ma_auth_·r£
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

834 
ngx_¡r_t
 *
¬g
;

836 #ià(
NGX_MAIL_SSL
)

837 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

838  
NGX_MAIL_PARSE_INVALID_COMMAND
;

842 
¬g
 = 
s
->
¬gs
.
–ts
;

844 ià(
¬g
[0].
Ën
 == 5) {

846 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "LOGIN", 5) == 0) {

848 ià(
s
->
¬gs
.
ÃÉs
 == 1) {

849  
NGX_MAIL_AUTH_LOGIN
;

852 ià(
s
->
¬gs
.
ÃÉs
 == 2) {

853  
NGX_MAIL_AUTH_LOGIN_USERNAME
;

856  
NGX_MAIL_PARSE_INVALID_COMMAND
;

859 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "PLAIN", 5) == 0) {

861 ià(
s
->
¬gs
.
ÃÉs
 == 1) {

862  
NGX_MAIL_AUTH_PLAIN
;

865 ià(
s
->
¬gs
.
ÃÉs
 == 2) {

866  
	`ngx_ma_auth_¶aš
(
s
, 
c
, 1);

870  
NGX_MAIL_PARSE_INVALID_COMMAND
;

873 ià(
¬g
[0].
Ën
 == 8) {

875 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

876  
NGX_MAIL_PARSE_INVALID_COMMAND
;

879 ià(
	`ngx_¡ºÿ£cmp
(
¬g
[0].
d©a
, (
u_ch¬
 *) "CRAM-MD5", 8) == 0) {

880  
NGX_MAIL_AUTH_CRAM_MD5
;

884  
NGX_MAIL_PARSE_INVALID_COMMAND
;

885 
	}
}

	@ngx_mail_pop3_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_pİ3_moduË.h
>

15 
ngx_št_t
 
ngx_ma_pİ3_u£r
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

16 
ngx_št_t
 
ngx_ma_pİ3_·ss
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

17 
ngx_št_t
 
ngx_ma_pİ3_ÿ·
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

18 
ngx_št_t
 
¡ls
);

19 
ngx_št_t
 
ngx_ma_pİ3_¡ls
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

20 
ngx_št_t
 
ngx_ma_pİ3_­İ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

21 
ngx_št_t
 
ngx_ma_pİ3_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

24 
u_ch¬
 
	gpİ3_g»‘šg
[] = "+OK POP3„—dy" 
CRLF
;

25 
u_ch¬
 
	gpİ3_ok
[] = "+OK" 
CRLF
;

26 
u_ch¬
 
	gpİ3_Ãxt
[] = "+ " 
CRLF
;

27 
u_ch¬
 
	gpİ3_u£ºame
[] = "+ VXNlcm5hbWU6" 
CRLF
;

28 
u_ch¬
 
	gpİ3_·sswÜd
[] = "+ UGFzc3dvcmQ6" 
CRLF
;

29 
u_ch¬
 
	gpİ3_šv®id_commªd
[] = "-ERR inv®id commªd" 
CRLF
;

33 
	$ngx_ma_pİ3_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

35 
u_ch¬
 *
p
;

36 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

37 
ngx_ma_pİ3_¤v_cÚf_t
 *
pscf
;

39 
pscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_pİ3_moduË
);

40 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

42 ià(
pscf
->
auth_m‘hods


43 & (
NGX_MAIL_AUTH_APOP_ENABLED
|
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
))

45 ià(
	`ngx_ma_§É
(
s
, 
c
, 
cscf
è!ğ
NGX_OK
) {

46 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

50 
s
->
out
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, (
pİ3_g»‘šg
è+ s->
§É
.
Ën
);

51 ià(
s
->
out
.
d©a
 =ğ
NULL
) {

52 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

56 
p
 = 
	`ngx_ıymem
(
s
->
out
.
d©a
, 
pİ3_g»‘šg
, (pop3_greeting) - 3);

57 *
p
++ = ' ';

58 
p
 = 
	`ngx_ıymem
Õ, 
s
->
§É
.
d©a
, s->§É.
Ën
);

60 
s
->
out
.
Ën
 = 
p
 - s->out.
d©a
;

63 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_g»‘šg
);

66 
c
->
»ad
->
hªdËr
 = 
ngx_ma_pİ3_š™_´ÙocŞ
;

68 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

70 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

71 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

74 
	`ngx_ma_£nd
(
c
->
wr™e
);

75 
	}
}

79 
	$ngx_ma_pİ3_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
)

81 
ngx_cÚÃùiÚ_t
 *
c
;

82 
ngx_ma_£ssiÚ_t
 *
s
;

84 
c
 = 
»v
->
d©a
;

86 
c
->
log
->
aùiÚ
 = "in‡uth state";

88 ià(
»v
->
timedout
) {

89 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

90 
c
->
timedout
 = 1;

91 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

95 
s
 = 
c
->
d©a
;

97 ià(
s
->
bufãr
 =ğ
NULL
) {

98 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poŞ
, 2, (
ngx_¡r_t
))

99 =ğ
NGX_ERROR
)

101 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

105 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poŞ
, 128);

106 ià(
s
->
bufãr
 =ğ
NULL
) {

107 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

112 
s
->
ma_¡©e
 = 
ngx_pİ3_¡¬t
;

113 
c
->
»ad
->
hªdËr
 = 
ngx_ma_pİ3_auth_¡©e
;

115 
	`ngx_ma_pİ3_auth_¡©e
(
»v
);

116 
	}
}

120 
	$ngx_ma_pİ3_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

122 
ngx_št_t
 
rc
;

123 
ngx_cÚÃùiÚ_t
 *
c
;

124 
ngx_ma_£ssiÚ_t
 *
s
;

126 
c
 = 
»v
->
d©a
;

127 
s
 = 
c
->
d©a
;

129 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "pop3‡uth state");

131 ià(
»v
->
timedout
) {

132 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

133 
c
->
timedout
 = 1;

134 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

138 ià(
s
->
out
.
Ën
) {

139 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "pop3 send handler busy");

140 
s
->
blocked
 = 1;

144 
s
->
blocked
 = 0;

146 
rc
 = 
	`ngx_ma_»ad_commªd
(
s
, 
c
);

148 ià(
rc
 =ğ
NGX_AGAIN
 ||„ø=ğ
NGX_ERROR
) {

152 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_ok
);

154 ià(
rc
 =ğ
NGX_OK
) {

155 
s
->
ma_¡©e
) {

157 
ngx_pİ3_¡¬t
:

159 
s
->
commªd
) {

161 
NGX_POP3_USER
:

162 
rc
 = 
	`ngx_ma_pİ3_u£r
(
s
, 
c
);

165 
NGX_POP3_CAPA
:

166 
rc
 = 
	`ngx_ma_pİ3_ÿ·
(
s
, 
c
, 1);

169 
NGX_POP3_APOP
:

170 
rc
 = 
	`ngx_ma_pİ3_­İ
(
s
, 
c
);

173 
NGX_POP3_AUTH
:

174 
rc
 = 
	`ngx_ma_pİ3_auth
(
s
, 
c
);

177 
NGX_POP3_QUIT
:

178 
s
->
qu™
 = 1;

181 
NGX_POP3_NOOP
:

184 
NGX_POP3_STLS
:

185 
rc
 = 
	`ngx_ma_pİ3_¡ls
(
s
, 
c
);

189 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

195 
ngx_pİ3_u£r
:

197 
s
->
commªd
) {

199 
NGX_POP3_PASS
:

200 
rc
 = 
	`ngx_ma_pİ3_·ss
(
s
, 
c
);

203 
NGX_POP3_CAPA
:

204 
rc
 = 
	`ngx_ma_pİ3_ÿ·
(
s
, 
c
, 0);

207 
NGX_POP3_QUIT
:

208 
s
->
qu™
 = 1;

211 
NGX_POP3_NOOP
:

215 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

222 
ngx_pİ3_·sswd
:

225 
ngx_pİ3_auth_logš_u£ºame
:

226 
rc
 = 
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 0);

228 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_·sswÜd
);

229 
s
->
ma_¡©e
 = 
ngx_pİ3_auth_logš_·sswÜd
;

232 
ngx_pİ3_auth_logš_·sswÜd
:

233 
rc
 = 
	`ngx_ma_auth_logš_·sswÜd
(
s
, 
c
);

236 
ngx_pİ3_auth_¶aš
:

237 
rc
 = 
	`ngx_ma_auth_¶aš
(
s
, 
c
, 0);

240 
ngx_pİ3_auth_üam_md5
:

241 
rc
 = 
	`ngx_ma_auth_üam_md5
(
s
, 
c
);

246 
rc
) {

248 
NGX_DONE
:

249 
	`ngx_ma_auth
(
s
, 
c
);

252 
NGX_ERROR
:

253 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

256 
NGX_MAIL_PARSE_INVALID_COMMAND
:

257 
s
->
ma_¡©e
 = 
ngx_pİ3_¡¬t
;

258 
s
->
¡©e
 = 0;

260 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_šv®id_commªd
);

264 
NGX_OK
:

266 
s
->
¬gs
.
ÃÉs
 = 0;

267 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

268 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

270 ià(
s
->
¡©e
) {

271 
s
->
¬g_¡¬t
 = s->
bufãr
->
¡¬t
;

274 
	`ngx_ma_£nd
(
c
->
wr™e
);

276 
	}
}

278 
ngx_št_t


279 
	$ngx_ma_pİ3_u£r
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

281 
ngx_¡r_t
 *
¬g
;

283 #ià(
NGX_MAIL_SSL
)

284 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

285  
NGX_MAIL_PARSE_INVALID_COMMAND
;

289 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

290  
NGX_MAIL_PARSE_INVALID_COMMAND
;

293 
¬g
 = 
s
->
¬gs
.
–ts
;

294 
s
->
logš
.
Ën
 = 
¬g
[0].len;

295 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->logš.
Ën
);

296 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

297  
NGX_ERROR
;

300 
	`ngx_memıy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

302 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

303 "pİ3†ogš: \"%V\"", &
s
->
logš
);

305 
s
->
ma_¡©e
 = 
ngx_pİ3_u£r
;

307  
NGX_OK
;

308 
	}
}

311 
ngx_št_t


312 
	$ngx_ma_pİ3_·ss
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

314 
ngx_¡r_t
 *
¬g
;

316 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

317  
NGX_MAIL_PARSE_INVALID_COMMAND
;

320 
¬g
 = 
s
->
¬gs
.
–ts
;

321 
s
->
·sswd
.
Ën
 = 
¬g
[0].len;

322 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->·sswd.
Ën
);

323 ià(
s
->
·sswd
.
d©a
 =ğ
NULL
) {

324  
NGX_ERROR
;

327 
	`ngx_memıy
(
s
->
·sswd
.
d©a
, 
¬g
[0].d©a, s->·sswd.
Ën
);

329 #ià(
NGX_DEBUG_MAIL_PASSWD
)

330 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

331 "pİ3…asswd: \"%V\"", &
s
->
·sswd
);

334  
NGX_DONE
;

335 
	}
}

338 
ngx_št_t


339 
	$ngx_ma_pİ3_ÿ·
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
, 
ngx_št_t
 
¡ls
)

341 
ngx_ma_pİ3_¤v_cÚf_t
 *
pscf
;

343 
pscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_pİ3_moduË
);

345 #ià(
NGX_MAIL_SSL
)

347 ià(
¡ls
 && 
c
->
s¦
 =ğ
NULL
) {

348 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

350 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

352 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ON
) {

353 
s
->
out
 = 
pscf
->
¡¬‰ls_ÿ·b™y
;

354  
NGX_OK
;

357 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ONLY
) {

358 
s
->
out
 = 
pscf
->
¡¬‰ls_Úly_ÿ·b™y
;

359  
NGX_OK
;

365 
s
->
out
 = 
pscf
->
ÿ·b™y
;

366  
NGX_OK
;

367 
	}
}

370 
ngx_št_t


371 
	$ngx_ma_pİ3_¡ls
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

373 #ià(
NGX_MAIL_SSL
)

374 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

376 ià(
c
->
s¦
 =ğ
NULL
) {

377 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

378 ià(
s¦cf
->
¡¬‰ls
) {

379 
c
->
»ad
->
hªdËr
 = 
ngx_ma_¡¬‰ls_hªdËr
;

380  
NGX_OK
;

386  
NGX_MAIL_PARSE_INVALID_COMMAND
;

387 
	}
}

390 
ngx_št_t


391 
	$ngx_ma_pİ3_­İ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

393 
ngx_¡r_t
 *
¬g
;

394 
ngx_ma_pİ3_¤v_cÚf_t
 *
pscf
;

396 #ià(
NGX_MAIL_SSL
)

397 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

398  
NGX_MAIL_PARSE_INVALID_COMMAND
;

402 ià(
s
->
¬gs
.
ÃÉs
 != 2) {

403  
NGX_MAIL_PARSE_INVALID_COMMAND
;

406 
pscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_pİ3_moduË
);

408 ià(!(
pscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_APOP_ENABLED
)) {

409  
NGX_MAIL_PARSE_INVALID_COMMAND
;

412 
¬g
 = 
s
->
¬gs
.
–ts
;

414 
s
->
logš
.
Ën
 = 
¬g
[0].len;

415 
s
->
logš
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->logš.
Ën
);

416 ià(
s
->
logš
.
d©a
 =ğ
NULL
) {

417  
NGX_ERROR
;

420 
	`ngx_memıy
(
s
->
logš
.
d©a
, 
¬g
[0].d©a, s->logš.
Ën
);

422 
s
->
·sswd
.
Ën
 = 
¬g
[1].len;

423 
s
->
·sswd
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, s->·sswd.
Ën
);

424 ià(
s
->
·sswd
.
d©a
 =ğ
NULL
) {

425  
NGX_ERROR
;

428 
	`ngx_memıy
(
s
->
·sswd
.
d©a
, 
¬g
[1].d©a, s->·sswd.
Ën
);

430 
	`ngx_log_debug2
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

431 "pİ3‡pİ: \"%V\" \"%V\"", &
s
->
logš
, &s->
·sswd
);

433 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_APOP
;

435  
NGX_DONE
;

436 
	}
}

439 
ngx_št_t


440 
	$ngx_ma_pİ3_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

442 
ngx_št_t
 
rc
;

443 
ngx_ma_pİ3_¤v_cÚf_t
 *
pscf
;

445 #ià(
NGX_MAIL_SSL
)

446 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

447  
NGX_MAIL_PARSE_INVALID_COMMAND
;

451 
pscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_pİ3_moduË
);

453 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

454 
s
->
out
 = 
pscf
->
auth_ÿ·b™y
;

455 
s
->
¡©e
 = 0;

457  
NGX_OK
;

460 
rc
 = 
	`ngx_ma_auth_·r£
(
s
, 
c
);

462 
rc
) {

464 
NGX_MAIL_AUTH_LOGIN
:

466 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_u£ºame
);

467 
s
->
ma_¡©e
 = 
ngx_pİ3_auth_logš_u£ºame
;

469  
NGX_OK
;

471 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

473 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_·sswÜd
);

474 
s
->
ma_¡©e
 = 
ngx_pİ3_auth_logš_·sswÜd
;

476  
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 1);

478 
NGX_MAIL_AUTH_PLAIN
:

480 
	`ngx_¡r_£t
(&
s
->
out
, 
pİ3_Ãxt
);

481 
s
->
ma_¡©e
 = 
ngx_pİ3_auth_¶aš
;

483  
NGX_OK
;

485 
NGX_MAIL_AUTH_CRAM_MD5
:

487 ià(!(
pscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

488  
NGX_MAIL_PARSE_INVALID_COMMAND
;

491 ià(
	`ngx_ma_auth_üam_md5_§É
(
s
, 
c
, "+ ", 2è=ğ
NGX_OK
) {

492 
s
->
ma_¡©e
 = 
ngx_pİ3_auth_üam_md5
;

493  
NGX_OK
;

496  
NGX_ERROR
;

499  
rc
;

500 
	}
}

	@ngx_mail_pop3_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_pİ3_moduË.h
>

15 *
ngx_ma_pİ3_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_ma_pİ3_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chd
);

20 
ngx_¡r_t
 
	gngx_ma_pİ3_deçuÉ_ÿ·b™›s
[] = {

21 
ngx_¡ršg
("TOP"),

22 
ngx_¡ršg
("USER"),

23 
ngx_¡ršg
("UIDL"),

24 
ngx_nuÎ_¡ršg


28 
ngx_cÚf_b™mask_t
 
	gngx_ma_pİ3_auth_m‘hods
[] = {

29 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

30 { 
ngx_¡ršg
("­İ"), 
NGX_MAIL_AUTH_APOP_ENABLED
 },

31 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

32 { 
ngx_nuÎ_¡ršg
, 0 }

36 
ngx_¡r_t
 
	gngx_ma_pİ3_auth_¶aš_ÿ·b™y
 =

37 
ngx_¡ršg
("+OK m‘hod suµÜ‹d:" 
CRLF


38 "LOGIN" 
CRLF


39 "PLAIN" 
CRLF


40 "." 
CRLF
);

43 
ngx_¡r_t
 
	gngx_ma_pİ3_auth_üam_md5_ÿ·b™y
 =

44 
ngx_¡ršg
("+OK m‘hod suµÜ‹d:" 
CRLF


45 "LOGIN" 
CRLF


46 "PLAIN" 
CRLF


47 "CRAM-MD5" 
CRLF


48 "." 
CRLF
);

51 
ngx_ma_´ÙocŞ_t
 
	gngx_ma_pİ3_´ÙocŞ
 = {

52 
ngx_¡ršg
("pop3"),

54 
NGX_MAIL_POP3_PROTOCOL
,

56 
ngx_ma_pİ3_š™_£ssiÚ
,

57 
ngx_ma_pİ3_š™_´ÙocŞ
,

58 
ngx_ma_pİ3_·r£_commªd
,

59 
ngx_ma_pİ3_auth_¡©e
,

61 
ngx_¡ršg
("-ERR iÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

65 
ngx_commªd_t
 
	gngx_ma_pİ3_commªds
[] = {

67 { 
ngx_¡ršg
("pop3_capabilities"),

68 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

69 
ngx_ma_ÿ·b™›s
,

70 
NGX_MAIL_SRV_CONF_OFFSET
,

71 
off£tof
(
ngx_ma_pİ3_¤v_cÚf_t
, 
ÿ·b™›s
),

72 
NULL
 },

74 { 
ngx_¡ršg
("pop3_auth"),

75 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

76 
ngx_cÚf_£t_b™mask_¦Ù
,

77 
NGX_MAIL_SRV_CONF_OFFSET
,

78 
off£tof
(
ngx_ma_pİ3_¤v_cÚf_t
, 
auth_m‘hods
),

79 &
ngx_ma_pİ3_auth_m‘hods
 },

81 
ngx_nuÎ_commªd


85 
ngx_ma_moduË_t
 
	gngx_ma_pİ3_moduË_ùx
 = {

86 &
ngx_ma_pİ3_´ÙocŞ
,

88 
NULL
,

89 
NULL
,

91 
ngx_ma_pİ3_ü—‹_¤v_cÚf
,

92 
ngx_ma_pİ3_m”ge_¤v_cÚf


96 
ngx_moduË_t
 
	gngx_ma_pİ3_moduË
 = {

97 
NGX_MODULE_V1
,

98 &
ngx_ma_pİ3_moduË_ùx
,

99 
ngx_ma_pİ3_commªds
,

100 
NGX_MAIL_MODULE
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NGX_MODULE_V1_PADDING


113 
	$ngx_ma_pİ3_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

115 
ngx_ma_pİ3_¤v_cÚf_t
 *
pscf
;

117 
pscf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_pİ3_¤v_cÚf_t
));

118 ià(
pscf
 =ğ
NULL
) {

119  
NULL
;

122 ià(
	`ngx_¬¿y_š™
(&
pscf
->
ÿ·b™›s
, 
cf
->
poŞ
, 4, (
ngx_¡r_t
))

123 !ğ
NGX_OK
)

125  
NULL
;

128  
pscf
;

129 
	}
}

133 
	$ngx_ma_pİ3_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

135 
ngx_ma_pİ3_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

136 
ngx_ma_pİ3_¤v_cÚf_t
 *
cÚf
 = 
chd
;

138 
u_ch¬
 *
p
;

139 
size_t
 
size
, 
¡ls_Úly_size
;

140 
ngx_¡r_t
 *
c
, *
d
;

141 
ngx_ušt_t
 
i
;

143 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

144 
´ev
->
auth_m‘hods
,

145 (
NGX_CONF_BITMASK_SET


146 |
NGX_MAIL_AUTH_PLAIN_ENABLED
));

148 ià(
cÚf
->
ÿ·b™›s
.
ÃÉs
 == 0) {

149 
cÚf
->
ÿ·b™›s
 = 
´ev
->capabilities;

152 ià(
cÚf
->
ÿ·b™›s
.
ÃÉs
 == 0) {

154 
d
 = 
ngx_ma_pİ3_deçuÉ_ÿ·b™›s
; d->
Ën
; d++) {

155 
c
 = 
	`ngx_¬¿y_push
(&
cÚf
->
ÿ·b™›s
);

156 ià(
c
 =ğ
NULL
) {

157  
NGX_CONF_ERROR
;

160 *
c
 = *
d
;

164 
size
 = ("+OK C­ab™y†i¡ fŞlows" 
CRLF
) - 1

165 + ("." 
CRLF
) - 1;

167 
¡ls_Úly_size
 = 
size
 + ("STLS" 
CRLF
) - 1;

169 
c
 = 
cÚf
->
ÿ·b™›s
.
–ts
;

170 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

171 
size
 +ğ
c
[
i
].
Ën
 + (
CRLF
) - 1;

173 ià(
	`ngx_¡rÿ£cmp
(
c
[
i
].
d©a
, (
u_ch¬
 *) "USER") == 0) {

177 
¡ls_Úly_size
 +ğ
c
[
i
].
Ën
 + (
CRLF
) - 1;

180 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

181 
size
 +ğ("SASL LOGIN PLAIN CRAM-MD5" 
CRLF
) - 1;

184 
size
 +ğ("SASL LOGIN PLAIN" 
CRLF
) - 1;

187 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

188 ià(
p
 =ğ
NULL
) {

189  
NGX_CONF_ERROR
;

192 
cÚf
->
ÿ·b™y
.
Ën
 = 
size
;

193 
cÚf
->
ÿ·b™y
.
d©a
 = 
p
;

195 
p
 = 
	`ngx_ıymem
Õ, "+OK C­ab™y†i¡ fŞlows" 
CRLF
,

196 ("+OK C­ab™y†i¡ fŞlows" 
CRLF
) - 1);

198 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

199 
p
 = 
	`ngx_ıymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

200 *
p
++ = 
CR
; *p++ = 
LF
;

203 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

204 
p
 = 
	`ngx_ıymem
Õ, "SASL LOGIN PLAIN CRAM-MD5" 
CRLF
,

205 ("SASL LOGIN PLAIN CRAM-MD5" 
CRLF
) - 1);

208 
p
 = 
	`ngx_ıymem
Õ, "SASL LOGIN PLAIN" 
CRLF
,

209 ("SASL LOGIN PLAIN" 
CRLF
) - 1);

212 *
p
++ = '.'; *p++ = 
CR
; *°ğ
LF
;

215 
size
 +ğ("STLS" 
CRLF
) - 1;

217 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

218 ià(
p
 =ğ
NULL
) {

219  
NGX_CONF_ERROR
;

222 
cÚf
->
¡¬‰ls_ÿ·b™y
.
Ën
 = 
size
;

223 
cÚf
->
¡¬‰ls_ÿ·b™y
.
d©a
 = 
p
;

225 
p
 = 
	`ngx_ıymem
Õ, 
cÚf
->
ÿ·b™y
.
d©a
,

226 
cÚf
->
ÿ·b™y
.
Ën
 - (("." 
CRLF
) - 1));

228 
p
 = 
	`ngx_ıymem
Õ, "STLS" 
CRLF
, ("STLS" CRLF) - 1);

229 *
p
++ = '.'; *p++ = 
CR
; *°ğ
LF
;

232 ià(
cÚf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
) {

233 
cÚf
->
auth_ÿ·b™y
 = 
ngx_ma_pİ3_auth_üam_md5_ÿ·b™y
;

236 
cÚf
->
auth_ÿ·b™y
 = 
ngx_ma_pİ3_auth_¶aš_ÿ·b™y
;

240 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
¡ls_Úly_size
);

241 ià(
p
 =ğ
NULL
) {

242  
NGX_CONF_ERROR
;

245 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
Ën
 = 
¡ls_Úly_size
;

246 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
d©a
 = 
p
;

248 
p
 = 
	`ngx_ıymem
Õ, "+OK C­ab™y†i¡ fŞlows" 
CRLF
,

249 ("+OK C­ab™y†i¡ fŞlows" 
CRLF
) - 1);

251 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

252 ià(
	`ngx_¡rÿ£cmp
(
c
[
i
].
d©a
, (
u_ch¬
 *) "USER") == 0) {

256 
p
 = 
	`ngx_ıymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

257 *
p
++ = 
CR
; *p++ = 
LF
;

260 
p
 = 
	`ngx_ıymem
Õ, "STLS" 
CRLF
, ("STLS" CRLF) - 1);

261 *
p
++ = '.'; *p++ = 
CR
; *°ğ
LF
;

263  
NGX_CONF_OK
;

264 
	}
}

	@ngx_mail_pop3_module.h

8 #iâdeà
_NGX_MAIL_POP3_MODULE_H_INCLUDED_


9 
	#_NGX_MAIL_POP3_MODULE_H_INCLUDED_


	)

12 
	~<ngx_cÚfig.h
>

13 
	~<ngx_cÜe.h
>

14 
	~<ngx_ma.h
>

18 
ngx_¡r_t
 
	mÿ·b™y
;

19 
ngx_¡r_t
 
	m¡¬‰ls_ÿ·b™y
;

20 
ngx_¡r_t
 
	m¡¬‰ls_Úly_ÿ·b™y
;

21 
ngx_¡r_t
 
	mauth_ÿ·b™y
;

23 
ngx_ušt_t
 
	mauth_m‘hods
;

25 
ngx_¬¿y_t
 
	mÿ·b™›s
;

26 } 
	tngx_ma_pİ3_¤v_cÚf_t
;

29 
ngx_ma_pİ3_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

30 
ngx_ma_pİ3_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
);

31 
ngx_ma_pİ3_auth_¡©e
(
ngx_ev’t_t
 *
»v
);

32 
ngx_št_t
 
ngx_ma_pİ3_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
);

35 
ngx_moduË_t
 
ngx_ma_pİ3_moduË
;

	@ngx_mail_proxy_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ev’t_cÚÃù.h
>

12 
	~<ngx_ma.h
>

16 
ngx_æag_t
 
	m’abË
;

17 
ngx_æag_t
 
	m·ss_”rÜ_mes§ge
;

18 
ngx_æag_t
 
	mxş›Á
;

19 
size_t
 
	mbufãr_size
;

20 
ngx_m£c_t
 
	mtimeout
;

21 } 
	tngx_ma_´oxy_cÚf_t
;

24 
ngx_ma_´oxy_block_»ad
(
ngx_ev’t_t
 *
»v
);

25 
ngx_ma_´oxy_pİ3_hªdËr
(
ngx_ev’t_t
 *
»v
);

26 
ngx_ma_´oxy_im­_hªdËr
(
ngx_ev’t_t
 *
»v
);

27 
ngx_ma_´oxy_sm_hªdËr
(
ngx_ev’t_t
 *
»v
);

28 
ngx_ma_´oxy_dummy_hªdËr
(
ngx_ev’t_t
 *
ev
);

29 
ngx_št_t
 
ngx_ma_´oxy_»ad_»¥Ú£
(
ngx_ma_£ssiÚ_t
 *
s
,

30 
ngx_ušt_t
 
¡©e
);

31 
ngx_ma_´oxy_hªdËr
(
ngx_ev’t_t
 *
ev
);

32 
ngx_ma_´oxy_up¡»am_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
);

33 
ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
);

34 
ngx_ma_´oxy_şo£_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
);

35 *
ngx_ma_´oxy_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

36 *
ngx_ma_´oxy_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

37 *
chd
);

40 
ngx_commªd_t
 
	gngx_ma_´oxy_commªds
[] = {

42 { 
ngx_¡ršg
("proxy"),

43 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

44 
ngx_cÚf_£t_æag_¦Ù
,

45 
NGX_MAIL_SRV_CONF_OFFSET
,

46 
off£tof
(
ngx_ma_´oxy_cÚf_t
, 
’abË
),

47 
NULL
 },

49 { 
ngx_¡ršg
("proxy_buffer"),

50 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

51 
ngx_cÚf_£t_size_¦Ù
,

52 
NGX_MAIL_SRV_CONF_OFFSET
,

53 
off£tof
(
ngx_ma_´oxy_cÚf_t
, 
bufãr_size
),

54 
NULL
 },

56 { 
ngx_¡ršg
("proxy_timeout"),

57 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_cÚf_£t_m£c_¦Ù
,

59 
NGX_MAIL_SRV_CONF_OFFSET
,

60 
off£tof
(
ngx_ma_´oxy_cÚf_t
, 
timeout
),

61 
NULL
 },

63 { 
ngx_¡ršg
("proxy_pass_error_message"),

64 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

65 
ngx_cÚf_£t_æag_¦Ù
,

66 
NGX_MAIL_SRV_CONF_OFFSET
,

67 
off£tof
(
ngx_ma_´oxy_cÚf_t
, 
·ss_”rÜ_mes§ge
),

68 
NULL
 },

70 { 
ngx_¡ršg
("xclient"),

71 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

72 
ngx_cÚf_£t_æag_¦Ù
,

73 
NGX_MAIL_SRV_CONF_OFFSET
,

74 
off£tof
(
ngx_ma_´oxy_cÚf_t
, 
xş›Á
),

75 
NULL
 },

77 
ngx_nuÎ_commªd


81 
ngx_ma_moduË_t
 
	gngx_ma_´oxy_moduË_ùx
 = {

82 
NULL
,

84 
NULL
,

85 
NULL
,

87 
ngx_ma_´oxy_ü—‹_cÚf
,

88 
ngx_ma_´oxy_m”ge_cÚf


92 
ngx_moduË_t
 
	gngx_ma_´oxy_moduË
 = {

93 
NGX_MODULE_V1
,

94 &
ngx_ma_´oxy_moduË_ùx
,

95 
ngx_ma_´oxy_commªds
,

96 
NGX_MAIL_MODULE
,

97 
NULL
,

98 
NULL
,

99 
NULL
,

100 
NULL
,

101 
NULL
,

102 
NULL
,

103 
NULL
,

104 
NGX_MODULE_V1_PADDING


108 
u_ch¬
 
	gsm_auth_ok
[] = "235 2.0.0 OK" 
CRLF
;

112 
	$ngx_ma_´oxy_š™
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_addr_t
 *
³”
)

114 
k“·live
;

115 
ngx_št_t
 
rc
;

116 
ngx_ma_´oxy_ùx_t
 *
p
;

117 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

118 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

120 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "connectingo upstream";

122 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

124 ià(
cscf
->
so_k“·live
) {

125 
k“·live
 = 1;

127 ià(
	`£tsockİt
(
s
->
cÚÃùiÚ
->
fd
, 
SOL_SOCKET
, 
SO_KEEPALIVE
,

128 (cÚ¡ *è&
k“·live
, ())

131 
	`ngx_log_”rÜ
(
NGX_LOG_ALERT
, 
s
->
cÚÃùiÚ
->
log
, 
ngx_sock‘_”ºo
,

136 
p
 = 
	`ngx_pÿÎoc
(
s
->
cÚÃùiÚ
->
poŞ
, (
ngx_ma_´oxy_ùx_t
));

137 ià(
p
 =ğ
NULL
) {

138 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

142 
s
->
´oxy
 = 
p
;

144 
p
->
up¡»am
.
sockaddr
 = 
³”
->sockaddr;

145 
p
->
up¡»am
.
sockËn
 = 
³”
->socklen;

146 
p
->
up¡»am
.
Çme
 = &
³”
->name;

147 
p
->
up¡»am
.
g‘
 = 
ngx_ev’t_g‘_³”
;

148 
p
->
up¡»am
.
log
 = 
s
->
cÚÃùiÚ
->log;

149 
p
->
up¡»am
.
log_”rÜ
 = 
NGX_ERROR_ERR
;

151 
rc
 = 
	`ngx_ev’t_cÚÃù_³”
(&
p
->
up¡»am
);

153 ià(
rc
 =ğ
NGX_ERROR
 ||„ø=ğ
NGX_BUSY
 ||„ø=ğ
NGX_DECLINED
) {

154 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

158 
	`ngx_add_tim”
(
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
, 
cscf
->
timeout
);

160 
p
->
up¡»am
.
cÚÃùiÚ
->
d©a
 = 
s
;

161 
p
->
up¡»am
.
cÚÃùiÚ
->
poŞ
 = 
s
->connection->pool;

163 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_block_»ad
;

164 
p
->
up¡»am
.
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_dummy_hªdËr
;

166 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

168 
s
->
´oxy
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(s->
cÚÃùiÚ
->
poŞ
,

169 
pcf
->
bufãr_size
);

170 ià(
s
->
´oxy
->
bufãr
 =ğ
NULL
) {

171 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

175 
s
->
out
.
Ën
 = 0;

177 
s
->
´ÙocŞ
) {

179 
NGX_MAIL_POP3_PROTOCOL
:

180 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_pİ3_hªdËr
;

181 
s
->
ma_¡©e
 = 
ngx_pİ3_¡¬t
;

184 
NGX_MAIL_IMAP_PROTOCOL
:

185 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_im­_hªdËr
;

186 
s
->
ma_¡©e
 = 
ngx_im­_¡¬t
;

190 
p
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_sm_hªdËr
;

191 
s
->
ma_¡©e
 = 
ngx_sm_¡¬t
;

194 
	}
}

198 
	$ngx_ma_´oxy_block_»ad
(
ngx_ev’t_t
 *
»v
)

200 
ngx_cÚÃùiÚ_t
 *
c
;

201 
ngx_ma_£ssiÚ_t
 *
s
;

203 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy block„ead");

205 ià(
	`ngx_hªdË_»ad_ev’t
(
»v
, 0è!ğ
NGX_OK
) {

206 
c
 = 
»v
->
d©a
;

207 
s
 = 
c
->
d©a
;

209 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

211 
	}
}

215 
	$ngx_ma_´oxy_pİ3_hªdËr
(
ngx_ev’t_t
 *
»v
)

217 
u_ch¬
 *
p
;

218 
ngx_št_t
 
rc
;

219 
ngx_¡r_t
 
lše
;

220 
ngx_cÚÃùiÚ_t
 *
c
;

221 
ngx_ma_£ssiÚ_t
 *
s
;

222 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

224 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

227 
c
 = 
»v
->
d©a
;

228 
s
 = 
c
->
d©a
;

230 ià(
»v
->
timedout
) {

231 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

233 
c
->
timedout
 = 1;

234 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

238 
rc
 = 
	`ngx_ma_´oxy_»ad_»¥Ú£
(
s
, 0);

240 ià(
rc
 =ğ
NGX_AGAIN
) {

244 ià(
rc
 =ğ
NGX_ERROR
) {

245 
	`ngx_ma_´oxy_up¡»am_”rÜ
(
s
);

249 
s
->
ma_¡©e
) {

251 
ngx_pİ3_¡¬t
:

252 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send user");

254 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending user‚ameo upstream";

256 
lše
.
Ën
 = ("USER "è- 1 + 
s
->
logš
.len + 2;

257 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

258 ià(
lše
.
d©a
 =ğ
NULL
) {

259 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

263 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
, "USER ", ("USER ") - 1);

264 
p
 = 
	`ngx_ıymem
Õ, 
s
->
logš
.
d©a
, s->logš.
Ën
);

265 *
p
++ = 
CR
; *°ğ
LF
;

267 
s
->
ma_¡©e
 = 
ngx_pİ3_u£r
;

270 
ngx_pİ3_u£r
:

271 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send…ass");

273 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending…asswordo upstream";

275 
lše
.
Ën
 = ("PASS "è- 1 + 
s
->
·sswd
.len + 2;

276 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

277 ià(
lše
.
d©a
 =ğ
NULL
) {

278 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

282 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
, "PASS ", ("PASS ") - 1);

283 
p
 = 
	`ngx_ıymem
Õ, 
s
->
·sswd
.
d©a
, s->·sswd.
Ën
);

284 *
p
++ = 
CR
; *°ğ
LF
;

286 
s
->
ma_¡©e
 = 
ngx_pİ3_·sswd
;

289 
ngx_pİ3_·sswd
:

290 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

291 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

292 
»v
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

293 
c
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

295 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

296 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

297 
	`ngx_d–_tim”
(
c
->
»ad
);

299 
c
->
log
->
aùiÚ
 = 
NULL
;

300 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

302 
	`ngx_ma_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

307 #ià(
NGX_SUPPRESS_WARN
)

308 
	`ngx_¡r_nuÎ
(&
lše
);

313 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

318 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

322 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

323 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

324 
	}
}

328 
	$ngx_ma_´oxy_im­_hªdËr
(
ngx_ev’t_t
 *
»v
)

330 
u_ch¬
 *
p
;

331 
ngx_št_t
 
rc
;

332 
ngx_¡r_t
 
lše
;

333 
ngx_cÚÃùiÚ_t
 *
c
;

334 
ngx_ma_£ssiÚ_t
 *
s
;

335 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

337 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

340 
c
 = 
»v
->
d©a
;

341 
s
 = 
c
->
d©a
;

343 ià(
»v
->
timedout
) {

344 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

346 
c
->
timedout
 = 1;

347 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

351 
rc
 = 
	`ngx_ma_´oxy_»ad_»¥Ú£
(
s
, s->
ma_¡©e
);

353 ià(
rc
 =ğ
NGX_AGAIN
) {

357 ià(
rc
 =ğ
NGX_ERROR
) {

358 
	`ngx_ma_´oxy_up¡»am_”rÜ
(
s
);

362 
s
->
ma_¡©e
) {

364 
ngx_im­_¡¬t
:

365 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

368 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending LOGIN commando upstream";

370 
lše
.
Ën
 = 
s
->
g
.len + ("LOGIN ") - 1

371 + 1 + 
NGX_SIZE_T_LEN
 + 1 + 2;

372 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

373 ià(
lše
.
d©a
 =ğ
NULL
) {

374 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

378 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
, "%VLOGIN {%uz}" 
CRLF
,

379 &
s
->
g
, s->
logš
.
Ën
)

380 - 
lše
.
d©a
;

382 
s
->
ma_¡©e
 = 
ngx_im­_logš
;

385 
ngx_im­_logš
:

386 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy send user");

388 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending user‚ameo upstream";

390 
lše
.
Ën
 = 
s
->
logš
.ËÀ+ 1 + 1 + 
NGX_SIZE_T_LEN
 + 1 + 2;

391 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

392 ià(
lše
.
d©a
 =ğ
NULL
) {

393 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

397 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
, "%V {%uz}" 
CRLF
,

398 &
s
->
logš
, s->
·sswd
.
Ën
)

399 - 
lše
.
d©a
;

401 
s
->
ma_¡©e
 = 
ngx_im­_u£r
;

404 
ngx_im­_u£r
:

405 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

408 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending…asswordo upstream";

410 
lše
.
Ën
 = 
s
->
·sswd
.len + 2;

411 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

412 ià(
lše
.
d©a
 =ğ
NULL
) {

413 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

417 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
, 
s
->
·sswd
.d©a, s->·sswd.
Ën
);

418 *
p
++ = 
CR
; *°ğ
LF
;

420 
s
->
ma_¡©e
 = 
ngx_im­_·sswd
;

423 
ngx_im­_·sswd
:

424 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

425 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

426 
»v
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

427 
c
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

429 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

430 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

431 
	`ngx_d–_tim”
(
c
->
»ad
);

433 
c
->
log
->
aùiÚ
 = 
NULL
;

434 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

436 
	`ngx_ma_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

441 #ià(
NGX_SUPPRESS_WARN
)

442 
	`ngx_¡r_nuÎ
(&
lše
);

447 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

452 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

456 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

457 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

458 
	}
}

462 
	$ngx_ma_´oxy_sm_hªdËr
(
ngx_ev’t_t
 *
»v
)

464 
u_ch¬
 *
p
;

465 
ngx_št_t
 
rc
;

466 
ngx_¡r_t
 
lše
;

467 
ngx_buf_t
 *
b
;

468 
ngx_cÚÃùiÚ_t
 *
c
;

469 
ngx_ma_£ssiÚ_t
 *
s
;

470 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

471 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

473 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

476 
c
 = 
»v
->
d©a
;

477 
s
 = 
c
->
d©a
;

479 ià(
»v
->
timedout
) {

480 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

482 
c
->
timedout
 = 1;

483 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

487 
rc
 = 
	`ngx_ma_´oxy_»ad_»¥Ú£
(
s
, s->
ma_¡©e
);

489 ià(
rc
 =ğ
NGX_AGAIN
) {

493 ià(
rc
 =ğ
NGX_ERROR
) {

494 
	`ngx_ma_´oxy_up¡»am_”rÜ
(
s
);

498 
s
->
ma_¡©e
) {

500 
ngx_sm_¡¬t
:

501 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0, "mail…roxy sendƒhlo");

503 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending HELO/EHLOo upstream";

505 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

507 
lše
.
Ën
 = ("HELO "è- 1 + 
cscf
->
£rv”_Çme
.len + 2;

508 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

509 ià(
lše
.
d©a
 =ğ
NULL
) {

510 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

514 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

516 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
,

517 ((
s
->
esm
 || 
pcf
->
xş›Á
) ? "EHLO " : "HELO "),

520 
p
 = 
	`ngx_ıymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

521 *
p
++ = 
CR
; *°ğ
LF
;

523 ià(
pcf
->
xş›Á
) {

524 
s
->
ma_¡©e
 = 
ngx_sm_h–o_xş›Á
;

526 } ià(
s
->
auth_m‘hod
 =ğ
NGX_MAIL_AUTH_NONE
) {

527 
s
->
ma_¡©e
 = 
ngx_sm_h–o_äom
;

530 
s
->
ma_¡©e
 = 
ngx_sm_h–o
;

535 
ngx_sm_h–o_xş›Á
:

536 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

539 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending XCLIENTo upstream";

541 
lše
.
Ën
 = ("XCLIENT ADDR= LOGIN= NAME="

542 
CRLF
) - 1

543 + 
s
->
cÚÃùiÚ
->
addr_‹xt
.
Ën
 + s->
logš
.ËÀ+ s->
ho¡
.len;

545 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

546 ià(
lše
.
d©a
 =ğ
NULL
) {

547 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

551 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
,

552 "XCLIENT ADDR=%V%s%V NAME=%V" 
CRLF
,

553 &
s
->
cÚÃùiÚ
->
addr_‹xt
,

554 (
s
->
logš
.
Ën
 ? " LOGIN=" : ""), &s->logš, &s->
ho¡
)

555 - 
lše
.
d©a
;

557 ià(
s
->
sm_h–o
.
Ën
) {

558 
s
->
ma_¡©e
 = 
ngx_sm_xş›Á_h–o
;

560 } ià(
s
->
auth_m‘hod
 =ğ
NGX_MAIL_AUTH_NONE
) {

561 
s
->
ma_¡©e
 = 
ngx_sm_xş›Á_äom
;

564 
s
->
ma_¡©e
 = 
ngx_sm_xş›Á
;

569 
ngx_sm_xş›Á_h–o
:

570 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

573 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending client HELO/EHLOo upstream";

575 
lše
.
Ën
 = ("HELO " 
CRLF
è- 1 + 
s
->
sm_h–o
.len;

577 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

578 ià(
lše
.
d©a
 =ğ
NULL
) {

579 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

583 
lše
.
Ën
 = 
	`ngx_¥rštf
Öše.
d©a
,

584 ((
s
->
esm
è? "EHLO %V" 
CRLF
 : "HELO %V" CRLF),

585 &
s
->
sm_h–o
)

586 - 
lše
.
d©a
;

588 
s
->
ma_¡©e
 = (s->
auth_m‘hod
 =ğ
NGX_MAIL_AUTH_NONE
) ?

589 
ngx_sm_h–o_äom
 : 
ngx_sm_h–o
;

593 
ngx_sm_h–o_äom
:

594 
ngx_sm_xş›Á_äom
:

595 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

598 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending MAIL FROMo upstream";

600 
lše
.
Ën
 = 
s
->
sm_äom
.ËÀ+ (
CRLF
) - 1;

601 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

602 ià(
lše
.
d©a
 =ğ
NULL
) {

603 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

607 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
, 
s
->
sm_äom
.d©a, s->sm_äom.
Ën
);

608 *
p
++ = 
CR
; *°ğ
LF
;

610 
s
->
ma_¡©e
 = 
ngx_sm_äom
;

614 
ngx_sm_äom
:

615 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
»v
->
log
, 0,

618 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "sending RCPT TOo upstream";

620 
lše
.
Ën
 = 
s
->
sm_to
.ËÀ+ (
CRLF
) - 1;

621 
lše
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
,†še.
Ën
);

622 ià(
lše
.
d©a
 =ğ
NULL
) {

623 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

627 
p
 = 
	`ngx_ıymem
(
lše
.
d©a
, 
s
->
sm_to
.d©a, s->sm_to.
Ën
);

628 *
p
++ = 
CR
; *°ğ
LF
;

630 
s
->
ma_¡©e
 = 
ngx_sm_to
;

634 
ngx_sm_h–o
:

635 
ngx_sm_xş›Á
:

636 
ngx_sm_to
:

638 
b
 = 
s
->
´oxy
->
bufãr
;

640 ià(
s
->
auth_m‘hod
 =ğ
NGX_MAIL_AUTH_NONE
) {

641 
b
->
pos
 = b->
¡¬t
;

644 
	`ngx_memıy
(
b
->
¡¬t
, 
sm_auth_ok
, (smtp_auth_ok) - 1);

645 
b
->
Ï¡
 = b->
¡¬t
 + (
sm_auth_ok
) - 1;

648 
s
->
cÚÃùiÚ
->
»ad
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

649 
s
->
cÚÃùiÚ
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

650 
»v
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

651 
c
->
wr™e
->
hªdËr
 = 
ngx_ma_´oxy_hªdËr
;

653 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

654 
	`ngx_add_tim”
(
s
->
cÚÃùiÚ
->
»ad
, 
pcf
->
timeout
);

655 
	`ngx_d–_tim”
(
c
->
»ad
);

657 
c
->
log
->
aùiÚ
 = 
NULL
;

658 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "client†ogged in");

660 
	`ngx_ma_´oxy_hªdËr
(
s
->
cÚÃùiÚ
->
wr™e
);

665 #ià(
NGX_SUPPRESS_WARN
)

666 
	`ngx_¡r_nuÎ
(&
lše
);

671 ià(
c
->
	`£nd
(c, 
lše
.
d©a
,†še.
Ën
è< (
ssize_t
)†ine.len) {

676 
	`ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
s
);

680 
s
->
´oxy
->
bufãr
->
pos
 = s->´oxy->bufãr->
¡¬t
;

681 
s
->
´oxy
->
bufãr
->
Ï¡
 = s->´oxy->bufãr->
¡¬t
;

682 
	}
}

686 
	$ngx_ma_´oxy_dummy_hªdËr
(
ngx_ev’t_t
 *
wev
)

688 
ngx_cÚÃùiÚ_t
 *
c
;

689 
ngx_ma_£ssiÚ_t
 *
s
;

691 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
wev
->
log
, 0, "mail…roxy dummy handler");

693 ià(
	`ngx_hªdË_wr™e_ev’t
(
wev
, 0è!ğ
NGX_OK
) {

694 
c
 = 
wev
->
d©a
;

695 
s
 = 
c
->
d©a
;

697 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

699 
	}
}

702 
ngx_št_t


703 
	$ngx_ma_´oxy_»ad_»¥Ú£
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_ušt_t
 
¡©e
)

705 
u_ch¬
 *
p
;

706 
ssize_t
 
n
;

707 
ngx_buf_t
 *
b
;

708 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

710 
s
->
cÚÃùiÚ
->
log
->
aùiÚ
 = "reading„esponse from upstream";

712 
b
 = 
s
->
´oxy
->
bufãr
;

714 
n
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
	`»cv
(s->proxy->upstream.connection,

715 
b
->
Ï¡
, b->
’d
 - b->last);

717 ià(
n
 =ğ
NGX_ERROR
 ||‚ == 0) {

718  
NGX_ERROR
;

721 ià(
n
 =ğ
NGX_AGAIN
) {

722  
NGX_AGAIN
;

725 
b
->
Ï¡
 +ğ
n
;

727 ià(
b
->
Ï¡
 - b->
pos
 < 4) {

728  
NGX_AGAIN
;

731 ià(*(
b
->
Ï¡
 - 2è!ğ
CR
 || *(b->Ï¡ - 1è!ğ
LF
) {

732 ià(
b
->
Ï¡
 =ğb->
’d
) {

733 *(
b
->
Ï¡
 - 1) = '\0';

734 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

736 
b
->
pos
);

737  
NGX_ERROR
;

740  
NGX_AGAIN
;

743 
p
 = 
b
->
pos
;

745 
s
->
´ÙocŞ
) {

747 
NGX_MAIL_POP3_PROTOCOL
:

748 ià(
p
[0] == '+' &&…[1] == 'O' &&…[2] == 'K') {

749  
NGX_OK
;

753 
NGX_MAIL_IMAP_PROTOCOL
:

754 
¡©e
) {

756 
ngx_im­_¡¬t
:

757 ià(
p
[0] == '*' &&…[1] == ' ' &&…[2] == 'O' &&…[3] == 'K') {

758  
NGX_OK
;

762 
ngx_im­_logš
:

763 
ngx_im­_u£r
:

764 ià(
p
[0] == '+') {

765  
NGX_OK
;

769 
ngx_im­_·sswd
:

770 ià(
	`ngx_¡ºcmp
(
p
, 
s
->
g
.
d©a
, s->g.
Ën
) == 0) {

771 
p
 +ğ
s
->
g
.
Ën
;

772 ià(
p
[0] == 'O' &&…[1] == 'K') {

773  
NGX_OK
;

782 
¡©e
) {

784 
ngx_sm_¡¬t
:

785 ià(
p
[0] == '2' &&…[1] == '2' &&…[2] == '0') {

786  
NGX_OK
;

790 
ngx_sm_h–o
:

791 
ngx_sm_h–o_xş›Á
:

792 
ngx_sm_h–o_äom
:

793 
ngx_sm_äom
:

794 ià(
p
[0] == '2' &&…[1] == '5' &&…[2] == '0') {

795  
NGX_OK
;

799 
ngx_sm_xş›Á
:

800 
ngx_sm_xş›Á_äom
:

801 
ngx_sm_xş›Á_h–o
:

802 ià(
p
[0] == '2' && (p[1] == '2' ||…[1] == '5') &&…[2] == '0') {

803  
NGX_OK
;

807 
ngx_sm_to
:

808  
NGX_OK
;

814 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

816 ià(
pcf
->
·ss_”rÜ_mes§ge
 == 0) {

817 *(
b
->
Ï¡
 - 2) = '\0';

818 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
s
->
cÚÃùiÚ
->
log
, 0,

819 "up¡»am s’ˆšv®id„e¥Ú£: \"%s\"", 
p
);

820  
NGX_ERROR
;

823 
s
->
out
.
Ën
 = 
b
->
Ï¡
 - 
p
 - 2;

824 
s
->
out
.
d©a
 = 
p
;

826 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
s
->
cÚÃùiÚ
->
log
, 0,

827 "up¡»am s’ˆšv®id„e¥Ú£: \"%V\"", &
s
->
out
);

829 
s
->
out
.
Ën
 = 
b
->
Ï¡
 - b->
pos
;

830 
s
->
out
.
d©a
 = 
b
->
pos
;

832  
NGX_ERROR
;

833 
	}
}

837 
	$ngx_ma_´oxy_hªdËr
(
ngx_ev’t_t
 *
ev
)

839 *
aùiÚ
, *
»cv_aùiÚ
, *
£nd_aùiÚ
;

840 
size_t
 
size
;

841 
ssize_t
 
n
;

842 
ngx_buf_t
 *
b
;

843 
ngx_ušt_t
 
do_wr™e
;

844 
ngx_cÚÃùiÚ_t
 *
c
, *
¤c
, *
d¡
;

845 
ngx_ma_£ssiÚ_t
 *
s
;

846 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

848 
c
 = 
ev
->
d©a
;

849 
s
 = 
c
->
d©a
;

851 ià(
ev
->
timedout
) {

852 
c
->
log
->
aùiÚ
 = "proxying";

854 ià(
c
 =ğ
s
->
cÚÃùiÚ
) {

855 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

857 
c
->
timedout
 = 1;

860 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
,

864 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

868 ià(
c
 =ğ
s
->
cÚÃùiÚ
) {

869 ià(
ev
->
wr™e
) {

870 
»cv_aùiÚ
 = "proxying‡nd„eading from upstream";

871 
£nd_aùiÚ
 = "proxying‡nd sendingo client";

872 
¤c
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
;

873 
d¡
 = 
c
;

874 
b
 = 
s
->
´oxy
->
bufãr
;

877 
»cv_aùiÚ
 = "proxying‡nd„eading from client";

878 
£nd_aùiÚ
 = "proxying‡nd sendingo upstream";

879 
¤c
 = 
c
;

880 
d¡
 = 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
;

881 
b
 = 
s
->
bufãr
;

885 ià(
ev
->
wr™e
) {

886 
»cv_aùiÚ
 = "proxying‡nd„eading from client";

887 
£nd_aùiÚ
 = "proxying‡nd sendingo upstream";

888 
¤c
 = 
s
->
cÚÃùiÚ
;

889 
d¡
 = 
c
;

890 
b
 = 
s
->
bufãr
;

893 
»cv_aùiÚ
 = "proxying‡nd„eading from upstream";

894 
£nd_aùiÚ
 = "proxying‡nd sendingo client";

895 
¤c
 = 
c
;

896 
d¡
 = 
s
->
cÚÃùiÚ
;

897 
b
 = 
s
->
´oxy
->
bufãr
;

901 
do_wr™e
 = 
ev
->
wr™e
 ? 1 : 0;

903 
	`ngx_log_debug3
(
NGX_LOG_DEBUG_MAIL
, 
ev
->
log
, 0,

905 
do_wr™e
, 
¤c
->
fd
, 
d¡
->fd);

909 ià(
do_wr™e
) {

911 
size
 = 
b
->
Ï¡
 - b->
pos
;

913 ià(
size
 && 
d¡
->
wr™e
->
»ady
) {

914 
c
->
log
->
aùiÚ
 = 
£nd_aùiÚ
;

916 
n
 = 
d¡
->
	`£nd
(d¡, 
b
->
pos
, 
size
);

918 ià(
n
 =ğ
NGX_ERROR
) {

919 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

923 ià(
n
 > 0) {

924 
b
->
pos
 +ğ
n
;

926 ià(
b
->
pos
 =ğb->
Ï¡
) {

927 
b
->
pos
 = b->
¡¬t
;

928 
b
->
Ï¡
 = b->
¡¬t
;

934 
size
 = 
b
->
’d
 - b->
Ï¡
;

936 ià(
size
 && 
¤c
->
»ad
->
»ady
) {

937 
c
->
log
->
aùiÚ
 = 
»cv_aùiÚ
;

939 
n
 = 
¤c
->
	`»cv
(¤c, 
b
->
Ï¡
, 
size
);

941 ià(
n
 =ğ
NGX_AGAIN
 ||‚ == 0) {

945 ià(
n
 > 0) {

946 
do_wr™e
 = 1;

947 
b
->
Ï¡
 +ğ
n
;

952 ià(
n
 =ğ
NGX_ERROR
) {

953 
¤c
->
»ad
->
eof
 = 1;

960 
c
->
log
->
aùiÚ
 = "proxying";

962 ià((
s
->
cÚÃùiÚ
->
»ad
->
eof
 && s->
bufãr
->
pos
 =ğs->bufãr->
Ï¡
)

963 || (
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
eof


964 && 
s
->
´oxy
->
bufãr
->
pos
 =ğs->´oxy->bufãr->
Ï¡
)

965 || (
s
->
cÚÃùiÚ
->
»ad
->
eof


966 && 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
»ad
->
eof
))

968 
aùiÚ
 = 
c
->
log
->action;

969 
c
->
log
->
aùiÚ
 = 
NULL
;

970 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, "proxied session done");

971 
c
->
log
->
aùiÚ
 =‡ction;

973 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

977 ià(
	`ngx_hªdË_wr™e_ev’t
(
d¡
->
wr™e
, 0è!ğ
NGX_OK
) {

978 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

982 ià(
	`ngx_hªdË_»ad_ev’t
(
d¡
->
»ad
, 0è!ğ
NGX_OK
) {

983 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

987 ià(
	`ngx_hªdË_wr™e_ev’t
(
¤c
->
wr™e
, 0è!ğ
NGX_OK
) {

988 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

992 ià(
	`ngx_hªdË_»ad_ev’t
(
¤c
->
»ad
, 0è!ğ
NGX_OK
) {

993 
	`ngx_ma_´oxy_şo£_£ssiÚ
(
s
);

997 ià(
c
 =ğ
s
->
cÚÃùiÚ
) {

998 
pcf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_´oxy_moduË
);

999 
	`ngx_add_tim”
(
c
->
»ad
, 
pcf
->
timeout
);

1001 
	}
}

1005 
	$ngx_ma_´oxy_up¡»am_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
)

1007 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1008 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1010 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1012 
	`ngx_şo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1015 ià(
s
->
out
.
Ën
 == 0) {

1016 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1020 
s
->
qu™
 = 1;

1021 
	`ngx_ma_£nd
(
s
->
cÚÃùiÚ
->
wr™e
);

1022 
	}
}

1026 
	$ngx_ma_´oxy_š‹º®_£rv”_”rÜ
(
ngx_ma_£ssiÚ_t
 *
s
)

1028 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1029 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1031 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1033 
	`ngx_şo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1036 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

1037 
	}
}

1041 
	$ngx_ma_´oxy_şo£_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
)

1043 ià(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
) {

1044 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
s
->
cÚÃùiÚ
->
log
, 0,

1046 
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
->
fd
);

1048 
	`ngx_şo£_cÚÃùiÚ
(
s
->
´oxy
->
up¡»am
.
cÚÃùiÚ
);

1051 
	`ngx_ma_şo£_cÚÃùiÚ
(
s
->
cÚÃùiÚ
);

1052 
	}
}

1056 
	$ngx_ma_´oxy_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

1058 
ngx_ma_´oxy_cÚf_t
 *
pcf
;

1060 
pcf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_´oxy_cÚf_t
));

1061 ià(
pcf
 =ğ
NULL
) {

1062  
NULL
;

1065 
pcf
->
’abË
 = 
NGX_CONF_UNSET
;

1066 
pcf
->
·ss_”rÜ_mes§ge
 = 
NGX_CONF_UNSET
;

1067 
pcf
->
xş›Á
 = 
NGX_CONF_UNSET
;

1068 
pcf
->
bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

1069 
pcf
->
timeout
 = 
NGX_CONF_UNSET_MSEC
;

1071  
pcf
;

1072 
	}
}

1076 
	$ngx_ma_´oxy_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

1078 
ngx_ma_´oxy_cÚf_t
 *
´ev
 = 
·»Á
;

1079 
ngx_ma_´oxy_cÚf_t
 *
cÚf
 = 
chd
;

1081 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

1082 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
·ss_”rÜ_mes§ge
, 
´ev
->pass_error_message, 0);

1083 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
xş›Á
, 
´ev
->xclient, 1);

1084 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
bufãr_size
, 
´ev
->buffer_size,

1085 (
size_t
è
ngx_·gesize
);

1086 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
timeout
, 
´ev
->timeout, 24 * 60 * 60000);

1088  
NGX_CONF_OK
;

1089 
	}
}

	@ngx_mail_smtp_handler.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_sm_moduË.h
>

15 
ngx_ma_sm_»sŞve_addr_hªdËr
(
ngx_»sŞv”_ùx_t
 *
ùx
);

16 
ngx_ma_sm_»sŞve_Çme
(
ngx_ev’t_t
 *
»v
);

17 
ngx_ma_sm_»sŞve_Çme_hªdËr
(
ngx_»sŞv”_ùx_t
 *
ùx
);

18 
ngx_ma_sm_g»‘šg
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

19 
ngx_ma_sm_šv®id_p–ššg
(
ngx_ev’t_t
 *
»v
);

20 
ngx_št_t
 
ngx_ma_sm_ü—‹_bufãr
(
ngx_ma_£ssiÚ_t
 *
s
,

21 
ngx_cÚÃùiÚ_t
 *
c
);

23 
ngx_št_t
 
ngx_ma_sm_h–o
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

24 
ngx_št_t
 
ngx_ma_sm_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

25 
ngx_št_t
 
ngx_ma_sm_ma
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

26 
ngx_št_t
 
ngx_ma_sm_¡¬‰ls
(
ngx_ma_£ssiÚ_t
 *
s
,

27 
ngx_cÚÃùiÚ_t
 *
c
);

28 
ngx_št_t
 
ngx_ma_sm_r£t
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

29 
ngx_št_t
 
ngx_ma_sm_rıt
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

31 
ngx_št_t
 
ngx_ma_sm_disÿrd_commªd
(
ngx_ma_£ssiÚ_t
 *
s
,

32 
ngx_cÚÃùiÚ_t
 *
c
, *
”r
);

33 
ngx_ma_sm_log_»jeùed_commªd
(
ngx_ma_£ssiÚ_t
 *
s
,

34 
ngx_cÚÃùiÚ_t
 *
c
, *
”r
);

37 
u_ch¬
 
	gsm_ok
[] = "250 2.0.0 OK" 
CRLF
;

38 
u_ch¬
 
	gsm_bye
[] = "221 2.0.0 Bye" 
CRLF
;

39 
u_ch¬
 
	gsm_¡¬‰ls
[] = "220 2.0.0 S¹ TLS" 
CRLF
;

40 
u_ch¬
 
	gsm_Ãxt
[] = "334 " 
CRLF
;

41 
u_ch¬
 
	gsm_u£ºame
[] = "334 VXNlcm5hbWU6" 
CRLF
;

42 
u_ch¬
 
	gsm_·sswÜd
[] = "334 UGFzc3dvcmQ6" 
CRLF
;

43 
u_ch¬
 
	gsm_šv®id_commªd
[] = "500 5.5.1 Inv®id commªd" 
CRLF
;

44 
u_ch¬
 
	gsm_šv®id_p–ššg
[] =

45 "503 5.5.0 Im´İ” u£ oàSMTP commªd…–ššg" 
CRLF
;

46 
u_ch¬
 
	gsm_šv®id_¬gum’t
[] = "501 5.5.4 Inv®id‡rgum’t" 
CRLF
;

47 
u_ch¬
 
	gsm_auth_»quœed
[] = "530 5.7.1 Auth’tiÿtiÚ„equœed" 
CRLF
;

48 
u_ch¬
 
	gsm_bad_£qu’û
[] = "503 5.5.1 Bad sequ’û oàcommªds" 
CRLF
;

51 
ngx_¡r_t
 
	gsm_uÇvaabË
 = 
ngx_¡ršg
("[UNAVAILABLE]");

52 
ngx_¡r_t
 
	gsm_‹mpuÇva
 = 
ngx_¡ršg
("[TEMPUNAVAIL]");

56 
	$ngx_ma_sm_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

58 
sockaddr_š
 *
sš
;

59 
ngx_»sŞv”_ùx_t
 *
ùx
;

60 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

62 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

64 ià(
cscf
->
»sŞv”
 =ğ
NULL
) {

65 
s
->
ho¡
 = 
sm_uÇvaabË
;

66 
	`ngx_ma_sm_g»‘šg
(
s
, 
c
);

70 ià(
c
->
sockaddr
->
§_çmy
 !ğ
AF_INET
) {

71 
s
->
ho¡
 = 
sm_‹mpuÇva
;

72 
	`ngx_ma_sm_g»‘šg
(
s
, 
c
);

76 
c
->
log
->
aùiÚ
 = "in„esolving client‡ddress";

78 
ùx
 = 
	`ngx_»sŞve_¡¬t
(
cscf
->
»sŞv”
, 
NULL
);

79 ià(
ùx
 =ğ
NULL
) {

80 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

86 
sš
 = (
sockaddr_š
 *è
c
->
sockaddr
;

88 
ùx
->
addr
 = 
sš
->
sš_addr
.
s_addr
;

89 
ùx
->
hªdËr
 = 
ngx_ma_sm_»sŞve_addr_hªdËr
;

90 
ùx
->
d©a
 = 
s
;

91 
ùx
->
timeout
 = 
cscf
->
»sŞv”_timeout
;

93 ià(
	`ngx_»sŞve_addr
(
ùx
è!ğ
NGX_OK
) {

94 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

96 
	}
}

100 
	$ngx_ma_sm_»sŞve_addr_hªdËr
(
ngx_»sŞv”_ùx_t
 *
ùx
)

102 
ngx_cÚÃùiÚ_t
 *
c
;

103 
ngx_ma_£ssiÚ_t
 *
s
;

105 
s
 = 
ùx
->
d©a
;

106 
c
 = 
s
->
cÚÃùiÚ
;

108 ià(
ùx
->
¡©e
) {

109 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

111 &
c
->
addr_‹xt
, 
ùx
->
¡©e
,

112 
	`ngx_»sŞv”_¡»¼Ü
(
ùx
->
¡©e
));

114 ià(
ùx
->
¡©e
 =ğ
NGX_RESOLVE_NXDOMAIN
) {

115 
s
->
ho¡
 = 
sm_uÇvaabË
;

118 
s
->
ho¡
 = 
sm_‹mpuÇva
;

121 
	`ngx_»sŞve_addr_dÚe
(
ùx
);

123 
	`ngx_ma_sm_g»‘šg
(
s
, s->
cÚÃùiÚ
);

128 
c
->
log
->
aùiÚ
 = "in„esolving client hostname";

130 
s
->
ho¡
.
d©a
 = 
	`ngx_p¡rdup
(
c
->
poŞ
, &
ùx
->
Çme
);

131 ià(
s
->
ho¡
.
d©a
 =ğ
NULL
) {

132 
	`ngx_»sŞve_addr_dÚe
(
ùx
);

133 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

137 
s
->
ho¡
.
Ën
 = 
ùx
->
Çme
.len;

139 
	`ngx_»sŞve_addr_dÚe
(
ùx
);

141 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

142 "add»s »sŞved: %V", &
s
->
ho¡
);

144 
c
->
»ad
->
hªdËr
 = 
ngx_ma_sm_»sŞve_Çme
;

146 
	`ngx_po¡_ev’t
(
c
->
»ad
, &
ngx_po¡ed_ev’ts
);

147 
	}
}

151 
	$ngx_ma_sm_»sŞve_Çme
(
ngx_ev’t_t
 *
»v
)

153 
ngx_cÚÃùiÚ_t
 *
c
;

154 
ngx_ma_£ssiÚ_t
 *
s
;

155 
ngx_»sŞv”_ùx_t
 *
ùx
;

156 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

158 
c
 = 
»v
->
d©a
;

159 
s
 = 
c
->
d©a
;

161 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

163 
ùx
 = 
	`ngx_»sŞve_¡¬t
(
cscf
->
»sŞv”
, 
NULL
);

164 ià(
ùx
 =ğ
NULL
) {

165 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

169 
ùx
->
Çme
 = 
s
->
ho¡
;

170 
ùx
->
ty³
 = 
NGX_RESOLVE_A
;

171 
ùx
->
hªdËr
 = 
ngx_ma_sm_»sŞve_Çme_hªdËr
;

172 
ùx
->
d©a
 = 
s
;

173 
ùx
->
timeout
 = 
cscf
->
»sŞv”_timeout
;

175 ià(
	`ngx_»sŞve_Çme
(
ùx
è!ğ
NGX_OK
) {

176 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

178 
	}
}

182 
	$ngx_ma_sm_»sŞve_Çme_hªdËr
(
ngx_»sŞv”_ùx_t
 *
ùx
)

184 
š_addr_t
 
addr
;

185 
ngx_ušt_t
 
i
;

186 
ngx_cÚÃùiÚ_t
 *
c
;

187 
sockaddr_š
 *
sš
;

188 
ngx_ma_£ssiÚ_t
 *
s
;

190 
s
 = 
ùx
->
d©a
;

191 
c
 = 
s
->
cÚÃùiÚ
;

193 ià(
ùx
->
¡©e
) {

194 
	`ngx_log_”rÜ
(
NGX_LOG_ERR
, 
c
->
log
, 0,

196 &
ùx
->
Çme
, ctx->
¡©e
,

197 
	`ngx_»sŞv”_¡»¼Ü
(
ùx
->
¡©e
));

199 ià(
ùx
->
¡©e
 =ğ
NGX_RESOLVE_NXDOMAIN
) {

200 
s
->
ho¡
 = 
sm_uÇvaabË
;

203 
s
->
ho¡
 = 
sm_‹mpuÇva
;

210 
sš
 = (
sockaddr_š
 *è
c
->
sockaddr
;

212 
i
 = 0; i < 
ùx
->
Çddrs
; i++) {

214 
addr
 = 
ùx
->
addrs
[
i
];

216 
	`ngx_log_debug4
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

218 (
	`Áohl
(
addr
) >> 24) & 0xff,

219 (
	`Áohl
(
addr
) >> 16) & 0xff,

220 (
	`Áohl
(
addr
) >> 8) & 0xff,

221 
	`Áohl
(
addr
) & 0xff);

223 ià(
addr
 =ğ
sš
->
sš_addr
.
s_addr
) {

224 
found
;

228 
s
->
ho¡
 = 
sm_uÇvaabË
;

231 
found
:

233 
	`ngx_»sŞve_Çme_dÚe
(
ùx
);

235 
	`ngx_ma_sm_g»‘šg
(
s
, 
c
);

236 
	}
}

240 
	$ngx_ma_sm_g»‘šg
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

242 
ngx_m£c_t
 
timeout
;

243 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

244 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

246 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

247 "sm g»‘šg fÜ \"%V\"", &
s
->
ho¡
);

249 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

250 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

252 
timeout
 = 
sscf
->
g»‘šg_d–ay
 ? sscf->g»‘šg_d–ay : 
cscf
->timeout;

253 
	`ngx_add_tim”
(
c
->
»ad
, 
timeout
);

255 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

256 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

259 ià(
sscf
->
g»‘šg_d–ay
) {

260 
c
->
»ad
->
hªdËr
 = 
ngx_ma_sm_šv®id_p–ššg
;

264 
c
->
»ad
->
hªdËr
 = 
ngx_ma_sm_š™_´ÙocŞ
;

266 
s
->
out
 = 
sscf
->
g»‘šg
;

268 
	`ngx_ma_£nd
(
c
->
wr™e
);

269 
	}
}

273 
	$ngx_ma_sm_šv®id_p–ššg
(
ngx_ev’t_t
 *
»v
)

275 
ngx_cÚÃùiÚ_t
 *
c
;

276 
ngx_ma_£ssiÚ_t
 *
s
;

277 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

278 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

280 
c
 = 
»v
->
d©a
;

281 
s
 = 
c
->
d©a
;

283 
c
->
log
->
aùiÚ
 = "in delay…ipelining state";

285 ià(
»v
->
timedout
) {

287 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "delay greeting");

289 
»v
->
timedout
 = 0;

291 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

293 
c
->
»ad
->
hªdËr
 = 
ngx_ma_sm_š™_´ÙocŞ
;

295 
	`ngx_add_tim”
(
c
->
»ad
, 
cscf
->
timeout
);

297 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

298 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

302 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

304 
s
->
out
 = 
sscf
->
g»‘šg
;

308 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "invalid…ipelining");

310 ià(
s
->
bufãr
 =ğ
NULL
) {

311 ià(
	`ngx_ma_sm_ü—‹_bufãr
(
s
, 
c
è!ğ
NGX_OK
) {

316 ià(
	`ngx_ma_sm_disÿrd_commªd
(
s
, 
c
,

318 !ğ
NGX_OK
)

323 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_p–ššg
);

326 
	`ngx_ma_£nd
(
c
->
wr™e
);

327 
	}
}

331 
	$ngx_ma_sm_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
)

333 
ngx_cÚÃùiÚ_t
 *
c
;

334 
ngx_ma_£ssiÚ_t
 *
s
;

336 
c
 = 
»v
->
d©a
;

338 
c
->
log
->
aùiÚ
 = "in‡uth state";

340 ià(
»v
->
timedout
) {

341 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

342 
c
->
timedout
 = 1;

343 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

347 
s
 = 
c
->
d©a
;

349 ià(
s
->
bufãr
 =ğ
NULL
) {

350 ià(
	`ngx_ma_sm_ü—‹_bufãr
(
s
, 
c
è!ğ
NGX_OK
) {

355 
s
->
ma_¡©e
 = 
ngx_sm_¡¬t
;

356 
c
->
»ad
->
hªdËr
 = 
ngx_ma_sm_auth_¡©e
;

358 
	`ngx_ma_sm_auth_¡©e
(
»v
);

359 
	}
}

362 
ngx_št_t


363 
	$ngx_ma_sm_ü—‹_bufãr
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

365 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

367 ià(
	`ngx_¬¿y_š™
(&
s
->
¬gs
, 
c
->
poŞ
, 2, (
ngx_¡r_t
)è=ğ
NGX_ERROR
) {

368 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

369  
NGX_ERROR
;

372 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

374 
s
->
bufãr
 = 
	`ngx_ü—‹_‹mp_buf
(
c
->
poŞ
, 
sscf
->
ş›Á_bufãr_size
);

375 ià(
s
->
bufãr
 =ğ
NULL
) {

376 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

377  
NGX_ERROR
;

380  
NGX_OK
;

381 
	}
}

385 
	$ngx_ma_sm_auth_¡©e
(
ngx_ev’t_t
 *
»v
)

387 
ngx_št_t
 
rc
;

388 
ngx_cÚÃùiÚ_t
 *
c
;

389 
ngx_ma_£ssiÚ_t
 *
s
;

391 
c
 = 
»v
->
d©a
;

392 
s
 = 
c
->
d©a
;

394 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "smtp‡uth state");

396 ià(
»v
->
timedout
) {

397 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 
NGX_ETIMEDOUT
, "clientimed out");

398 
c
->
timedout
 = 1;

399 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

403 ià(
s
->
out
.
Ën
) {

404 
	`ngx_log_debug0
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0, "smtp send handler busy");

405 
s
->
blocked
 = 1;

409 
s
->
blocked
 = 0;

411 
rc
 = 
	`ngx_ma_»ad_commªd
(
s
, 
c
);

413 ià(
rc
 =ğ
NGX_AGAIN
 ||„ø=ğ
NGX_ERROR
) {

417 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

419 ià(
rc
 =ğ
NGX_OK
) {

420 
s
->
ma_¡©e
) {

422 
ngx_sm_¡¬t
:

424 
s
->
commªd
) {

426 
NGX_SMTP_HELO
:

427 
NGX_SMTP_EHLO
:

428 
rc
 = 
	`ngx_ma_sm_h–o
(
s
, 
c
);

431 
NGX_SMTP_AUTH
:

432 
rc
 = 
	`ngx_ma_sm_auth
(
s
, 
c
);

435 
NGX_SMTP_QUIT
:

436 
s
->
qu™
 = 1;

437 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bye
);

440 
NGX_SMTP_MAIL
:

441 
rc
 = 
	`ngx_ma_sm_ma
(
s
, 
c
);

444 
NGX_SMTP_RCPT
:

445 
rc
 = 
	`ngx_ma_sm_rıt
(
s
, 
c
);

448 
NGX_SMTP_RSET
:

449 
rc
 = 
	`ngx_ma_sm_r£t
(
s
, 
c
);

452 
NGX_SMTP_NOOP
:

455 
NGX_SMTP_STARTTLS
:

456 
rc
 = 
	`ngx_ma_sm_¡¬‰ls
(
s
, 
c
);

457 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_¡¬‰ls
);

461 
rc
 = 
NGX_MAIL_PARSE_INVALID_COMMAND
;

467 
ngx_sm_auth_logš_u£ºame
:

468 
rc
 = 
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 0);

470 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_·sswÜd
);

471 
s
->
ma_¡©e
 = 
ngx_sm_auth_logš_·sswÜd
;

474 
ngx_sm_auth_logš_·sswÜd
:

475 
rc
 = 
	`ngx_ma_auth_logš_·sswÜd
(
s
, 
c
);

478 
ngx_sm_auth_¶aš
:

479 
rc
 = 
	`ngx_ma_auth_¶aš
(
s
, 
c
, 0);

482 
ngx_sm_auth_üam_md5
:

483 
rc
 = 
	`ngx_ma_auth_üam_md5
(
s
, 
c
);

488 
rc
) {

490 
NGX_DONE
:

491 
	`ngx_ma_auth
(
s
, 
c
);

494 
NGX_ERROR
:

495 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

498 
NGX_MAIL_PARSE_INVALID_COMMAND
:

499 
s
->
ma_¡©e
 = 
ngx_sm_¡¬t
;

500 
s
->
¡©e
 = 0;

501 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_commªd
);

505 
NGX_OK
:

506 
s
->
¬gs
.
ÃÉs
 = 0;

507 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

508 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

510 ià(
s
->
¡©e
) {

511 
s
->
¬g_¡¬t
 = s->
bufãr
->
¡¬t
;

514 
	`ngx_ma_£nd
(
c
->
wr™e
);

516 
	}
}

519 
ngx_št_t


520 
	$ngx_ma_sm_h–o
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

522 
ngx_¡r_t
 *
¬g
;

523 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

525 ià(
s
->
¬gs
.
ÃÉs
 != 1) {

526 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

527 
s
->
¡©e
 = 0;

528  
NGX_OK
;

531 
¬g
 = 
s
->
¬gs
.
–ts
;

533 
s
->
sm_h–o
.
Ën
 = 
¬g
[0].len;

535 
s
->
sm_h–o
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
¬g
[0].
Ën
);

536 ià(
s
->
sm_h–o
.
d©a
 =ğ
NULL
) {

537  
NGX_ERROR
;

540 
	`ngx_memıy
(
s
->
sm_h–o
.
d©a
, 
¬g
[0].d©a,‡rg[0].
Ën
);

542 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

543 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

545 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

547 ià(
s
->
commªd
 =ğ
NGX_SMTP_HELO
) {

548 
s
->
out
 = 
sscf
->
£rv”_Çme
;

551 
s
->
esm
 = 1;

553 #ià(
NGX_MAIL_SSL
)

555 ià(
c
->
s¦
 =ğ
NULL
) {

556 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

558 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

560 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ON
) {

561 
s
->
out
 = 
sscf
->
¡¬‰ls_ÿ·b™y
;

562  
NGX_OK
;

565 ià(
s¦cf
->
¡¬‰ls
 =ğ
NGX_MAIL_STARTTLS_ONLY
) {

566 
s
->
out
 = 
sscf
->
¡¬‰ls_Úly_ÿ·b™y
;

567  
NGX_OK
;

572 
s
->
out
 = 
sscf
->
ÿ·b™y
;

575  
NGX_OK
;

576 
	}
}

579 
ngx_št_t


580 
	$ngx_ma_sm_auth
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

582 
ngx_št_t
 
rc
;

583 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

584 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

586 #ià(
NGX_MAIL_SSL
)

587 ià(
	`ngx_ma_¡¬‰ls_Úly
(
s
, 
c
)) {

588  
NGX_MAIL_PARSE_INVALID_COMMAND
;

592 ià(
s
->
¬gs
.
ÃÉs
 == 0) {

593 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_šv®id_¬gum’t
);

594 
s
->
¡©e
 = 0;

595  
NGX_OK
;

598 
rc
 = 
	`ngx_ma_auth_·r£
(
s
, 
c
);

600 
rc
) {

602 
NGX_MAIL_AUTH_LOGIN
:

604 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_u£ºame
);

605 
s
->
ma_¡©e
 = 
ngx_sm_auth_logš_u£ºame
;

607  
NGX_OK
;

609 
NGX_MAIL_AUTH_LOGIN_USERNAME
:

611 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_·sswÜd
);

612 
s
->
ma_¡©e
 = 
ngx_sm_auth_logš_·sswÜd
;

614  
	`ngx_ma_auth_logš_u£ºame
(
s
, 
c
, 1);

616 
NGX_MAIL_AUTH_PLAIN
:

618 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_Ãxt
);

619 
s
->
ma_¡©e
 = 
ngx_sm_auth_¶aš
;

621  
NGX_OK
;

623 
NGX_MAIL_AUTH_CRAM_MD5
:

625 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

627 ià(!(
sscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
)) {

628  
NGX_MAIL_PARSE_INVALID_COMMAND
;

631 ià(
s
->
§É
.
d©a
 =ğ
NULL
) {

632 
cscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_cÜe_moduË
);

634 ià(
	`ngx_ma_§É
(
s
, 
c
, 
cscf
è!ğ
NGX_OK
) {

635  
NGX_ERROR
;

639 ià(
	`ngx_ma_auth_üam_md5_§É
(
s
, 
c
, "334 ", 4è=ğ
NGX_OK
) {

640 
s
->
ma_¡©e
 = 
ngx_sm_auth_üam_md5
;

641  
NGX_OK
;

644  
NGX_ERROR
;

647  
rc
;

648 
	}
}

651 
ngx_št_t


652 
	$ngx_ma_sm_ma
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

654 
u_ch¬
 
ch
;

655 
ngx_¡r_t
 
l
;

656 
ngx_ušt_t
 
i
;

657 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

659 
sscf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_sm_moduË
);

661 ià(!(
sscf
->
auth_m‘hods
 & 
NGX_MAIL_AUTH_NONE_ENABLED
)) {

662 
	`ngx_ma_sm_log_»jeùed_commªd
(
s
, 
c
, "client was„ejected: \"%V\"");

663 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_auth_»quœed
);

664  
NGX_OK
;

669 ià(
s
->
sm_äom
.
Ën
) {

670 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bad_£qu’û
);

671  
NGX_OK
;

674 
l
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

675 
l
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

677 
i
 = 0; i < 
l
.
Ën
; i++) {

678 
ch
 = 
l
.
d©a
[
i
];

680 ià(
ch
 !ğ
CR
 && ch !ğ
LF
) {

684 
l
.
d©a
[
i
] = ' ';

687 
i
) {

688 ià(
l
.
d©a
[
i
 - 1] != ' ') {

692 
i
--;

695 
l
.
Ën
 = 
i
;

697 
s
->
sm_äom
.
Ën
 = 
l
.len;

699 
s
->
sm_äom
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
l
.
Ën
);

700 ià(
s
->
sm_äom
.
d©a
 =ğ
NULL
) {

701  
NGX_ERROR
;

704 
	`ngx_memıy
(
s
->
sm_äom
.
d©a
, 
l
.d©a,†.
Ën
);

706 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

707 "sm ma from:\"%V\"", &
s
->
sm_äom
);

709 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

711  
NGX_OK
;

712 
	}
}

715 
ngx_št_t


716 
	$ngx_ma_sm_rıt
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

718 
u_ch¬
 
ch
;

719 
ngx_¡r_t
 
l
;

720 
ngx_ušt_t
 
i
;

722 ià(
s
->
sm_äom
.
Ën
 == 0) {

723 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_bad_£qu’û
);

724  
NGX_OK
;

727 
l
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

728 
l
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

730 
i
 = 0; i < 
l
.
Ën
; i++) {

731 
ch
 = 
l
.
d©a
[
i
];

733 ià(
ch
 !ğ
CR
 && ch !ğ
LF
) {

737 
l
.
d©a
[
i
] = ' ';

740 
i
) {

741 ià(
l
.
d©a
[
i
 - 1] != ' ') {

745 
i
--;

748 
l
.
Ën
 = 
i
;

750 
s
->
sm_to
.
Ën
 = 
l
.len;

752 
s
->
sm_to
.
d©a
 = 
	`ngx_²®loc
(
c
->
poŞ
, 
l
.
Ën
);

753 ià(
s
->
sm_to
.
d©a
 =ğ
NULL
) {

754  
NGX_ERROR
;

757 
	`ngx_memıy
(
s
->
sm_to
.
d©a
, 
l
.d©a,†.
Ën
);

759 
	`ngx_log_debug1
(
NGX_LOG_DEBUG_MAIL
, 
c
->
log
, 0,

760 "sm„ıˆto:\"%V\"", &
s
->
sm_to
);

762 
s
->
auth_m‘hod
 = 
NGX_MAIL_AUTH_NONE
;

764  
NGX_DONE
;

765 
	}
}

768 
ngx_št_t


769 
	$ngx_ma_sm_r£t
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

771 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

772 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

773 
	`ngx_¡r_£t
(&
s
->
out
, 
sm_ok
);

775  
NGX_OK
;

776 
	}
}

779 
ngx_št_t


780 
	$ngx_ma_sm_¡¬‰ls
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
)

782 #ià(
NGX_MAIL_SSL
)

783 
ngx_ma_s¦_cÚf_t
 *
s¦cf
;

785 ià(
c
->
s¦
 =ğ
NULL
) {

786 
s¦cf
 = 
	`ngx_ma_g‘_moduË_¤v_cÚf
(
s
, 
ngx_ma_s¦_moduË
);

787 ià(
s¦cf
->
¡¬‰ls
) {

794 
	`ngx_¡r_nuÎ
(&
s
->
sm_h–o
);

795 
	`ngx_¡r_nuÎ
(&
s
->
sm_äom
);

796 
	`ngx_¡r_nuÎ
(&
s
->
sm_to
);

798 
c
->
»ad
->
hªdËr
 = 
ngx_ma_¡¬‰ls_hªdËr
;

799  
NGX_OK
;

805  
NGX_MAIL_PARSE_INVALID_COMMAND
;

806 
	}
}

809 
ngx_št_t


810 
	$ngx_ma_sm_disÿrd_commªd
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

811 *
”r
)

813 
ssize_t
 
n
;

815 
n
 = 
c
->
	`»cv
(c, 
s
->
bufãr
->
Ï¡
, s->bufãr->
’d
 - s->buffer->last);

817 ià(
n
 =ğ
NGX_ERROR
 ||‚ == 0) {

818 
	`ngx_ma_şo£_cÚÃùiÚ
(
c
);

819  
NGX_ERROR
;

822 ià(
n
 > 0) {

823 
s
->
bufãr
->
Ï¡
 +ğ
n
;

826 ià(
n
 =ğ
NGX_AGAIN
) {

827 ià(
	`ngx_hªdË_»ad_ev’t
(
c
->
»ad
, 0è!ğ
NGX_OK
) {

828 
	`ngx_ma_£ssiÚ_š‹º®_£rv”_”rÜ
(
s
);

829  
NGX_ERROR
;

832  
NGX_AGAIN
;

835 
	`ngx_ma_sm_log_»jeùed_commªd
(
s
, 
c
, 
”r
);

837 
s
->
bufãr
->
pos
 = s->bufãr->
¡¬t
;

838 
s
->
bufãr
->
Ï¡
 = s->bufãr->
¡¬t
;

840  
NGX_OK
;

841 
	}
}

845 
	$ngx_ma_sm_log_»jeùed_commªd
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
,

846 *
”r
)

848 
u_ch¬
 
ch
;

849 
ngx_¡r_t
 
cmd
;

850 
ngx_ušt_t
 
i
;

852 ià(
c
->
log
->
log_Ëv–
 < 
NGX_LOG_INFO
) {

856 
cmd
.
Ën
 = 
s
->
bufãr
->
Ï¡
 - s->bufãr->
¡¬t
;

857 
cmd
.
d©a
 = 
s
->
bufãr
->
¡¬t
;

859 
i
 = 0; i < 
cmd
.
Ën
; i++) {

860 
ch
 = 
cmd
.
d©a
[
i
];

862 ià(
ch
 !ğ
CR
 && ch !ğ
LF
) {

866 
cmd
.
d©a
[
i
] = '_';

869 
cmd
.
Ën
 = 
i
;

871 
	`ngx_log_”rÜ
(
NGX_LOG_INFO
, 
c
->
log
, 0, 
”r
, &
cmd
);

872 
	}
}

	@ngx_mail_smtp_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ev’t.h
>

11 
	~<ngx_ma.h
>

12 
	~<ngx_ma_sm_moduË.h
>

15 *
ngx_ma_sm_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
);

16 *
ngx_ma_sm_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
,

17 *
chd
);

20 
ngx_cÚf_b™mask_t
 
	gngx_ma_sm_auth_m‘hods
[] = {

21 { 
ngx_¡ršg
("¶aš"), 
NGX_MAIL_AUTH_PLAIN_ENABLED
 },

22 { 
ngx_¡ršg
("logš"), 
NGX_MAIL_AUTH_LOGIN_ENABLED
 },

23 { 
ngx_¡ršg
("üam-md5"), 
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
 },

24 { 
ngx_¡ršg
("nÚe"), 
NGX_MAIL_AUTH_NONE_ENABLED
 },

25 { 
ngx_nuÎ_¡ršg
, 0 }

29 
ngx_¡r_t
 
	gngx_ma_sm_auth_m‘hods_Çmes
[] = {

30 
ngx_¡ršg
("PLAIN"),

31 
ngx_¡ršg
("LOGIN"),

32 
ngx_nuÎ_¡ršg
,

33 
ngx_¡ršg
("CRAM-MD5"),

34 
ngx_nuÎ_¡ršg


38 
ngx_ma_´ÙocŞ_t
 
	gngx_ma_sm_´ÙocŞ
 = {

39 
ngx_¡ršg
("smtp"),

41 
NGX_MAIL_SMTP_PROTOCOL
,

43 
ngx_ma_sm_š™_£ssiÚ
,

44 
ngx_ma_sm_š™_´ÙocŞ
,

45 
ngx_ma_sm_·r£_commªd
,

46 
ngx_ma_sm_auth_¡©e
,

48 
ngx_¡ršg
("451 4.3.2 IÁ”ÇÈ£rv”ƒ¼Ü" 
CRLF
)

52 
ngx_commªd_t
 
	gngx_ma_sm_commªds
[] = {

54 { 
ngx_¡ršg
("smtp_client_buffer"),

55 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

56 
ngx_cÚf_£t_size_¦Ù
,

57 
NGX_MAIL_SRV_CONF_OFFSET
,

58 
off£tof
(
ngx_ma_sm_¤v_cÚf_t
, 
ş›Á_bufãr_size
),

59 
NULL
 },

61 { 
ngx_¡ršg
("smtp_greeting_delay"),

62 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

63 
ngx_cÚf_£t_m£c_¦Ù
,

64 
NGX_MAIL_SRV_CONF_OFFSET
,

65 
off£tof
(
ngx_ma_sm_¤v_cÚf_t
, 
g»‘šg_d–ay
),

66 
NULL
 },

68 { 
ngx_¡ršg
("smtp_capabilities"),

69 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

70 
ngx_ma_ÿ·b™›s
,

71 
NGX_MAIL_SRV_CONF_OFFSET
,

72 
off£tof
(
ngx_ma_sm_¤v_cÚf_t
, 
ÿ·b™›s
),

73 
NULL
 },

75 { 
ngx_¡ršg
("smtp_auth"),

76 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

77 
ngx_cÚf_£t_b™mask_¦Ù
,

78 
NGX_MAIL_SRV_CONF_OFFSET
,

79 
off£tof
(
ngx_ma_sm_¤v_cÚf_t
, 
auth_m‘hods
),

80 &
ngx_ma_sm_auth_m‘hods
 },

82 
ngx_nuÎ_commªd


86 
ngx_ma_moduË_t
 
	gngx_ma_sm_moduË_ùx
 = {

87 &
ngx_ma_sm_´ÙocŞ
,

89 
NULL
,

90 
NULL
,

92 
ngx_ma_sm_ü—‹_¤v_cÚf
,

93 
ngx_ma_sm_m”ge_¤v_cÚf


97 
ngx_moduË_t
 
	gngx_ma_sm_moduË
 = {

98 
NGX_MODULE_V1
,

99 &
ngx_ma_sm_moduË_ùx
,

100 
ngx_ma_sm_commªds
,

101 
NGX_MAIL_MODULE
,

102 
NULL
,

103 
NULL
,

104 
NULL
,

105 
NULL
,

106 
NULL
,

107 
NULL
,

108 
NULL
,

109 
NGX_MODULE_V1_PADDING


114 
	$ngx_ma_sm_ü—‹_¤v_cÚf
(
ngx_cÚf_t
 *
cf
)

116 
ngx_ma_sm_¤v_cÚf_t
 *
sscf
;

118 
sscf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_sm_¤v_cÚf_t
));

119 ià(
sscf
 =ğ
NULL
) {

120  
NULL
;

123 
sscf
->
ş›Á_bufãr_size
 = 
NGX_CONF_UNSET_SIZE
;

124 
sscf
->
g»‘šg_d–ay
 = 
NGX_CONF_UNSET_MSEC
;

126 ià(
	`ngx_¬¿y_š™
(&
sscf
->
ÿ·b™›s
, 
cf
->
poŞ
, 4, (
ngx_¡r_t
))

127 !ğ
NGX_OK
)

129  
NULL
;

132  
sscf
;

133 
	}
}

137 
	$ngx_ma_sm_m”ge_¤v_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

139 
ngx_ma_sm_¤v_cÚf_t
 *
´ev
 = 
·»Á
;

140 
ngx_ma_sm_¤v_cÚf_t
 *
cÚf
 = 
chd
;

142 
u_ch¬
 *
p
, *
auth
, *
Ï¡
;

143 
size_t
 
size
;

144 
ngx_¡r_t
 *
c
;

145 
ngx_ušt_t
 
i
, 
m
, 
auth_’abËd
;

146 
ngx_ma_cÜe_¤v_cÚf_t
 *
cscf
;

148 
	`ngx_cÚf_m”ge_size_v®ue
(
cÚf
->
ş›Á_bufãr_size
,

149 
´ev
->
ş›Á_bufãr_size
,

150 (
size_t
è
ngx_·gesize
);

152 
	`ngx_cÚf_m”ge_m£c_v®ue
(
cÚf
->
g»‘šg_d–ay
,

153 
´ev
->
g»‘šg_d–ay
, 0);

155 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
auth_m‘hods
,

156 
´ev
->
auth_m‘hods
,

157 (
NGX_CONF_BITMASK_SET


158 |
NGX_MAIL_AUTH_PLAIN_ENABLED


159 |
NGX_MAIL_AUTH_LOGIN_ENABLED
));

162 
cscf
 = 
	`ngx_ma_cÚf_g‘_moduË_¤v_cÚf
(
cf
, 
ngx_ma_cÜe_moduË
);

164 
size
 = ("220 ESMTP„—dy" 
CRLF
è- 1 + 
cscf
->
£rv”_Çme
.
Ën
;

166 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

167 ià(
p
 =ğ
NULL
) {

168  
NGX_CONF_ERROR
;

171 
cÚf
->
g»‘šg
.
Ën
 = 
size
;

172 
cÚf
->
g»‘šg
.
d©a
 = 
p
;

174 *
p
++ = '2'; *p++ = '2'; *p++ = '0'; *p++ = ' ';

175 
p
 = 
	`ngx_ıymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

176 
	`ngx_memıy
(
p
, " ESMTP„—dy" 
CRLF
, (" ESMTP„eady" CRLF) - 1);

179 
size
 = ("250 " 
CRLF
è- 1 + 
cscf
->
£rv”_Çme
.
Ën
;

181 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

182 ià(
p
 =ğ
NULL
) {

183  
NGX_CONF_ERROR
;

186 
cÚf
->
£rv”_Çme
.
Ën
 = 
size
;

187 
cÚf
->
£rv”_Çme
.
d©a
 = 
p
;

189 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = ' ';

190 
p
 = 
	`ngx_ıymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

191 *
p
++ = 
CR
; *°ğ
LF
;

194 ià(
cÚf
->
ÿ·b™›s
.
ÃÉs
 == 0) {

195 
cÚf
->
ÿ·b™›s
 = 
´ev
->capabilities;

198 
size
 = ("250-"è- 1 + 
cscf
->
£rv”_Çme
.
Ën
 + (
CRLF
) - 1;

200 
c
 = 
cÚf
->
ÿ·b™›s
.
–ts
;

201 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

202 
size
 +ğ("250 "è- 1 + 
c
[
i
].
Ën
 + (
CRLF
) - 1;

205 
auth_’abËd
 = 0;

207 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

208 
m
 <ğ
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

209 
m
 <<ğ1, 
i
++)

211 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

212 
size
 +ğ1 + 
ngx_ma_sm_auth_m‘hods_Çmes
[
i
].
Ën
;

213 
auth_’abËd
 = 1;

217 ià(
auth_’abËd
) {

218 
size
 +ğ("250 AUTH"è- 1 + (
CRLF
) - 1;

221 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

222 ià(
p
 =ğ
NULL
) {

223  
NGX_CONF_ERROR
;

226 
cÚf
->
ÿ·b™y
.
Ën
 = 
size
;

227 
cÚf
->
ÿ·b™y
.
d©a
 = 
p
;

229 
Ï¡
 = 
p
;

231 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = '-';

232 
p
 = 
	`ngx_ıymem
Õ, 
cscf
->
£rv”_Çme
.
d©a
, cscf->£rv”_Çme.
Ën
);

233 *
p
++ = 
CR
; *p++ = 
LF
;

235 
i
 = 0; i < 
cÚf
->
ÿ·b™›s
.
ÃÉs
; i++) {

236 
Ï¡
 = 
p
;

237 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = '-';

238 
p
 = 
	`ngx_ıymem
Õ, 
c
[
i
].
d©a
, c[i].
Ën
);

239 *
p
++ = 
CR
; *p++ = 
LF
;

242 
auth
 = 
p
;

244 ià(
auth_’abËd
) {

245 
Ï¡
 = 
p
;

247 *
p
++ = '2'; *p++ = '5'; *p++ = '0'; *p++ = ' ';

248 *
p
++ = 'A'; *p++ = 'U'; *p++ = 'T'; *p++ = 'H';

250 
m
 = 
NGX_MAIL_AUTH_PLAIN_ENABLED
, 
i
 = 0;

251 
m
 <ğ
NGX_MAIL_AUTH_CRAM_MD5_ENABLED
;

252 
m
 <<ğ1, 
i
++)

254 ià(
m
 & 
cÚf
->
auth_m‘hods
) {

255 *
p
++ = ' ';

256 
p
 = 
	`ngx_ıymem
Õ, 
ngx_ma_sm_auth_m‘hods_Çmes
[
i
].
d©a
,

257 
ngx_ma_sm_auth_m‘hods_Çmes
[
i
].
Ën
);

261 *
p
++ = 
CR
; *°ğ
LF
;

264 
Ï¡
[3] = ' ';

267 
size
 +ğ("250 STARTTLS" 
CRLF
) - 1;

269 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

270 ià(
p
 =ğ
NULL
) {

271  
NGX_CONF_ERROR
;

274 
cÚf
->
¡¬‰ls_ÿ·b™y
.
Ën
 = 
size
;

275 
cÚf
->
¡¬‰ls_ÿ·b™y
.
d©a
 = 
p
;

277 
p
 = 
	`ngx_ıymem
Õ, 
cÚf
->
ÿ·b™y
.
d©a
, cÚf->ÿ·b™y.
Ën
);

279 
p
 = 
	`ngx_ıymem
Õ, "250 STARTTLS" 
CRLF
, ("250 STARTTLS" CRLF) - 1);

280 *
p
++ = 
CR
; *°ğ
LF
;

282 
p
 = 
cÚf
->
¡¬‰ls_ÿ·b™y
.
d©a


283 + (
Ï¡
 - 
cÚf
->
ÿ·b™y
.
d©a
) + 3;

284 *
p
 = '-';

286 
size
 = (
auth
 - 
cÚf
->
ÿ·b™y
.
d©a
)

287 + ("250 STARTTLS" 
CRLF
) - 1;

289 
p
 = 
	`ngx_²®loc
(
cf
->
poŞ
, 
size
);

290 ià(
p
 =ğ
NULL
) {

291  
NGX_CONF_ERROR
;

294 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
Ën
 = 
size
;

295 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
d©a
 = 
p
;

297 
p
 = 
	`ngx_ıymem
Õ, 
cÚf
->
ÿ·b™y
.
d©a
, 
auth
 - conf->capability.data);

299 
	`ngx_memıy
(
p
, "250 STARTTLS" 
CRLF
, ("250 STARTTLS" CRLF) - 1);

301 ià(
Ï¡
 < 
auth
) {

302 
p
 = 
cÚf
->
¡¬‰ls_Úly_ÿ·b™y
.
d©a


303 + (
Ï¡
 - 
cÚf
->
ÿ·b™y
.
d©a
) + 3;

304 *
p
 = '-';

307  
NGX_CONF_OK
;

308 
	}
}

	@ngx_mail_smtp_module.h

8 #iâdeà
_NGX_MAIL_SMTP_MODULE_H_INCLUDED_


9 
	#_NGX_MAIL_SMTP_MODULE_H_INCLUDED_


	)

12 
	~<ngx_cÚfig.h
>

13 
	~<ngx_cÜe.h
>

14 
	~<ngx_ma.h
>

15 
	~<ngx_ma_sm_moduË.h
>

19 
ngx_m£c_t
 
	mg»‘šg_d–ay
;

21 
size_t
 
	mş›Á_bufãr_size
;

23 
ngx_¡r_t
 
	mÿ·b™y
;

24 
ngx_¡r_t
 
	m¡¬‰ls_ÿ·b™y
;

25 
ngx_¡r_t
 
	m¡¬‰ls_Úly_ÿ·b™y
;

27 
ngx_¡r_t
 
	m£rv”_Çme
;

28 
ngx_¡r_t
 
	mg»‘šg
;

30 
ngx_ušt_t
 
	mauth_m‘hods
;

32 
ngx_¬¿y_t
 
	mÿ·b™›s
;

33 } 
	tngx_ma_sm_¤v_cÚf_t
;

36 
ngx_ma_sm_š™_£ssiÚ
(
ngx_ma_£ssiÚ_t
 *
s
, 
ngx_cÚÃùiÚ_t
 *
c
);

37 
ngx_ma_sm_š™_´ÙocŞ
(
ngx_ev’t_t
 *
»v
);

38 
ngx_ma_sm_auth_¡©e
(
ngx_ev’t_t
 *
»v
);

39 
ngx_št_t
 
ngx_ma_sm_·r£_commªd
(
ngx_ma_£ssiÚ_t
 *
s
);

42 
ngx_moduË_t
 
ngx_ma_sm_moduË
;

	@ngx_mail_ssl_module.c

8 
	~<ngx_cÚfig.h
>

9 
	~<ngx_cÜe.h
>

10 
	~<ngx_ma.h
>

13 
	#NGX_DEFAULT_CIPHERS
 "HIGH:!aNULL:!MD5"

	)

14 
	#NGX_DEFAULT_ECDH_CURVE
 "´ime256v1"

	)

17 *
ngx_ma_s¦_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
);

18 *
ngx_ma_s¦_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
);

20 *
ngx_ma_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

21 *
cÚf
);

22 *
ngx_ma_s¦_¡¬‰ls
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

23 *
cÚf
);

24 *
ngx_ma_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
,

25 *
cÚf
);

28 
ngx_cÚf_’um_t
 
	gngx_h‰p_¡¬‰ls_¡©e
[] = {

29 { 
ngx_¡ršg
("off"), 
NGX_MAIL_STARTTLS_OFF
 },

30 { 
ngx_¡ršg
("Ú"), 
NGX_MAIL_STARTTLS_ON
 },

31 { 
ngx_¡ršg
("Úly"), 
NGX_MAIL_STARTTLS_ONLY
 },

32 { 
ngx_nuÎ_¡ršg
, 0 }

37 
ngx_cÚf_b™mask_t
 
	gngx_ma_s¦_´ÙocŞs
[] = {

38 { 
ngx_¡ršg
("SSLv2"), 
NGX_SSL_SSLv2
 },

39 { 
ngx_¡ršg
("SSLv3"), 
NGX_SSL_SSLv3
 },

40 { 
ngx_¡ršg
("TLSv1"), 
NGX_SSL_TLSv1
 },

41 { 
ngx_¡ršg
("TLSv1.1"), 
NGX_SSL_TLSv1_1
 },

42 { 
ngx_¡ršg
("TLSv1.2"), 
NGX_SSL_TLSv1_2
 },

43 { 
ngx_nuÎ_¡ršg
, 0 }

47 
ngx_commªd_t
 
	gngx_ma_s¦_commªds
[] = {

49 { 
ngx_¡ršg
("ssl"),

50 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

51 
ngx_ma_s¦_’abË
,

52 
NGX_MAIL_SRV_CONF_OFFSET
,

53 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
’abË
),

54 
NULL
 },

56 { 
ngx_¡ršg
("starttls"),

57 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

58 
ngx_ma_s¦_¡¬‰ls
,

59 
NGX_MAIL_SRV_CONF_OFFSET
,

60 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
¡¬‰ls
),

61 
ngx_h‰p_¡¬‰ls_¡©e
 },

63 { 
ngx_¡ršg
("ssl_certificate"),

64 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

65 
ngx_cÚf_£t_¡r_¦Ù
,

66 
NGX_MAIL_SRV_CONF_OFFSET
,

67 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
û¹ifiÿ‹
),

68 
NULL
 },

70 { 
ngx_¡ršg
("ssl_certificate_key"),

71 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

72 
ngx_cÚf_£t_¡r_¦Ù
,

73 
NGX_MAIL_SRV_CONF_OFFSET
,

74 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
û¹ifiÿ‹_key
),

75 
NULL
 },

77 { 
ngx_¡ršg
("ssl_dhparam"),

78 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

79 
ngx_cÚf_£t_¡r_¦Ù
,

80 
NGX_MAIL_SRV_CONF_OFFSET
,

81 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
dh·¿m
),

82 
NULL
 },

84 { 
ngx_¡ršg
("ssl_ecdh_curve"),

85 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

86 
ngx_cÚf_£t_¡r_¦Ù
,

87 
NGX_MAIL_SRV_CONF_OFFSET
,

88 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
ecdh_curve
),

89 
NULL
 },

91 { 
ngx_¡ršg
("ssl_protocols"),

92 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_1MORE
,

93 
ngx_cÚf_£t_b™mask_¦Ù
,

94 
NGX_MAIL_SRV_CONF_OFFSET
,

95 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
´ÙocŞs
),

96 &
ngx_ma_s¦_´ÙocŞs
 },

98 { 
ngx_¡ršg
("ssl_ciphers"),

99 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

100 
ngx_cÚf_£t_¡r_¦Ù
,

101 
NGX_MAIL_SRV_CONF_OFFSET
,

102 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
ch”s
),

103 
NULL
 },

105 { 
ngx_¡ršg
("ssl_prefer_server_ciphers"),

106 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_FLAG
,

107 
ngx_cÚf_£t_æag_¦Ù
,

108 
NGX_MAIL_SRV_CONF_OFFSET
,

109 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
´eãr_£rv”_ch”s
),

110 
NULL
 },

112 { 
ngx_¡ršg
("ssl_session_cache"),

113 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE12
,

114 
ngx_ma_s¦_£ssiÚ_ÿche
,

115 
NGX_MAIL_SRV_CONF_OFFSET
,

117 
NULL
 },

119 { 
ngx_¡ršg
("ssl_session_timeout"),

120 
NGX_MAIL_MAIN_CONF
|
NGX_MAIL_SRV_CONF
|
NGX_CONF_TAKE1
,

121 
ngx_cÚf_£t_£c_¦Ù
,

122 
NGX_MAIL_SRV_CONF_OFFSET
,

123 
off£tof
(
ngx_ma_s¦_cÚf_t
, 
£ssiÚ_timeout
),

124 
NULL
 },

126 
ngx_nuÎ_commªd


130 
ngx_ma_moduË_t
 
	gngx_ma_s¦_moduË_ùx
 = {

131 
NULL
,

133 
NULL
,

134 
NULL
,

136 
ngx_ma_s¦_ü—‹_cÚf
,

137 
ngx_ma_s¦_m”ge_cÚf


141 
ngx_moduË_t
 
	gngx_ma_s¦_moduË
 = {

142 
NGX_MODULE_V1
,

143 &
ngx_ma_s¦_moduË_ùx
,

144 
ngx_ma_s¦_commªds
,

145 
NGX_MAIL_MODULE
,

146 
NULL
,

147 
NULL
,

148 
NULL
,

149 
NULL
,

150 
NULL
,

151 
NULL
,

152 
NULL
,

153 
NGX_MODULE_V1_PADDING


157 
ngx_¡r_t
 
	gngx_ma_s¦_£ss_id_ùx
 = 
ngx_¡ršg
("MAIL");

161 
	$ngx_ma_s¦_ü—‹_cÚf
(
ngx_cÚf_t
 *
cf
)

163 
ngx_ma_s¦_cÚf_t
 *
scf
;

165 
scf
 = 
	`ngx_pÿÎoc
(
cf
->
poŞ
, (
ngx_ma_s¦_cÚf_t
));

166 ià(
scf
 =ğ
NULL
) {

167  
NULL
;

182 
scf
->
’abË
 = 
NGX_CONF_UNSET
;

183 
scf
->
¡¬‰ls
 = 
NGX_CONF_UNSET_UINT
;

184 
scf
->
´eãr_£rv”_ch”s
 = 
NGX_CONF_UNSET
;

185 
scf
->
butš_£ssiÚ_ÿche
 = 
NGX_CONF_UNSET
;

186 
scf
->
£ssiÚ_timeout
 = 
NGX_CONF_UNSET
;

188  
scf
;

189 
	}
}

193 
	$ngx_ma_s¦_m”ge_cÚf
(
ngx_cÚf_t
 *
cf
, *
·»Á
, *
chd
)

195 
ngx_ma_s¦_cÚf_t
 *
´ev
 = 
·»Á
;

196 
ngx_ma_s¦_cÚf_t
 *
cÚf
 = 
chd
;

198 *
mode
;

199 
ngx_poŞ_ş—nup_t
 *
şn
;

201 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
’abË
, 
´ev
->enable, 0);

202 
	`ngx_cÚf_m”ge_ušt_v®ue
(
cÚf
->
¡¬‰ls
, 
´ev
->starttls,

203 
NGX_MAIL_STARTTLS_OFF
);

205 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
£ssiÚ_timeout
,

206 
´ev
->
£ssiÚ_timeout
, 300);

208 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
´eãr_£rv”_ch”s
,

209 
´ev
->
´eãr_£rv”_ch”s
, 0);

211 
	`ngx_cÚf_m”ge_b™mask_v®ue
(
cÚf
->
´ÙocŞs
, 
´ev
->protocols,

212 (
NGX_CONF_BITMASK_SET
|
NGX_SSL_SSLv3
|
NGX_SSL_TLSv1


213 |
NGX_SSL_TLSv1_1
|
NGX_SSL_TLSv1_2
));

215 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹
, 
´ev
->certificate, "");

216 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
û¹ifiÿ‹_key
, 
´ev
->certificate_key, "");

218 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
dh·¿m
, 
´ev
->dhparam, "");

220 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ecdh_curve
, 
´ev
->ecdh_curve,

221 
NGX_DEFAULT_ECDH_CURVE
);

223 
	`ngx_cÚf_m”ge_¡r_v®ue
(
cÚf
->
ch”s
, 
´ev
->ch”s, 
NGX_DEFAULT_CIPHERS
);

226 
cÚf
->
s¦
.
log
 = 
cf
->log;

228 ià(
cÚf
->
’abË
) {

229 
mode
 = "ssl";

231 } ià(
cÚf
->
¡¬‰ls
 !ğ
NGX_MAIL_STARTTLS_OFF
) {

232 
mode
 = "starttls";

235 
mode
 = "";

238 ià(*
mode
) {

240 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

241 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

244 
mode
, 
cÚf
->
fe
, cÚf->
lše
);

245  
NGX_CONF_ERROR
;

248 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

249 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

252 
mode
, 
cÚf
->
fe
, cÚf->
lše
);

253  
NGX_CONF_ERROR
;

258 ià(
cÚf
->
û¹ifiÿ‹
.
Ën
 == 0) {

259  
NGX_CONF_OK
;

262 ià(
cÚf
->
û¹ifiÿ‹_key
.
Ën
 == 0) {

263 
	`ngx_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

266 &
cÚf
->
û¹ifiÿ‹
);

267  
NGX_CONF_ERROR
;

271 ià(
	`ngx_s¦_ü—‹
(&
cÚf
->
s¦
, cÚf->
´ÙocŞs
, 
NULL
è!ğ
NGX_OK
) {

272  
NGX_CONF_ERROR
;

275 
şn
 = 
	`ngx_poŞ_ş—nup_add
(
cf
->
poŞ
, 0);

276 ià(
şn
 =ğ
NULL
) {

277  
NGX_CONF_ERROR
;

280 
şn
->
hªdËr
 = 
ngx_s¦_ş—nup_ùx
;

281 
şn
->
d©a
 = &
cÚf
->
s¦
;

283 ià(
	`ngx_s¦_û¹ifiÿ‹
(
cf
, &
cÚf
->
s¦
, &cÚf->
û¹ifiÿ‹
,

284 &
cÚf
->
û¹ifiÿ‹_key
)

285 !ğ
NGX_OK
)

287  
NGX_CONF_ERROR
;

290 ià(
cÚf
->
ch”s
.
Ën
) {

291 ià(
	`SSL_CTX_£t_ch”_li¡
(
cÚf
->
s¦
.
ùx
,

292 (cÚ¡ *è
cÚf
->
ch”s
.
d©a
)

295 
	`ngx_s¦_”rÜ
(
NGX_LOG_EMERG
, 
cf
->
log
, 0,

297 &
cÚf
->
ch”s
);

301 ià(
cÚf
->
´eãr_£rv”_ch”s
) {

302 
	`SSL_CTX_£t_İtiÚs
(
cÚf
->
s¦
.
ùx
, 
SSL_OP_CIPHER_SERVER_PREFERENCE
);

305 
	`SSL_CTX_£t_tmp_r§_ÿÎback
(
cÚf
->
s¦
.
ùx
, 
ngx_s¦_r§512_key_ÿÎback
);

307 ià(
	`ngx_s¦_dh·¿m
(
cf
, &
cÚf
->
s¦
, &cÚf->
dh·¿m
è!ğ
NGX_OK
) {

308  
NGX_CONF_ERROR
;

311 
	`ngx_cÚf_m”ge_v®ue
(
cÚf
->
butš_£ssiÚ_ÿche
,

312 
´ev
->
butš_£ssiÚ_ÿche
, 
NGX_SSL_NONE_SCACHE
);

314 ià(
cÚf
->
shm_zÚe
 =ğ
NULL
) {

315 
cÚf
->
shm_zÚe
 = 
´ev
->shm_zone;

318 ià(
	`ngx_s¦_£ssiÚ_ÿche
(&
cÚf
->
s¦
, &
ngx_ma_s¦_£ss_id_ùx
,

319 
cÚf
->
butš_£ssiÚ_ÿche
,

320 
cÚf
->
shm_zÚe
, cÚf->
£ssiÚ_timeout
)

321 !ğ
NGX_OK
)

323  
NGX_CONF_ERROR
;

326  
NGX_CONF_OK
;

327 
	}
}

331 
	$ngx_ma_s¦_’abË
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

333 
ngx_ma_s¦_cÚf_t
 *
scf
 = 
cÚf
;

335 *
rv
;

337 
rv
 = 
	`ngx_cÚf_£t_æag_¦Ù
(
cf
, 
cmd
, 
cÚf
);

339 ià(
rv
 !ğ
NGX_CONF_OK
) {

340  
rv
;

343 ià(
scf
->
’abË
 && (
ngx_št_t
èscf->
¡¬‰ls
 > 
NGX_MAIL_STARTTLS_OFF
) {

344 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

346  
NGX_CONF_ERROR
;

349 
scf
->
fe
 = 
cf
->
cÚf_fe
->fe.
Çme
.
d©a
;

350 
scf
->
lše
 = 
cf
->
cÚf_fe
->line;

352  
NGX_CONF_OK
;

353 
	}
}

357 
	$ngx_ma_s¦_¡¬‰ls
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

359 
ngx_ma_s¦_cÚf_t
 *
scf
 = 
cÚf
;

361 *
rv
;

363 
rv
 = 
	`ngx_cÚf_£t_’um_¦Ù
(
cf
, 
cmd
, 
cÚf
);

365 ià(
rv
 !ğ
NGX_CONF_OK
) {

366  
rv
;

369 ià(
scf
->
’abË
 =ğ1 && (
ngx_št_t
èscf->
¡¬‰ls
 > 
NGX_MAIL_STARTTLS_OFF
) {

370 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_WARN
, 
cf
, 0,

372  
NGX_CONF_ERROR
;

375 
scf
->
fe
 = 
cf
->
cÚf_fe
->fe.
Çme
.
d©a
;

376 
scf
->
lše
 = 
cf
->
cÚf_fe
->line;

378  
NGX_CONF_OK
;

379 
	}
}

383 
	$ngx_ma_s¦_£ssiÚ_ÿche
(
ngx_cÚf_t
 *
cf
, 
ngx_commªd_t
 *
cmd
, *
cÚf
)

385 
ngx_ma_s¦_cÚf_t
 *
scf
 = 
cÚf
;

387 
size_t
 
Ën
;

388 
ngx_¡r_t
 *
v®ue
, 
Çme
, 
size
;

389 
ngx_št_t
 
n
;

390 
ngx_ušt_t
 
i
, 
j
;

392 
v®ue
 = 
cf
->
¬gs
->
–ts
;

394 
i
 = 1; i < 
cf
->
¬gs
->
ÃÉs
; i++) {

396 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "off") == 0) {

397 
scf
->
butš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_SCACHE
;

401 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "none") == 0) {

402 
scf
->
butš_£ssiÚ_ÿche
 = 
NGX_SSL_NONE_SCACHE
;

406 ià(
	`ngx_¡rcmp
(
v®ue
[
i
].
d©a
, "builtin") == 0) {

407 
scf
->
butš_£ssiÚ_ÿche
 = 
NGX_SSL_DFLT_BUILTIN_SCACHE
;

411 ià(
v®ue
[
i
].
Ën
 > ("builtin:") - 1

412 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "builtin:", ("builtin:") - 1)

415 
n
 = 
	`ngx_©oi
(
v®ue
[
i
].
d©a
 + ("builtin:") - 1,

416 
v®ue
[
i
].
Ën
 - (("builtin:") - 1));

418 ià(
n
 =ğ
NGX_ERROR
) {

419 
šv®id
;

422 
scf
->
butš_£ssiÚ_ÿche
 = 
n
;

427 ià(
v®ue
[
i
].
Ën
 > ("shared:") - 1

428 && 
	`ngx_¡ºcmp
(
v®ue
[
i
].
d©a
, "shared:", ("shared:") - 1)

431 
Ën
 = 0;

433 
j
 = ("sh¬ed:"è- 1; j < 
v®ue
[
i
].
Ën
; j++) {

434 ià(
v®ue
[
i
].
d©a
[
j
] == ':') {

438 
Ën
++;

441 ià(
Ën
 == 0) {

442 
šv®id
;

445 
Çme
.
Ën
 =†en;

446 
Çme
.
d©a
 = 
v®ue
[
i
].data + ("shared:") - 1;

448 
size
.
Ën
 = 
v®ue
[
i
].ËÀ- 
j
 - 1;

449 
size
.
d©a
 = 
Çme
.d©¨+ 
Ën
 + 1;

451 
n
 = 
	`ngx_·r£_size
(&
size
);

453 ià(
n
 =ğ
NGX_ERROR
) {

454 
šv®id
;

457 ià(
n
 < (
ngx_št_t
è(8 * 
ngx_·gesize
)) {

458 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

460 &
v®ue
[
i
]);

462  
NGX_CONF_ERROR
;

465 
scf
->
shm_zÚe
 = 
	`ngx_sh¬ed_memÜy_add
(
cf
, &
Çme
, 
n
,

466 &
ngx_ma_s¦_moduË
);

467 ià(
scf
->
shm_zÚe
 =ğ
NULL
) {

468  
NGX_CONF_ERROR
;

471 
scf
->
shm_zÚe
->
š™
 = 
ngx_s¦_£ssiÚ_ÿche_š™
;

476 
šv®id
;

479 ià(
scf
->
shm_zÚe
 && scf->
butš_£ssiÚ_ÿche
 =ğ
NGX_CONF_UNSET
) {

480 
scf
->
butš_£ssiÚ_ÿche
 = 
NGX_SSL_NO_BUILTIN_SCACHE
;

483  
NGX_CONF_OK
;

485 
šv®id
:

487 
	`ngx_cÚf_log_”rÜ
(
NGX_LOG_EMERG
, 
cf
, 0,

488 "šv®id sessiÚ cach\"%V\"", &
v®ue
[
i
]);

490  
NGX_CONF_ERROR
;

491 
	}
}

	@ngx_mail_ssl_module.h

8 #iâdeà
_NGX_MAIL_SSL_H_INCLUDED_


9 
	#_NGX_MAIL_SSL_H_INCLUDED_


	)

12 
	~<ngx_cÚfig.h
>

13 
	~<ngx_cÜe.h
>

14 
	~<ngx_ma.h
>

17 
	#NGX_MAIL_STARTTLS_OFF
 0

	)

18 
	#NGX_MAIL_STARTTLS_ON
 1

	)

19 
	#NGX_MAIL_STARTTLS_ONLY
 2

	)

23 
ngx_æag_t
 
	m’abË
;

24 
ngx_æag_t
 
	m´eãr_£rv”_ch”s
;

26 
ngx_s¦_t
 
	ms¦
;

28 
ngx_ušt_t
 
	m¡¬‰ls
;

29 
ngx_ušt_t
 
	m´ÙocŞs
;

31 
ssize_t
 
	mbutš_£ssiÚ_ÿche
;

33 
time_t
 
	m£ssiÚ_timeout
;

35 
ngx_¡r_t
 
	mû¹ifiÿ‹
;

36 
ngx_¡r_t
 
	mû¹ifiÿ‹_key
;

37 
ngx_¡r_t
 
	mdh·¿m
;

38 
ngx_¡r_t
 
	mecdh_curve
;

40 
ngx_¡r_t
 
	mch”s
;

42 
ngx_shm_zÚe_t
 *
	mshm_zÚe
;

44 
u_ch¬
 *
	mfe
;

45 
ngx_ušt_t
 
	mlše
;

46 } 
	tngx_ma_s¦_cÚf_t
;

49 
ngx_moduË_t
 
ngx_ma_s¦_moduË
;

	@
1
.
1
/usr/include
18
387
ngx_mail.c
ngx_mail.h
ngx_mail_auth_http_module.c
ngx_mail_core_module.c
ngx_mail_handler.c
ngx_mail_imap_handler.c
ngx_mail_imap_module.c
ngx_mail_imap_module.h
ngx_mail_parse.c
ngx_mail_pop3_handler.c
ngx_mail_pop3_module.c
ngx_mail_pop3_module.h
ngx_mail_proxy_module.c
ngx_mail_smtp_handler.c
ngx_mail_smtp_module.c
ngx_mail_smtp_module.h
ngx_mail_ssl_module.c
ngx_mail_ssl_module.h
